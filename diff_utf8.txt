diff --git a/src/agents/agent-paths.test.ts b/src/agents/agent-paths.test.ts
index dd5603bed..bf5e7a361 100644
--- a/src/agents/agent-paths.test.ts
+++ b/src/agents/agent-paths.test.ts
@@ -4,34 +4,6 @@ import path from "node:path";
 import { afterEach, describe, expect, it } from "vitest";
 import { resolveTEXT2LLMAgentDir } from "./agent-paths.js";
 
-describe("resolveTEXT2LLMAgentDir", () => {
-  const previousStateDir = process.env.TEXT2LLM_STATE_DIR;
-  const previousAgentDir = process.env.TEXT2LLM_AGENT_DIR;
-  const previousPiAgentDir = process.env.PI_CODING_AGENT_DIR;
-  let tempStateDir: string | null = null;
-
-  afterEach(async () => {
-    if (tempStateDir) {
-      await fs.rm(tempStateDir, { recursive: true, force: true });
-      tempStateDir = null;
-    }
-    if (previousStateDir === undefined) {
-      delete process.env.TEXT2LLM_STATE_DIR;
-    } else {
-      process.env.TEXT2LLM_STATE_DIR = previousStateDir;
-    }
-    if (previousAgentDir === undefined) {
-      delete process.env.TEXT2LLM_AGENT_DIR;
-    } else {
-      process.env.TEXT2LLM_AGENT_DIR = previousAgentDir;
-    }
-    if (previousPiAgentDir === undefined) {
-      delete process.env.PIimport fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, describe, expect, it } from "vitest";
-import { resolveTEXT2LLMAgentDir } from "./agent-paths.js";
-
 describe("resolveTEXT2LLMAgentDir", () => {
   const previousStateDir = process.env.TEXT2LLM_STATE_DIR;
   const previousAgentDir = process.env.TEXT2LLM_AGENT_DIR;
diff --git a/src/agents/auth-profiles/display.ts b/src/agents/auth-profiles/display.ts
index 94c36b1fd..12dd58d80 100644
--- a/src/agents/auth-profiles/display.ts
+++ b/src/agents/auth-profiles/display.ts
@@ -15,20 +15,3 @@ export function resolveAuthProfileDisplayLabel(params: {
   }
   return profileId;
 }
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { AuthProfileStore } from "./types.js";
-
-export function resolveAuthProfileDisplayLabel(params: {
-  cfg?: TEXT2LLMConfig;
-  store: AuthProfileStore;
-  profileId: string;
-}): string {
-  const { cfg, store, profileId } = params;
-  const profile = store.profiles[profileId];
-  const configEmail = cfg?.auth?.profiles?.[profileId]?.email?.trim();
-  const email = configEmail || (profile && "email" in profile ? profile.email?.trim() : undefined);
-  if (email) {
-    return `${profileId} (${email})`;
-  }
-  return profileId;
-}
diff --git a/src/agents/auth-profiles/oauth.fallback-to-main-agent.test.ts b/src/agents/auth-profiles/oauth.fallback-to-main-agent.test.ts
index 9a8a4c523..8a5e57fb5 100644
--- a/src/agents/auth-profiles/oauth.fallback-to-main-agent.test.ts
+++ b/src/agents/auth-profiles/oauth.fallback-to-main-agent.test.ts
@@ -6,29 +6,6 @@ import type { AuthProfileStore } from "./types.js";
 import { resolveApiKeyForProfile } from "./oauth.js";
 import { ensureAuthProfileStore } from "./store.js";
 
-describe("resolveApiKeyForProfile fallback to main agent", () => {
-  const previousStateDir = process.env.TEXT2LLM_STATE_DIR;
-  const previousAgentDir = process.env.TEXT2LLM_AGENT_DIR;
-  const previousPiAgentDir = process.env.PI_CODING_AGENT_DIR;
-  let tmpDir: string;
-  let mainAgentDir: string;
-  let secondaryAgentDir: string;
-
-  beforeEach(async () => {
-    tmpDir = await fs.mkdtemp(path.join(os.tmpdir(), "oauth-fallback-test-"));
-    mainAgentDir = path.join(tmpDir, "agents", "main", "agent");
-    secondaryAgentDir = path.join(tmpDir, "agents", "kids", "agent");
-    await fs.mkdir(mainAgentDir, { recursive: true });
-    await fs.mkdir(secondaryAgentDir, { recursive: true });
-
-    // Set import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { AuthProfileStore } from "./types.js";
-import { resolveApiKeyForProfile } from "./oauth.js";
-import { ensureAuthProfileStore } from "./store.js";
-
 describe("resolveApiKeyForProfile fallback to main agent", () => {
   const previousStateDir = process.env.TEXT2LLM_STATE_DIR;
   const previousAgentDir = process.env.TEXT2LLM_AGENT_DIR;
diff --git a/src/agents/auth-profiles/oauth.ts b/src/agents/auth-profiles/oauth.ts
index 66f085a7d..fd2e5988c 100644
--- a/src/agents/auth-profiles/oauth.ts
+++ b/src/agents/auth-profiles/oauth.ts
@@ -5,7 +5,7 @@ import {
 } from "@mariozechner/pi-ai";
 import lockfile from "proper-lockfile";
 
-import type { ClawdbotConfig } from "../../config/config.js";
+import type { TEXT2LLMConfig } from "../../config/config.js";
 import { refreshChutesTokens } from "../chutes-oauth.js";
 import { writeClaudeCliCredentials } from "../cli-credentials.js";
 import { AUTH_STORE_LOCK_OPTIONS, CLAUDE_CLI_PROFILE_ID } from "./constants.js";
@@ -96,7 +96,7 @@ async function refreshOAuthTokenWithLock(params: {
 }
 
 async function tryResolveOAuthProfile(params: {
-  cfg?: ClawdbotConfig;
+  cfg?: TEXT2LLMConfig;
   store: AuthProfileStore;
   profileId: string;
   agentDir?: string;
@@ -129,7 +129,7 @@ async function tryResolveOAuthProfile(params: {
 }
 
 export async function resolveApiKeyForProfile(params: {
-  cfg?: ClawdbotConfig;
+  cfg?: TEXT2LLMConfig;
   store: AuthProfileStore;
   profileId: string;
   agentDir?: string;
@@ -145,7 +145,7 @@ export async function resolveApiKeyForProfile(params: {
   }
 
   if (cred.type === "api_key") {
-    return { apiKey: cred.key, provider: cred.provider, email: cred.email };
+    return { apiKey: cred.key ?? "", provider: cred.provider, email: cred.email };
   }
   if (cred.type === "token") {
     const token = cred.token?.trim();
diff --git a/src/agents/auth-profiles/session-override.ts b/src/agents/auth-profiles/session-override.ts
index 4eec769ba..4678cc605 100644
--- a/src/agents/auth-profiles/session-override.ts
+++ b/src/agents/auth-profiles/session-override.ts
@@ -19,36 +19,6 @@ function isProfileForProvider(params: {
   return normalizeProviderId(entry.provider) === normalizeProviderId(params.provider);
 }
 
-export async function clearSessionAuthProfileOverride(params: {
-  sessionEntry: SessionEntry;
-  sessionStore: Record<string, SessionEntry>;
-  sessionKey: string;
-  storePath?: string;
-}) {
-  const { sessionEntry, sessionStore, sessionKey, storePath } = params;
-  delete sessionEntry.authProfileOverride;
-  delete sessionEntry.authProfileOverrideSource;
-  deleteimport type { TEXT2LLMConfig } from "../../config/config.js";
-import { updateSessionStore, type SessionEntry } from "../../config/sessions.js";
-import {
-  ensureAuthProfileStore,
-  isProfileInCooldown,
-  resolveAuthProfileOrder,
-} from "../auth-profiles.js";
-import { normalizeProviderId } from "../model-selection.js";
-
-function isProfileForProvider(params: {
-  provider: string;
-  profileId: string;
-  store: ReturnType<typeof ensureAuthProfileStore>;
-}): boolean {
-  const entry = params.store.profiles[params.profileId];
-  if (!entry?.provider) {
-    return false;
-  }
-  return normalizeProviderId(entry.provider) === normalizeProviderId(params.provider);
-}
-
 export async function clearSessionAuthProfileOverride(params: {
   sessionEntry: SessionEntry;
   sessionStore: Record<string, SessionEntry>;
diff --git a/src/agents/bootstrap-files.ts b/src/agents/bootstrap-files.ts
index ed1f1cd7d..51edf9b8b 100644
--- a/src/agents/bootstrap-files.ts
+++ b/src/agents/bootstrap-files.ts
@@ -56,5 +56,28 @@ export async function resolveBootstrapContextForRun(params: {
     maxChars: resolveBootstrapMaxChars(params.config),
     warn: params.warn,
   });
+
+  const storeResources = params.config?.storeResourcesByProject?.["default"] || [];
+  if (storeResources.length > 0) {
+    const lines = [
+      "# Saved Store Resources",
+      "The following resources have been added to this workspace from the text2llm store:",
+      "",
+    ];
+    for (const res of storeResources) {
+      lines.push(`## ${res.name || res.id}`);
+      lines.push(`- **Type:** ${res.type}`);
+      lines.push(`- **Source:** ${res.source}`);
+      if (res.author) lines.push(`- **Author:** ${res.author}`);
+      if (res.url) lines.push(`- **URL:** ${res.url}`);
+      if (res.description) lines.push(`- **Description:** ${res.description}`);
+      lines.push("");
+    }
+    contextFiles.push({
+      path: "STORE_RESOURCES.md",
+      content: lines.join("\n"),
+    });
+  }
+
   return { bootstrapFiles, contextFiles };
 }
diff --git a/src/agents/cli-backends.ts b/src/agents/cli-backends.ts
index d953167df..a1f2a179a 100644
--- a/src/agents/cli-backends.ts
+++ b/src/agents/cli-backends.ts
@@ -27,44 +27,6 @@ const CLAUDE_MODEL_ALIASES: Record<string, string> = {
   "claude-haiku-3-5": "haiku",
 };
 
-const DEFAULT_CLAUDE_BACKEND: CliBackendConfig = {
-  command: "claude",
-  args: ["-p", "--output-format", "json", "--dangerously-skip-permissions"],
-  resumeArgs: [
-    "-p",
-    "--output-format",
-    "json",
-    "--dangerously-skip-permissions",
-    "--resume",
-    "import type { TEXT2LLMConfig } from "../config/config.js";
-import type { CliBackendConfig } from "../config/types.js";
-import { normalizeProviderId } from "./model-selection.js";
-
-export type ResolvedCliBackend = {
-  id: string;
-  config: CliBackendConfig;
-};
-
-const CLAUDE_MODEL_ALIASES: Record<string, string> = {
-  opus: "opus",
-  "opus-4.6": "opus",
-  "opus-4.5": "opus",
-  "opus-4": "opus",
-  "claude-opus-4-6": "opus",
-  "claude-opus-4-5": "opus",
-  "claude-opus-4": "opus",
-  sonnet: "sonnet",
-  "sonnet-4.5": "sonnet",
-  "sonnet-4.1": "sonnet",
-  "sonnet-4.0": "sonnet",
-  "claude-sonnet-4-5": "sonnet",
-  "claude-sonnet-4-1": "sonnet",
-  "claude-sonnet-4-0": "sonnet",
-  haiku: "haiku",
-  "haiku-3.5": "haiku",
-  "claude-haiku-3-5": "haiku",
-};
-
 const DEFAULT_CLAUDE_BACKEND: CliBackendConfig = {
   command: "claude",
   args: ["-p", "--output-format", "json", "--dangerously-skip-permissions"],
diff --git a/src/agents/docs-path.ts b/src/agents/docs-path.ts
index 8adc86d0c..8c39a7c34 100644
--- a/src/agents/docs-path.ts
+++ b/src/agents/docs-path.ts
@@ -28,33 +28,3 @@ export async function resolveTEXT2LLMDocsPath(params: {
   const packageDocs = path.join(packageRoot, "docs");
   return fs.existsSync(packageDocs) ? packageDocs : null;
 }
-import fs from "node:fs";
-import path from "node:path";
-import { resolveTEXT2LLMPackageRoot } from "../infra/text2llm-root.js";
-
-export async function resolveTEXT2LLMDocsPath(params: {
-  workspaceDir?: string;
-  argv1?: string;
-  cwd?: string;
-  moduleUrl?: string;
-}): Promise<string | null> {
-  const workspaceDir = params.workspaceDir?.trim();
-  if (workspaceDir) {
-    const workspaceDocs = path.join(workspaceDir, "docs");
-    if (fs.existsSync(workspaceDocs)) {
-      return workspaceDocs;
-    }
-  }
-
-  const packageRoot = await resolveTEXT2LLMPackageRoot({
-    cwd: params.cwd,
-    argv1: params.argv1,
-    moduleUrl: params.moduleUrl,
-  });
-  if (!packageRoot) {
-    return null;
-  }
-
-  const packageDocs = path.join(packageRoot, "docs");
-  return fs.existsSync(packageDocs) ? packageDocs : null;
-}
diff --git a/src/agents/identity.per-channel-prefix.test.ts b/src/agents/identity.per-channel-prefix.test.ts
index 2b305e761..efad05e33 100644
--- a/src/agents/identity.per-channel-prefix.test.ts
+++ b/src/agents/identity.per-channel-prefix.test.ts
@@ -4,27 +4,6 @@ import { resolveResponsePrefix, resolveEffectiveMessagesConfig } from "./identit
 
 const makeConfig = <T extends TEXT2LLMConfig>(cfg: T) => cfg;
 
-describe("resolveResponsePrefix with per-channel override", () => {
-  // ΓöÇΓöÇΓöÇ Backward compatibility ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ
-
-  describe("backward compatibility (no channel param)", () => {
-    it("returns undefined when no prefix configured anywhere", () => {
-      const cfg: TEXT2LLMConfig = {};
-      expect(resolveResponsePrefix(cfg, "main")).toBeUndefined();
-    });
-
-    it("returns global prefix when set", () => {
-      const cfg: TEXT2LLMConfig = { messages: { responsePrefix: "[Bot] " } };
-      expect(resolveResponsePrefix(cfg, "main")).toBe("[Bot] ");
-    });
-
-    it("resolves 'auto' to identity name at global level", () => {
-      const cfg: TEXimport { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveResponsePrefix, resolveEffectiveMessagesConfig } from "./identity.js";
-
-const makeConfig = <T extends TEXT2LLMConfig>(cfg: T) => cfg;
-
 describe("resolveResponsePrefix with per-channel override", () => {
   // ΓöÇΓöÇΓöÇ Backward compatibility ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇ
 
diff --git a/src/agents/memory-search.ts b/src/agents/memory-search.ts
index f048853f7..91a3114d6 100644
--- a/src/agents/memory-search.ts
+++ b/src/agents/memory-search.ts
@@ -5,43 +5,6 @@ import { resolveStateDir } from "../config/paths.js";
 import { clampInt, clampNumber, resolveUserPath } from "../utils.js";
 import { resolveAgentConfig } from "./agent-scope.js";
 
-export type ResolvedMemorySearchConfig = {
-  enabled: boolean;
-  sources: Array<"memory" | "sessions">;
-  extraPaths: string[];
-  provider: "openai" | "local" | "gemini" | "voyage" | "auto";
-  remote?: {
-    baseUrl?: string;
-    apiKey?: string;
-    headers?: Record<string, string>;
-    batch?: {
-      enabled: boolean;
-      wait: boolean;
-      concurrency: number;
-      pollIntervalMs: number;
-      timeoutMinutes: number;
-    };
-  };
-  experimental: {
-    sessionMemory: boolean;
-  };
-  fallback: "openai" | "gemini" | "local" | "voyage" | "none";
-  model: string;
-  local: {
-    modelPath?: string;
-    modelCacheDir?: string;
-  };
-  store: {
-    driver: "sqlite";
-    path: string;
-    vector: {
-  import os from "node:os";
-import path from "node:path";
-import type { TEXT2LLMConfig, MemorySearchConfig } from "../config/config.js";
-import { resolveStateDir } from "../config/paths.js";
-import { clampInt, clampNumber, resolveUserPath } from "../utils.js";
-import { resolveAgentConfig } from "./agent-scope.js";
-
 export type ResolvedMemorySearchConfig = {
   enabled: boolean;
   sources: Array<"memory" | "sessions">;
diff --git a/src/agents/model-catalog.ts b/src/agents/model-catalog.ts
index 8a7e718bb..d7a37ad96 100644
--- a/src/agents/model-catalog.ts
+++ b/src/agents/model-catalog.ts
@@ -33,41 +33,6 @@ export function resetModelCatalogCacheForTest() {
   importPiSdk = defaultImportPiSdk;
 }
 
-// Test-only escape hatch: allow mocking the dynamic imporimport { type TEXT2LLMConfig, loadConfig } from "../config/config.js";
-import { resolveTEXT2LLMAgentDir } from "./agent-paths.js";
-import { ensureTEXT2LLMModelsJson } from "./models-config.js";
-
-export type ModelCatalogEntry = {
-  id: string;
-  name: string;
-  provider: string;
-  contextWindow?: number;
-  reasoning?: boolean;
-  input?: Array<"text" | "image">;
-};
-
-type DiscoveredModel = {
-  id: string;
-  name?: string;
-  provider: string;
-  contextWindow?: number;
-  reasoning?: boolean;
-  input?: Array<"text" | "image">;
-};
-
-type PiSdkModule = typeof import("./pi-model-discovery.js");
-
-let modelCatalogPromise: Promise<ModelCatalogEntry[]> | null = null;
-let hasLoggedModelCatalogError = false;
-const defaultImportPiSdk = () => import("./pi-model-discovery.js");
-let importPiSdk = defaultImportPiSdk;
-
-export function resetModelCatalogCacheForTest() {
-  modelCatalogPromise = null;
-  hasLoggedModelCatalogError = false;
-  importPiSdk = defaultImportPiSdk;
-}
-
 // Test-only escape hatch: allow mocking the dynamic import to simulate transient failures.
 export function __setModelCatalogImportForTest(loader?: () => Promise<PiSdkModule>) {
   importPiSdk = loader ?? defaultImportPiSdk;
diff --git a/src/agents/model-fallback.ts b/src/agents/model-fallback.ts
index a1e885253..da6f0b9a5 100644
--- a/src/agents/model-fallback.ts
+++ b/src/agents/model-fallback.ts
@@ -34,46 +34,6 @@ type FallbackAttempt = {
   code?: string;
 };
 
-/**
- * Fallback abort check. Only treats explicit AbortError names as user aborts.
- * Message-based checks (e.g., "aborted") can mask timeouts and skip fallback.
- */
-function isFallbackAbortError(err: unknown): booleanimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { FailoverReason } from "./pi-embedded-helpers.js";
-import {
-  ensureAuthProfileStore,
-  isProfileInCooldown,
-  resolveAuthProfileOrder,
-} from "./auth-profiles.js";
-import { DEFAULT_MODEL, DEFAULT_PROVIDER } from "./defaults.js";
-import {
-  coerceToFailoverError,
-  describeFailoverError,
-  isFailoverError,
-  isTimeoutError,
-} from "./failover-error.js";
-import {
-  buildConfiguredAllowlistKeys,
-  buildModelAliasIndex,
-  modelKey,
-  resolveConfiguredModelRef,
-  resolveModelRefFromString,
-} from "./model-selection.js";
-
-type ModelCandidate = {
-  provider: string;
-  model: string;
-};
-
-type FallbackAttempt = {
-  provider: string;
-  model: string;
-  error: string;
-  reason?: FailoverReason;
-  status?: number;
-  code?: string;
-};
-
 /**
  * Fallback abort check. Only treats explicit AbortError names as user aborts.
  * Message-based checks (e.g., "aborted") can mask timeouts and skip fallback.
diff --git a/src/agents/pi-embedded-runner/compact.ts b/src/agents/pi-embedded-runner/compact.ts
index 5d7d983eb..207f35e84 100644
--- a/src/agents/pi-embedded-runner/compact.ts
+++ b/src/agents/pi-embedded-runner/compact.ts
@@ -17,25 +17,6 @@ import { type enqueueCommand, enqueueCommandInLane } from "../../process/command
 import { isSubagentSessionKey } from "../../routing/session-key.js";
 import { resolveSignalReactionLevel } from "../../signal/reaction-level.js";
 import { resolveTelegramInlineButtonsScope } from "../../telegram/inline-buttons.js";
-import { resolveTelegramReimport {
-  createAgentSession,
-  estimateTokens,
-  SessionManager,
-  SettingsManager,
-} from "@mariozechner/pi-coding-agent";
-import fs from "node:fs/promises";
-import os from "node:os";
-import type { ReasoningLevel, ThinkLevel } from "../../auto-reply/thinking.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ExecElevatedDefaults } from "../bash-tools.js";
-import type { EmbeddedPiCompactResult } from "./types.js";
-import { resolveHeartbeatPrompt } from "../../auto-reply/heartbeat.js";
-import { resolveChannelCapabilities } from "../../config/channel-capabilities.js";
-import { getMachineDisplayName } from "../../infra/machine-name.js";
-import { type enqueueCommand, enqueueCommandInLane } from "../../process/command-queue.js";
-import { isSubagentSessionKey } from "../../routing/session-key.js";
-import { resolveSignalReactionLevel } from "../../signal/reaction-level.js";
-import { resolveTelegramInlineButtonsScope } from "../../telegram/inline-buttons.js";
 import { resolveTelegramReactionLevel } from "../../telegram/reaction-level.js";
 import { buildTtsSystemPromptHint } from "../../tts/tts.js";
 import { resolveUserPath } from "../../utils.js";
diff --git a/src/agents/pi-embedded-runner/run/attempt.ts b/src/agents/pi-embedded-runner/run/attempt.ts
index 5e0486cc4..e506cbf64 100644
--- a/src/agents/pi-embedded-runner/run/attempt.ts
+++ b/src/agents/pi-embedded-runner/run/attempt.ts
@@ -905,6 +905,8 @@ export async function runEmbeddedAttempt(
         .slice()
         .toReversed()
         .find((m) => m.role === "assistant");
+        
+      console.error("DEBUG: lastAssistant =", JSON.stringify(lastAssistant, null, 2));
 
       const toolMetasNormalized = toolMetas
         .filter(
diff --git a/src/agents/pi-embedded-runner/run/params.ts b/src/agents/pi-embedded-runner/run/params.ts
index d51ac7ef0..2f7f80d52 100644
--- a/src/agents/pi-embedded-runner/run/params.ts
+++ b/src/agents/pi-embedded-runner/run/params.ts
@@ -18,29 +18,6 @@ export type ClientToolDefinition = {
   };
 };
 
-export type RunEmbeddedPiAgentParams = {
-  sessionId: string;
-  sessionKey?: string;
-  agentId?: simport type { ImageContent } from "@mariozechner/pi-ai";
-import type { ReasoningLevel, ThinkLevel, VerboseLevel } from "../../../auto-reply/thinking.js";
-import type { AgentStreamParams } from "../../../commands/agent/types.js";
-import type { TEXT2LLMConfig } from "../../../config/config.js";
-import type { enqueueCommand } from "../../../process/command-queue.js";
-import type { InputProvenance } from "../../../sessions/input-provenance.js";
-import type { ExecElevatedDefaults, ExecToolDefaults } from "../../bash-tools.js";
-import type { BlockReplyChunking, ToolResultFormat } from "../../pi-embedded-subscribe.js";
-import type { SkillSnapshot } from "../../skills.js";
-
-// Simplified tool definition for client-provided tools (OpenResponses hosted tools)
-export type ClientToolDefinition = {
-  type: "function";
-  function: {
-    name: string;
-    description?: string;
-    parameters?: Record<string, unknown>;
-  };
-};
-
 export type RunEmbeddedPiAgentParams = {
   sessionId: string;
   sessionKey?: string;
diff --git a/src/agents/pi-embedded-runner/session-manager-cache.ts b/src/agents/pi-embedded-runner/session-manager-cache.ts
index bc9a92295..d2b309fae 100644
--- a/src/agents/pi-embedded-runner/session-manager-cache.ts
+++ b/src/agents/pi-embedded-runner/session-manager-cache.ts
@@ -32,42 +32,6 @@ export function trackSessionManagerAccess(sessionFile: string): void {
   });
 }
 
-function isSessionManagerCached(sessionFile: string): boolean {
-  if (!isSessionManagerCacheEnabled()) {
-    reimport { Buffer } from "node:buffer";
-import fs from "node:fs/promises";
-import { isCacheEnabled, resolveCacheTtlMs } from "../../config/cache-utils.js";
-
-type SessionManagerCacheEntry = {
-  sessionFile: string;
-  loadedAt: number;
-};
-
-const SESSION_MANAGER_CACHE = new Map<string, SessionManagerCacheEntry>();
-const DEFAULT_SESSION_MANAGER_TTL_MS = 45_000; // 45 seconds
-
-function getSessionManagerTtl(): number {
-  return resolveCacheTtlMs({
-    envValue: process.env.TEXT2LLM_SESSION_MANAGER_CACHE_TTL_MS,
-    defaultTtlMs: DEFAULT_SESSION_MANAGER_TTL_MS,
-  });
-}
-
-function isSessionManagerCacheEnabled(): boolean {
-  return isCacheEnabled(getSessionManagerTtl());
-}
-
-export function trackSessionManagerAccess(sessionFile: string): void {
-  if (!isSessionManagerCacheEnabled()) {
-    return;
-  }
-  const now = Date.now();
-  SESSION_MANAGER_CACHE.set(sessionFile, {
-    sessionFile,
-    loadedAt: now,
-  });
-}
-
 function isSessionManagerCached(sessionFile: string): boolean {
   if (!isSessionManagerCacheEnabled()) {
     return false;
diff --git a/src/agents/pi-embedded-runner/utils.ts b/src/agents/pi-embedded-runner/utils.ts
index ad5b36cb3..ae7a620ec 100644
--- a/src/agents/pi-embedded-runner/utils.ts
+++ b/src/agents/pi-embedded-runner/utils.ts
@@ -34,40 +34,4 @@ export function describeUnknownError(error: unknown): string {
   }
 }
 
-export type { ReasoningLeveimport type { ThinkingLevel } from "@mariozechner/pi-agent-core";
-import type { ReasoningLevel, ThinkLevel } from "../../auto-reply/thinking.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ExecToolDefaults } from "../bash-tools.js";
-
-export function mapThinkingLevel(level?: ThinkLevel): ThinkingLevel {
-  // pi-agent-core supports "xhigh"; text2llm enables it for specific models.
-  if (!level) {
-    return "off";
-  }
-  return level;
-}
-
-export function resolveExecToolDefaults(config?: TEXT2LLMConfig): ExecToolDefaults | undefined {
-  const tools = config?.tools;
-  if (!tools?.exec) {
-    return undefined;
-  }
-  return tools.exec;
-}
-
-export function describeUnknownError(error: unknown): string {
-  if (error instanceof Error) {
-    return error.message;
-  }
-  if (typeof error === "string") {
-    return error;
-  }
-  try {
-    const serialized = JSON.stringify(error);
-    return serialized ?? "Unknown error";
-  } catch {
-    return "Unknown error";
-  }
-}
-
 export type { ReasoningLevel, ThinkLevel };
diff --git a/src/agents/pi-embedded-subscribe.raw-stream.ts b/src/agents/pi-embedded-subscribe.raw-stream.ts
index ce2d0a3cb..d9aef15e4 100644
--- a/src/agents/pi-embedded-subscribe.raw-stream.ts
+++ b/src/agents/pi-embedded-subscribe.raw-stream.ts
@@ -28,33 +28,3 @@ export function appendRawStream(payload: Record<string, unknown>) {
     // ignore raw stream write failures
   }
 }
-import fs from "node:fs";
-import path from "node:path";
-import { resolveStateDir } from "../config/paths.js";
-import { isTruthyEnvValue } from "../infra/env.js";
-
-const RAW_STREAM_ENABLED = isTruthyEnvValue(process.env.TEXT2LLM_RAW_STREAM);
-const RAW_STREAM_PATH =
-  process.env.TEXT2LLM_RAW_STREAM_PATH?.trim() ||
-  path.join(resolveStateDir(), "logs", "raw-stream.jsonl");
-
-let rawStreamReady = false;
-
-export function appendRawStream(payload: Record<string, unknown>) {
-  if (!RAW_STREAM_ENABLED) {
-    return;
-  }
-  if (!rawStreamReady) {
-    rawStreamReady = true;
-    try {
-      fs.mkdirSync(path.dirname(RAW_STREAM_PATH), { recursive: true });
-    } catch {
-      // ignore raw stream mkdir failures
-    }
-  }
-  try {
-    void fs.promises.appendFile(RAW_STREAM_PATH, `${JSON.stringify(payload)}\n`);
-  } catch {
-    // ignore raw stream write failures
-  }
-}
diff --git a/src/agents/pi-settings.ts b/src/agents/pi-settings.ts
index 071bf8452..b7c8c36c8 100644
--- a/src/agents/pi-settings.ts
+++ b/src/agents/pi-settings.ts
@@ -25,34 +25,6 @@ export function ensurePiCompactionReserveTokens(params: {
   return { didOverride: true, reserveTokens: minReserveTokens };
 }
 
-export function resolveCompactionReserveTokensFloor(cfg?: TEXT2LLMConfig): number {
-  const raw = cfg?.agents?.dimport type { TEXT2LLMConfig } from "../config/config.js";
-
-export const DEFAULT_PI_COMPACTION_RESERVE_TOKENS_FLOOR = 20_000;
-
-type PiSettingsManagerLike = {
-  getCompactionReserveTokens: () => number;
-  applyOverrides: (overrides: { compaction: { reserveTokens: number } }) => void;
-};
-
-export function ensurePiCompactionReserveTokens(params: {
-  settingsManager: PiSettingsManagerLike;
-  minReserveTokens?: number;
-}): { didOverride: boolean; reserveTokens: number } {
-  const minReserveTokens = params.minReserveTokens ?? DEFAULT_PI_COMPACTION_RESERVE_TOKENS_FLOOR;
-  const current = params.settingsManager.getCompactionReserveTokens();
-
-  if (current >= minReserveTokens) {
-    return { didOverride: false, reserveTokens: current };
-  }
-
-  params.settingsManager.applyOverrides({
-    compaction: { reserveTokens: minReserveTokens },
-  });
-
-  return { didOverride: true, reserveTokens: minReserveTokens };
-}
-
 export function resolveCompactionReserveTokensFloor(cfg?: TEXT2LLMConfig): number {
   const raw = cfg?.agents?.defaults?.compaction?.reserveTokensFloor;
   if (typeof raw === "number" && Number.isFinite(raw) && raw >= 0) {
diff --git a/src/agents/pi-tools.policy.ts b/src/agents/pi-tools.policy.ts
index bbc88c4c5..a0c35e2a7 100644
--- a/src/agents/pi-tools.policy.ts
+++ b/src/agents/pi-tools.policy.ts
@@ -8,30 +8,6 @@ import { normalizeMessageChannel } from "../utils/message-channel.js";
 import { resolveAgentConfig, resolveAgentIdFromSessionKey } from "./agent-scope.js";
 import { expandToolGroups, normalizeToolName } from "./tool-policy.js";
 
-type CompiledPattern =
-  | { kind: "all" }
-  | { kind: "exact"; value: string }
-  | { kind: "regex"; value: RegExp };
-
-function compilePattern(pattern: string): CompiledPattern {
-  const normalized = normalizeToolName(pattern);
-  if (!normalized) {
-    return { kind: "exact", value: "" };
-  }
-  if (normalized === "*") {
-    return { kind: "all" };
-  }
-  if (!normalized.includes("*")) {
-    return { kind: "exaimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { AnyAgentTool } from "./pi-tools.types.js";
-import type { SandboxToolPolicy } from "./sandbox.js";
-import { getChannelDock } from "../channels/dock.js";
-import { resolveChannelGroupToolsPolicy } from "../config/group-policy.js";
-import { resolveThreadParentSessionKey } from "../sessions/session-key-utils.js";
-import { normalizeMessageChannel } from "../utils/message-channel.js";
-import { resolveAgentConfig, resolveAgentIdFromSessionKey } from "./agent-scope.js";
-import { expandToolGroups, normalizeToolName } from "./tool-policy.js";
-
 type CompiledPattern =
   | { kind: "all" }
   | { kind: "exact"; value: string }
diff --git a/src/agents/pi-tools.whatsapp-login-gating.test.ts b/src/agents/pi-tools.whatsapp-login-gating.test.ts
index ff0a9386f..5fe0bfbad 100644
--- a/src/agents/pi-tools.whatsapp-login-gating.test.ts
+++ b/src/agents/pi-tools.whatsapp-login-gating.test.ts
@@ -14,35 +14,6 @@ vi.mock("./channel-tools.js", () => {
   };
 });
 
-describe("whatsapp_login tool gating", () => {
-  it("removes whatsapp_login for unauthorized senders", () => {
-    const tools = createTEXT2LLMCodingTools({ senderIsOwner: false });
-    const toolNames = tools.map((tool) => tool.name);
-    expect(toolNames).not.toContain("whatsapp_login");
-  });
-
-  it("keeps whatsapp_login for authorized senders", () => {
-    const tools = createTEXT2LLMCodingTools({ senderIsOwner: true });
-    const toolNames = tools.map((tool) => tool.name);
-    expect(toolNames).toContain("whatsapp_login");
-  });
-
-  it("defaults to removing whatsapp_login import { describe, expect, it, vi } from "vitest";
-import "./test-helpers/fast-coding-tools.js";
-import { createTEXT2LLMCodingTools } from "./pi-tools.js";
-
-vi.mock("./channel-tools.js", () => {
-  const stubTool = (name: string) => ({
-    name,
-    description: `${name} stub`,
-    parameters: { type: "object", properties: {} },
-    execute: vi.fn(),
-  });
-  return {
-    listChannelAgentTools: () => [stubTool("whatsapp_login")],
-  };
-});
-
 describe("whatsapp_login tool gating", () => {
   it("removes whatsapp_login for unauthorized senders", () => {
     const tools = createTEXT2LLMCodingTools({ senderIsOwner: false });
diff --git a/src/agents/sessions-spawn-threadid.test.ts b/src/agents/sessions-spawn-threadid.test.ts
index a48f77086..2b1ea379e 100644
--- a/src/agents/sessions-spawn-threadid.test.ts
+++ b/src/agents/sessions-spawn-threadid.test.ts
@@ -28,42 +28,6 @@ import {
   resetSubagentRegistryForTests,
 } from "./subagent-registry.js";
 
-describe("sessions_spawn requesterOrigin threading", () => {
-  beforeEach(() => {
-    resetSubagentRegistryForTests();
-    callGatewayMock.mockReset();
-    configOverride = {
-      session: {
-        mainKey:import { beforeEach, describe, expect, it, vi } from "vitest";
-
-const callGatewayMock = vi.fn();
-vi.mock("../gateway/call.js", () => ({
-  callGateway: (opts: unknown) => callGatewayMock(opts),
-}));
-
-let configOverride: ReturnType<(typeof import("../config/config.js"))["loadConfig"]> = {
-  session: {
-    mainKey: "main",
-    scope: "per-sender",
-  },
-};
-
-vi.mock("../config/config.js", async (importOriginal) => {
-  const actual = await importOriginal<typeof import("../config/config.js")>();
-  return {
-    ...actual,
-    loadConfig: () => configOverride,
-    resolveGatewayPort: () => 18789,
-  };
-});
-
-import "./test-helpers/fast-core-tools.js";
-import { createTEXT2LLMTools } from "./text2llm-tools.js";
-import {
-  listSubagentRunsForRequester,
-  resetSubagentRegistryForTests,
-} from "./subagent-registry.js";
-
 describe("sessions_spawn requesterOrigin threading", () => {
   beforeEach(() => {
     resetSubagentRegistryForTests();
diff --git a/src/agents/skills-install.ts b/src/agents/skills-install.ts
index 1d41735db..0d8523b97 100644
--- a/src/agents/skills-install.ts
+++ b/src/agents/skills-install.ts
@@ -27,35 +27,6 @@ export type SkillInstallRequest = {
   config?: TEXT2LLMConfig;
 };
 
-export type Skilimport type { ReadableStream as NodeReadableStream } from "node:stream/web";
-import fs from "node:fs";
-import path from "node:path";
-import { Readable } from "node:stream";
-import { pipeline } from "node:stream/promises";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveBrewExecutable } from "../infra/brew.js";
-import { fetchWithSsrFGuard } from "../infra/net/fetch-guard.js";
-import { runCommandWithTimeout } from "../process/exec.js";
-import { scanDirectoryWithSummary } from "../security/skill-scanner.js";
-import { CONFIG_DIR, ensureDir, resolveUserPath } from "../utils.js";
-import {
-  hasBinary,
-  loadWorkspaceSkillEntries,
-  resolveSkillsInstallPreferences,
-  type SkillEntry,
-  type SkillInstallSpec,
-  type SkillsInstallPreferences,
-} from "./skills.js";
-import { resolveSkillKey } from "./skills/frontmatter.js";
-
-export type SkillInstallRequest = {
-  workspaceDir: string;
-  skillName: string;
-  installId: string;
-  timeoutMs?: number;
-  config?: TEXT2LLMConfig;
-};
-
 export type SkillInstallResult = {
   ok: boolean;
   message: string;
diff --git a/src/agents/skills/bundled-dir.ts b/src/agents/skills/bundled-dir.ts
index 28b3db1c1..73948a636 100644
--- a/src/agents/skills/bundled-dir.ts
+++ b/src/agents/skills/bundled-dir.ts
@@ -33,44 +33,6 @@ export type BundledSkillsResolveOptions = {
   execPath?: string;
 };
 
-export function resolveBundledSkillsDir(
-  opts: BundledSkillsResolveOptions = {},
-): string | undefined {
-  const override = process.env.TEXT2LLM_BUNDLED_SKILLSimport fs from "node:fs";
-import path from "node:path";
-import { fileURLToPath } from "node:url";
-import { resolveTEXT2LLMPackageRootSync } from "../../infra/text2llm-root.js";
-
-function looksLikeSkillsDir(dir: string): boolean {
-  try {
-    const entries = fs.readdirSync(dir, { withFileTypes: true });
-    for (const entry of entries) {
-      if (entry.name.startsWith(".")) {
-        continue;
-      }
-      const fullPath = path.join(dir, entry.name);
-      if (entry.isFile() && entry.name.endsWith(".md")) {
-        return true;
-      }
-      if (entry.isDirectory()) {
-        if (fs.existsSync(path.join(fullPath, "SKILL.md"))) {
-          return true;
-        }
-      }
-    }
-  } catch {
-    return false;
-  }
-  return false;
-}
-
-export type BundledSkillsResolveOptions = {
-  argv1?: string;
-  moduleUrl?: string;
-  cwd?: string;
-  execPath?: string;
-};
-
 export function resolveBundledSkillsDir(
   opts: BundledSkillsResolveOptions = {},
 ): string | undefined {
diff --git a/src/agents/system-prompt-params.test.ts b/src/agents/system-prompt-params.test.ts
index a15f931df..f87e70d36 100644
--- a/src/agents/system-prompt-params.test.ts
+++ b/src/agents/system-prompt-params.test.ts
@@ -28,38 +28,6 @@ function buildParams(params: { config?: TEXT2LLMConfig; workspaceDir?: string; c
   });
 }
 
-describe("buildSystemPromptParams repo root", () => {
-  it("detects repo root from workspaceDir", async () => {
-    const temp = await makeTempDir("workimport fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { buildSystemPromptParams } from "./system-prompt-params.js";
-
-async function makeTempDir(label: string): Promise<string> {
-  return fs.mkdtemp(path.join(os.tmpdir(), `text2llm-${label}-`));
-}
-
-async function makeRepoRoot(root: string): Promise<void> {
-  await fs.mkdir(path.join(root, ".git"), { recursive: true });
-}
-
-function buildParams(params: { config?: TEXT2LLMConfig; workspaceDir?: string; cwd?: string }) {
-  return buildSystemPromptParams({
-    config: params.config,
-    workspaceDir: params.workspaceDir,
-    cwd: params.cwd,
-    runtime: {
-      host: "host",
-      os: "os",
-      arch: "arch",
-      node: "node",
-      model: "model",
-    },
-  });
-}
-
 describe("buildSystemPromptParams repo root", () => {
   it("detects repo root from workspaceDir", async () => {
     const temp = await makeTempDir("workspace");
diff --git a/src/agents/text2llm-tools.subagents.sessions-spawn-allows-cross-agent-spawning-configured.test.ts b/src/agents/text2llm-tools.subagents.sessions-spawn-allows-cross-agent-spawning-configured.test.ts
index d306b10ce..f287013d0 100644
--- a/src/agents/text2llm-tools.subagents.sessions-spawn-allows-cross-agent-spawning-configured.test.ts
+++ b/src/agents/text2llm-tools.subagents.sessions-spawn-allows-cross-agent-spawning-configured.test.ts
@@ -25,43 +25,6 @@ import "./test-helpers/fast-core-tools.js";
 import { createTEXT2LLMTools } from "./text2llm-tools.js";
 import { resetSubagentRegistryForTests } from "./subagent-registry.js";
 
-describe("text2llm-tools: subagents", () => {
-  beforeEach(() => {
-    configOverride = {
-      session: {
-        mainKey: "main",
-        scope: "per-sender",
-      },
-    };
-  });
-
-  it("sessions_spawn allows cross-agent spawning when confiimport { beforeEach, describe, expect, it, vi } from "vitest";
-
-const callGatewayMock = vi.fn();
-vi.mock("../gateway/call.js", () => ({
-  callGateway: (opts: unknown) => callGatewayMock(opts),
-}));
-
-let configOverride: ReturnType<(typeof import("../config/config.js"))["loadConfig"]> = {
-  session: {
-    mainKey: "main",
-    scope: "per-sender",
-  },
-};
-
-vi.mock("../config/config.js", async (importOriginal) => {
-  const actual = await importOriginal<typeof import("../config/config.js")>();
-  return {
-    ...actual,
-    loadConfig: () => configOverride,
-    resolveGatewayPort: () => 18789,
-  };
-});
-
-import "./test-helpers/fast-core-tools.js";
-import { createTEXT2LLMTools } from "./text2llm-tools.js";
-import { resetSubagentRegistryForTests } from "./subagent-registry.js";
-
 describe("text2llm-tools: subagents", () => {
   beforeEach(() => {
     configOverride = {
diff --git a/src/agents/tools/discord-actions.ts b/src/agents/tools/discord-actions.ts
index a91e20d9c..e735504e2 100644
--- a/src/agents/tools/discord-actions.ts
+++ b/src/agents/tools/discord-actions.ts
@@ -26,45 +26,6 @@ const messagingActions = new Set([
   "searchMessages",
 ]);
 
-const guildActions = new Set([
-  "memberInfo",
-  "roleInfo",
-  "emojiList",
-  "emojiUpload",
-  "stickerUpload",
-  "roleAdd",
-  "roleRemove",
-  "channelInfo",
-  "channelList",
-  "voiceStatus",
-  "eventList",import type { AgentToolResult } from "@mariozechner/pi-agent-core";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { createActionGate, readStringParam } from "./common.js";
-import { handleDiscordGuildAction } from "./discord-actions-guild.js";
-import { handleDiscordMessagingAction } from "./discord-actions-messaging.js";
-import { handleDiscordModerationAction } from "./discord-actions-moderation.js";
-import { handleDiscordPresenceAction } from "./discord-actions-presence.js";
-
-const messagingActions = new Set([
-  "react",
-  "reactions",
-  "sticker",
-  "poll",
-  "permissions",
-  "fetchMessage",
-  "readMessages",
-  "sendMessage",
-  "editMessage",
-  "deleteMessage",
-  "threadCreate",
-  "threadList",
-  "threadReply",
-  "pinMessage",
-  "unpinMessage",
-  "listPins",
-  "searchMessages",
-]);
-
 const guildActions = new Set([
   "memberInfo",
   "roleInfo",
diff --git a/src/agents/tools/image-tool.test.ts b/src/agents/tools/image-tool.test.ts
index 6b8cb1420..a30c0d240 100644
--- a/src/agents/tools/image-tool.test.ts
+++ b/src/agents/tools/image-tool.test.ts
@@ -14,33 +14,6 @@ async function writeAuthProfiles(agentDir: string, profiles: unknown) {
   );
 }
 
-describe("image tool implicit imageModel config", () => {
-  const priorFetch = global.fetch;
-
-  beforeEach(() => {
-    vi.stubEnv("OPENAI_API_KEY", "");
-    vi.stubEnv("ANTHROPIC_API_KEY", "");
-    vi.stubEnv("ANTHROPIC_OAUTH_TOKEN", "");
-    vi.stubEnv("MINIMAX_API_KEY", "");
-    vi.stubEnv("ZAI_API_KEY", "");
-    vi.stubEnv("Z_AI_API_KEY", "");
-    // Avoid implicit Copilot provider discovery hitting the network in tests.
-    vi.stubEnv("COimport fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { __testing, createImageTool, resolveImageModelConfigForTool } from "./image-tool.js";
-
-async function writeAuthProfiles(agentDir: string, profiles: unknown) {
-  await fs.mkdir(agentDir, { recursive: true });
-  await fs.writeFile(
-    path.join(agentDir, "auth-profiles.json"),
-    `${JSON.stringify(profiles, null, 2)}\n`,
-    "utf8",
-  );
-}
-
 describe("image tool implicit imageModel config", () => {
   const priorFetch = global.fetch;
 
diff --git a/src/agents/tools/message-tool.ts b/src/agents/tools/message-tool.ts
index 538b5dd32..7c4f001a3 100644
--- a/src/agents/tools/message-tool.ts
+++ b/src/agents/tools/message-tool.ts
@@ -17,25 +17,6 @@ import { getToolResult, runMessageAction } from "../../infra/outbound/message-ac
 import { normalizeTargetForProvider } from "../../infra/outbound/target-normalization.js";
 import { normalizeAccountId } from "../../routing/session-key.js";
 import { stripReasoningTagsFromText } from "../../shared/text/reasoning-tags.js";
-import { normalizeMessimport { Type } from "@sinclair/typebox";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { AnyAgentTool } from "./common.js";
-import { BLUEBUBBLES_GROUP_ACTIONS } from "../../channels/plugins/bluebubbles-actions.js";
-import {
-  listChannelMessageActions,
-  supportsChannelMessageButtons,
-  supportsChannelMessageCards,
-} from "../../channels/plugins/message-actions.js";
-import {
-  CHANNEL_MESSAGE_ACTION_NAMES,
-  type ChannelMessageActionName,
-} from "../../channels/plugins/types.js";
-import { loadConfig } from "../../config/config.js";
-import { GATEWAY_CLIENT_IDS, GATEWAY_CLIENT_MODES } from "../../gateway/protocol/client-info.js";
-import { getToolResult, runMessageAction } from "../../infra/outbound/message-action-runner.js";
-import { normalizeTargetForProvider } from "../../infra/outbound/target-normalization.js";
-import { normalizeAccountId } from "../../routing/session-key.js";
-import { stripReasoningTagsFromText } from "../../shared/text/reasoning-tags.js";
 import { normalizeMessageChannel } from "../../utils/message-channel.js";
 import { resolveSessionAgentId } from "../agent-scope.js";
 import { listChannelSupportedActions } from "../channel-tools.js";
diff --git a/src/agents/tools/nodes-tool.ts b/src/agents/tools/nodes-tool.ts
index 75059da5e..5ca95313f 100644
--- a/src/agents/tools/nodes-tool.ts
+++ b/src/agents/tools/nodes-tool.ts
@@ -22,30 +22,6 @@ import { optionalStringEnum, stringEnum } from "../schema/typebox.js";
 import { sanitizeToolResultImages } from "../tool-images.js";
 import { type AnyAgentTool, jsonResult, readStringParam } from "./common.js";
 import { callGatewayTool, type GatewayCallOptions } from "./gateway.js";
-import type { AgentToolResult } from "@mariozechner/pi-agent-core";
-import { Type } from "@sinclair/typebox";
-import crypto from "node:crypto";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import {
-  type CameraFacing,
-  cameraTempPath,
-  parseCameraClipPayload,
-  parseCameraSnapPayload,
-  writeBase64ToFile,
-} from "../../cli/nodes-camera.js";
-import { parseEnvPairs, parseTimeoutMs } from "../../cli/nodes-run.js";
-import {
-  parseScreenRecordPayload,
-  screenRecordTempPath,
-  writeScreenRecordToFile,
-} from "../../cli/nodes-screen.js";
-import { parseDurationMs } from "../../cli/parse-duration.js";
-import { imageMimeFromFormat } from "../../media/mime.js";
-import { resolveSessionAgentId } from "../agent-scope.js";
-import { optionalStringEnum, stringEnum } from "../schema/typebox.js";
-import { sanitizeToolResultImages } from "../tool-images.js";
-import { type AnyAgentTool, jsonResult, readStringParam } from "./common.js";
-import { callGatewayTool, type GatewayCallOptions } from "./gateway.js";
 import { listNodes, resolveNodeIdFromList, resolveNodeId } from "./nodes-utils.js";
 
 const NODES_TOOL_ACTIONS = [
diff --git a/src/agents/tools/session-status-tool.ts b/src/agents/tools/session-status-tool.ts
index e0155d5ac..c506ce984 100644
--- a/src/agents/tools/session-status-tool.ts
+++ b/src/agents/tools/session-status-tool.ts
@@ -23,31 +23,6 @@ import {
   resolveAgentIdFromSessionKey,
 } from "../../routing/session-key.js";
 import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
-import { resolveAgenimport { Type } from "@sinclair/typebox";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { AnyAgentTool } from "./common.js";
-import { normalizeGroupActivation } from "../../auto-reply/group-activation.js";
-import { getFollowupQueueDepth, resolveQueueSettings } from "../../auto-reply/reply/queue.js";
-import { buildStatusMessage } from "../../auto-reply/status.js";
-import { loadConfig } from "../../config/config.js";
-import {
-  loadSessionStore,
-  resolveStorePath,
-  type SessionEntry,
-  updateSessionStore,
-} from "../../config/sessions.js";
-import { loadCombinedSessionStoreForGateway } from "../../gateway/session-utils.js";
-import {
-  formatUsageWindowSummary,
-  loadProviderUsageSummary,
-  resolveUsageProviderId,
-} from "../../infra/provider-usage.js";
-import {
-  buildAgentMainSessionKey,
-  DEFAULT_AGENT_ID,
-  resolveAgentIdFromSessionKey,
-} from "../../routing/session-key.js";
-import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
 import { resolveAgentDir } from "../agent-scope.js";
 import {
   ensureAuthProfileStore,
diff --git a/src/agents/tools/telegram-actions.test.ts b/src/agents/tools/telegram-actions.test.ts
index efc0803ad..3b4758076 100644
--- a/src/agents/tools/telegram-actions.test.ts
+++ b/src/agents/tools/telegram-actions.test.ts
@@ -21,31 +21,6 @@ vi.mock("../../telegram/send.js", () => ({
   deleteMessageTelegram: (...args: unknown[]) => deleteMessageTelegram(...args),
 }));
 
-describe("handleTelegramAction", () => {
-  beforeEach(() => {
-    reactMessimport { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { handleTelegramAction, readTelegramButtons } from "./telegram-actions.js";
-
-const reactMessageTelegram = vi.fn(async () => ({ ok: true }));
-const sendMessageTelegram = vi.fn(async () => ({
-  messageId: "789",
-  chatId: "123",
-}));
-const sendStickerTelegram = vi.fn(async () => ({
-  messageId: "456",
-  chatId: "123",
-}));
-const deleteMessageTelegram = vi.fn(async () => ({ ok: true }));
-const originalToken = process.env.TELEGRAM_BOT_TOKEN;
-
-vi.mock("../../telegram/send.js", () => ({
-  reactMessageTelegram: (...args: unknown[]) => reactMessageTelegram(...args),
-  sendMessageTelegram: (...args: unknown[]) => sendMessageTelegram(...args),
-  sendStickerTelegram: (...args: unknown[]) => sendStickerTelegram(...args),
-  deleteMessageTelegram: (...args: unknown[]) => deleteMessageTelegram(...args),
-}));
-
 describe("handleTelegramAction", () => {
   beforeEach(() => {
     reactMessageTelegram.mockClear();
diff --git a/src/agents/tools/web-fetch.ts b/src/agents/tools/web-fetch.ts
index ad520594d..d6e5cf131 100644
--- a/src/agents/tools/web-fetch.ts
+++ b/src/agents/tools/web-fetch.ts
@@ -29,37 +29,6 @@ import {
 
 export { extractReadableContent } from "./web-fetch-utils.js";
 
-const EXTRimport { Type } from "@sinclair/typebox";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { AnyAgentTool } from "./common.js";
-import { fetchWithSsrFGuard } from "../../infra/net/fetch-guard.js";
-import { SsrFBlockedError } from "../../infra/net/ssrf.js";
-import { wrapExternalContent, wrapWebContent } from "../../security/external-content.js";
-import { normalizeSecretInput } from "../../utils/normalize-secret-input.js";
-import { stringEnum } from "../schema/typebox.js";
-import { jsonResult, readNumberParam, readStringParam } from "./common.js";
-import {
-  extractReadableContent,
-  htmlToMarkdown,
-  markdownToText,
-  truncateText,
-  type ExtractMode,
-} from "./web-fetch-utils.js";
-import {
-  CacheEntry,
-  DEFAULT_CACHE_TTL_MINUTES,
-  DEFAULT_TIMEOUT_SECONDS,
-  normalizeCacheKey,
-  readCache,
-  readResponseText,
-  resolveCacheTtlMs,
-  resolveTimeoutSeconds,
-  withTimeout,
-  writeCache,
-} from "./web-shared.js";
-
-export { extractReadableContent } from "./web-fetch-utils.js";
-
 const EXTRACT_MODES = ["markdown", "text"] as const;
 
 const DEFAULT_FETCH_MAX_CHARS = 50_000;
diff --git a/src/agents/tools/whatsapp-actions.test.ts b/src/agents/tools/whatsapp-actions.test.ts
index 83d5f3702..5dbc3270f 100644
--- a/src/agents/tools/whatsapp-actions.test.ts
+++ b/src/agents/tools/whatsapp-actions.test.ts
@@ -14,35 +14,6 @@ const enabledConfig = {
   channels: { whatsapp: { actions: { reactions: true } } },
 } as TEXT2LLMConfig;
 
-describe("handleWhatsAppAction", () => {
-  it("adds reactions", async () => {
-    await handleWhatsAppAction(
-      {
-        action: "react",
-        chatJid: "123@s.whatsapp.net",
-        messageId: "msg1",
-        emoji: "Γ£à",
-      },
-      enabledConfig,
-    );
-    expect(sendReactionWhatsApp).toHaveBeenCalledWith("123@s.whatsapp.net", "msg1", "Γ£à", {
-      verbose: false,
-      fromMe: import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { handleWhatsAppAction } from "./whatsapp-actions.js";
-
-const sendReactionWhatsApp = vi.fn(async () => undefined);
-const sendPollWhatsApp = vi.fn(async () => ({ messageId: "poll-1", toJid: "jid-1" }));
-
-vi.mock("../../web/outbound.js", () => ({
-  sendReactionWhatsApp: (...args: unknown[]) => sendReactionWhatsApp(...args),
-  sendPollWhatsApp: (...args: unknown[]) => sendPollWhatsApp(...args),
-}));
-
-const enabledConfig = {
-  channels: { whatsapp: { actions: { reactions: true } } },
-} as TEXT2LLMConfig;
-
 describe("handleWhatsAppAction", () => {
   it("adds reactions", async () => {
     await handleWhatsAppAction(
diff --git a/src/auto-reply/command-auth.ts b/src/auto-reply/command-auth.ts
index 1df4e8e17..a0d578364 100644
--- a/src/auto-reply/command-auth.ts
+++ b/src/auto-reply/command-auth.ts
@@ -25,34 +25,7 @@ function resolveProviderFromContext(ctx: MsgContext, cfg: TEXT2LLMConfig): Chann
   }
   const candidates = [ctx.From, ctx.To]
     .filter((value): value is string => Boolean(value?.trim()))
-    .flatMap((value) => value.split(":").map((part) => part.trimport type { ChannelDock } from "../channels/dock.js";
-import type { ChannelId } from "../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { MsgContext } from "./templating.js";
-import { getChannelDock, listChannelDocks } from "../channels/dock.js";
-import { normalizeAnyChannelId } from "../channels/registry.js";
-
-export type CommandAuthorization = {
-  providerId?: ChannelId;
-  ownerList: string[];
-  senderId?: string;
-  senderIsOwner: boolean;
-  isAuthorizedSender: boolean;
-  from?: string;
-  to?: string;
-};
-
-function resolveProviderFromContext(ctx: MsgContext, cfg: TEXT2LLMConfig): ChannelId | undefined {
-  const direct =
-    normalizeAnyChannelId(ctx.Provider) ??
-    normalizeAnyChannelId(ctx.Surface) ??
-    normalizeAnyChannelId(ctx.OriginatingChannel);
-  if (direct) {
-    return direct;
-  }
-  const candidates = [ctx.From, ctx.To]
-    .filter((value): value is string => Boolean(value?.trim()))
-    .flatMap((value) => value.split(":").map((part) => part.trim()));
+    .flatMap((value) => value.split(":").map((part) => part.tr()));
   for (const candidate of candidates) {
     const normalized = normalizeAnyChannelId(candidate);
     if (normalized) {
diff --git a/src/auto-reply/commands-registry.types.ts b/src/auto-reply/commands-registry.types.ts
index 5cbedc670..f7b58ca62 100644
--- a/src/auto-reply/commands-registry.types.ts
+++ b/src/auto-reply/commands-registry.types.ts
@@ -39,48 +39,6 @@ export type CommandArgMenuSpec = {
   title?: string;
 };
 
-export type CommandArgValue = string | number | boolean | bigint;
-export type CommandArgimport type { TEXT2LLMConfig } from "../config/types.js";
-
-export type CommandScope = "text" | "native" | "both";
-
-export type CommandCategory =
-  | "session"
-  | "options"
-  | "status"
-  | "management"
-  | "media"
-  | "tools"
-  | "docks";
-
-export type CommandArgType = "string" | "number" | "boolean";
-
-export type CommandArgChoiceContext = {
-  cfg?: TEXT2LLMConfig;
-  provider?: string;
-  model?: string;
-  command: ChatCommandDefinition;
-  arg: CommandArgDefinition;
-};
-
-export type CommandArgChoice = string | { value: string; label: string };
-
-export type CommandArgChoicesProvider = (context: CommandArgChoiceContext) => CommandArgChoice[];
-
-export type CommandArgDefinition = {
-  name: string;
-  description: string;
-  type: CommandArgType;
-  required?: boolean;
-  choices?: CommandArgChoice[] | CommandArgChoicesProvider;
-  captureRemaining?: boolean;
-};
-
-export type CommandArgMenuSpec = {
-  arg: string;
-  title?: string;
-};
-
 export type CommandArgValue = string | number | boolean | bigint;
 export type CommandArgValues = Record<string, CommandArgValue>;
 
diff --git a/src/auto-reply/envelope.ts b/src/auto-reply/envelope.ts
index fd091cdde..01c0714bd 100644
--- a/src/auto-reply/envelope.ts
+++ b/src/auto-reply/envelope.ts
@@ -20,38 +20,6 @@ export type AgentEnvelopeParams = {
   envelope?: EnvelopeFormatOptions;
 };
 
-export type EnvelopeFormatOptions = {
-  /**
-   * "local" (default), "utc", "user", or an explicit IANA timezone string.
-   */
-  timezone?: string;
-  /**
-   * Include absolute timestamps in the envelope (default: true).
-   */
-  includeTimestamp?: boolean;
-  /**
-   * Include elapsed time suffix when previousTimestamp is provideimport type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveUserTimezone } from "../agents/date-time.js";
-import { normalizeChatType } from "../channels/chat-type.js";
-import { resolveSenderLabel, type SenderLabelParams } from "../channels/sender-label.js";
-import {
-  resolveTimezone,
-  formatUtcTimestamp,
-  formatZonedTimestamp,
-} from "../infra/format-time/format-datetime.ts";
-import { formatTimeAgo } from "../infra/format-time/format-relative.ts";
-
-export type AgentEnvelopeParams = {
-  channel: string;
-  from?: string;
-  timestamp?: number | Date;
-  host?: string;
-  ip?: string;
-  body: string;
-  previousTimestamp?: number | Date;
-  envelope?: EnvelopeFormatOptions;
-};
-
 export type EnvelopeFormatOptions = {
   /**
    * "local" (default), "utc", "user", or an explicit IANA timezone string.
diff --git a/src/auto-reply/inbound-debounce.ts b/src/auto-reply/inbound-debounce.ts
index 608e45b62..517298de1 100644
--- a/src/auto-reply/inbound-debounce.ts
+++ b/src/auto-reply/inbound-debounce.ts
@@ -33,41 +33,6 @@ export function resolveInboundDebounceMs(params: {
   return override ?? byChannel ?? base ?? 0;
 }
 
-type DebounceBufimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { InboundDebounceByProvider } from "../config/types.messages.js";
-
-const resolveMs = (value: unknown): number | undefined => {
-  if (typeof value !== "number" || !Number.isFinite(value)) {
-    return undefined;
-  }
-  return Math.max(0, Math.trunc(value));
-};
-
-const resolveChannelOverride = (params: {
-  byChannel?: InboundDebounceByProvider;
-  channel: string;
-}): number | undefined => {
-  if (!params.byChannel) {
-    return undefined;
-  }
-  return resolveMs(params.byChannel[params.channel]);
-};
-
-export function resolveInboundDebounceMs(params: {
-  cfg: TEXT2LLMConfig;
-  channel: string;
-  overrideMs?: number;
-}): number {
-  const inbound = params.cfg.messages?.inbound;
-  const override = resolveMs(params.overrideMs);
-  const byChannel = resolveChannelOverride({
-    byChannel: inbound?.byChannel,
-    channel: params.channel,
-  });
-  const base = resolveMs(inbound?.debounceMs);
-  return override ?? byChannel ?? base ?? 0;
-}
-
 type DebounceBuffer<T> = {
   items: T[];
   timeout: ReturnType<typeof setTimeout> | null;
diff --git a/src/auto-reply/reply.directive.directive-behavior.accepts-thinking-xhigh-codex-models.e2e.test.ts b/src/auto-reply/reply.directive.directive-behavior.accepts-thinking-xhigh-codex-models.e2e.test.ts
index aa19bca0c..d3a8b155e 100644
--- a/src/auto-reply/reply.directive.directive-behavior.accepts-thinking-xhigh-codex-models.e2e.test.ts
+++ b/src/auto-reply/reply.directive.directive-behavior.accepts-thinking-xhigh-codex-models.e2e.test.ts
@@ -20,30 +20,6 @@ async function writeSkill(params: { workspaceDir: string; name: string; descript
   );
 }
 
-vi.mock("../agents/pi-embedded.js", () => ({
-  abortEmbeddedPiRun: vi.fn().mockReturnValue(false),
-  runEmbimport fs from "node:fs/promises";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import { withTempHome as withTempHomeBase } from "../../test/helpers/temp-home.js";
-import { loadModelCatalog } from "../agents/model-catalog.js";
-import { runEmbeddedPiAgent } from "../agents/pi-embedded.js";
-import { loadSessionStore } from "../config/sessions.js";
-import { getReplyFromConfig } from "./reply.js";
-
-const MAIN_SESSION_KEY = "agent:main:main";
-
-async function writeSkill(params: { workspaceDir: string; name: string; description: string }) {
-  const { workspaceDir, name, description } = params;
-  const skillDir = path.join(workspaceDir, "skills", name);
-  await fs.mkdir(skillDir, { recursive: true });
-  await fs.writeFile(
-    path.join(skillDir, "SKILL.md"),
-    `---\nname: ${name}\ndescription: ${description}\n---\n\n# ${name}\n`,
-    "utf-8",
-  );
-}
-
 vi.mock("../agents/pi-embedded.js", () => ({
   abortEmbeddedPiRun: vi.fn().mockReturnValue(false),
   runEmbeddedPiAgent: vi.fn(),
diff --git a/src/auto-reply/reply/agent-runner-memory.ts b/src/auto-reply/reply/agent-runner-memory.ts
index a1aa323d6..6e6c34fb1 100644
--- a/src/auto-reply/reply/agent-runner-memory.ts
+++ b/src/auto-reply/reply/agent-runner-memory.ts
@@ -17,25 +17,6 @@ import {
 import { logVerbose } from "../../globals.js";
 import { registerAgentRunContext } from "../../infra/agent-events.js";
 import { buildThreadingToolContext, resolveEnforceFinalTag } from "./agent-runner-utils.js";
-import crypto from "node:crypto";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { TemplateContext } from "../templating.js";
-import type { VerboseLevel } from "../thinking.js";
-import type { GetReplyOptions } from "../types.js";
-import type { FollowupRun } from "./queue.js";
-import { resolveAgentModelFallbacksOverride } from "../../agents/agent-scope.js";
-import { runWithModelFallback } from "../../agents/model-fallback.js";
-import { isCliProvider } from "../../agents/model-selection.js";
-import { runEmbeddedPiAgent } from "../../agents/pi-embedded.js";
-import { resolveSandboxConfigForAgent, resolveSandboxRuntimeStatus } from "../../agents/sandbox.js";
-import {
-  resolveAgentIdFromSessionKey,
-  type SessionEntry,
-  updateSessionStoreEntry,
-} from "../../config/sessions.js";
-import { logVerbose } from "../../globals.js";
-import { registerAgentRunContext } from "../../infra/agent-events.js";
-import { buildThreadingToolContext, resolveEnforceFinalTag } from "./agent-runner-utils.js";
 import {
   resolveMemoryFlushContextWindowTokens,
   resolveMemoryFlushSettings,
diff --git a/src/auto-reply/reply/agent-runner-utils.ts b/src/auto-reply/reply/agent-runner-utils.ts
index aa7b98985..5580d51f5 100644
--- a/src/auto-reply/reply/agent-runner-utils.ts
+++ b/src/auto-reply/reply/agent-runner-utils.ts
@@ -11,26 +11,6 @@ import { estimateUsageCost, formatTokenCount, formatUsd } from "../../utils/usag
 
 const BUN_FETCH_SOCKET_ERROR_RE = /socket connection was closed unexpectedly/i;
 
-/**
- * Build provider-specific threading context for tool auto-injection.
- */
-export function buildThreadingToolContext(params: {
-  sessionCtx: TemplateContext;
-  config: TEXT2LLMConfig | undefined;
-  hasRepliedRef: { value: boolean } | undefined;
-}): Channelimport type { NormalizedUsage } from "../../agents/usage.js";
-import type { ChannelId, ChannelThreadingToolContext } from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { TemplateContext } from "../templating.js";
-import type { ReplyPayload } from "../types.js";
-import type { FollowupRun } from "./queue.js";
-import { getChannelDock } from "../../channels/dock.js";
-import { normalizeAnyChannelId, normalizeChannelId } from "../../channels/registry.js";
-import { isReasoningTagProvider } from "../../utils/provider-utils.js";
-import { estimateUsageCost, formatTokenCount, formatUsd } from "../../utils/usage-format.js";
-
-const BUN_FETCH_SOCKET_ERROR_RE = /socket connection was closed unexpectedly/i;
-
 /**
  * Build provider-specific threading context for tool auto-injection.
  */
diff --git a/src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.resets-corrupted-gemini-sessions-deletes-transcripts.test.ts b/src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.resets-corrupted-gemini-sessions-deletes-transcripts.test.ts
index 121100557..16c3e6cf3 100644
--- a/src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.resets-corrupted-gemini-sessions-deletes-transcripts.test.ts
+++ b/src/auto-reply/reply/agent-runner.heartbeat-typing.runreplyagent-typing-heartbeat.resets-corrupted-gemini-sessions-deletes-transcripts.test.ts
@@ -28,38 +28,6 @@ vi.mock("../../agents/model-fallback.js", () => ({
   }),
 }));
 
-vi.mock("../../agents/pi-embedded.js", () => ({
-  queueEmbeddedPiMessage: vi.fn().mockReturnValue(false),
-import fs from "node:fs/promises";
-import { tmpdir } from "node:os";
-import path from "node:path";
-import { describe, expect, it, vi } from "vitest";
-import type { SessionEntry } from "../../config/sessions.js";
-import type { TypingMode } from "../../config/types.js";
-import type { TemplateContext } from "../templating.js";
-import type { GetReplyOptions } from "../types.js";
-import type { FollowupRun, QueueSettings } from "./queue.js";
-import * as sessions from "../../config/sessions.js";
-import { createMockTypingController } from "./test-helpers.js";
-
-const runEmbeddedPiAgentMock = vi.fn();
-
-vi.mock("../../agents/model-fallback.js", () => ({
-  runWithModelFallback: async ({
-    provider,
-    model,
-    run,
-  }: {
-    provider: string;
-    model: string;
-    run: (provider: string, model: string) => Promise<unknown>;
-  }) => ({
-    result: await run(provider, model),
-    provider,
-    model,
-  }),
-}));
-
 vi.mock("../../agents/pi-embedded.js", () => ({
   queueEmbeddedPiMessage: vi.fn().mockReturnValue(false),
   runEmbeddedPiAgent: (params: unknown) => runEmbeddedPiAgentMock(params),
diff --git a/src/auto-reply/reply/commands-allowlist.ts b/src/auto-reply/reply/commands-allowlist.ts
index 69fa31178..6b7492953 100644
--- a/src/auto-reply/reply/commands-allowlist.ts
+++ b/src/auto-reply/reply/commands-allowlist.ts
@@ -19,27 +19,6 @@ import {
   readChannelAllowFromStore,
   removeChannelAllowFromStoreEntry,
 } from "../../pairing/pairing-store.js";
-import { DEFAULT_ACCOUNT_import type { ChannelId } from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { CommandHandler } from "./commands-types.js";
-import { getChannelDock } from "../../channels/dock.js";
-import { resolveChannelConfigWrites } from "../../channels/plugins/config-writes.js";
-import { listPairingChannels } from "../../channels/plugins/pairing.js";
-import { normalizeChannelId } from "../../channels/registry.js";
-import {
-  readConfigFileSnapshot,
-  validateConfigObjectWithPlugins,
-  writeConfigFile,
-} from "../../config/config.js";
-import { resolveDiscordAccount } from "../../discord/accounts.js";
-import { resolveDiscordUserAllowlist } from "../../discord/resolve-users.js";
-import { logVerbose } from "../../globals.js";
-import { resolveIMessageAccount } from "../../imessage/accounts.js";
-import {
-  addChannelAllowFromStoreEntry,
-  readChannelAllowFromStore,
-  removeChannelAllowFromStoreEntry,
-} from "../../pairing/pairing-store.js";
 import { DEFAULT_ACCOUNT_ID, normalizeAccountId } from "../../routing/session-key.js";
 import { resolveSignalAccount } from "../../signal/accounts.js";
 import { resolveSlackAccount } from "../../slack/accounts.js";
diff --git a/src/auto-reply/reply/commands-approve.test.ts b/src/auto-reply/reply/commands-approve.test.ts
index f323db702..3cbfcf24e 100644
--- a/src/auto-reply/reply/commands-approve.test.ts
+++ b/src/auto-reply/reply/commands-approve.test.ts
@@ -9,41 +9,6 @@ vi.mock("../../gateway/call.js", () => ({
   callGateway: vi.fn(),
 }));
 
-function buildParams(commandBody: string, cfg: TEXT2LLMConfig, ctxOverrides?: Partial<MsgContext>) {
-  const ctx = {
-    Body: commandBody,
-    CommandBody: commandBody,
-    CommandSource: "text",
-    CommandAuthorized: true,
-    Provider: "whatsapp",
-    Surface: "whatsapp",
-    ...ctxOverrides,
-  } as MsgContext;
-
-  const command = buildCommandContext({
-    ctx,
-    cfg,
-    isGroup: false,
-    triggerBodyNormalized: commandBody.trim().toLowerCase(),
-    commandAuthorized: true,
-  });
-
-  return {
-    ctx,
-    cfg,
-    command,
-    directives: parseInlineDirectives(commandBody),
-import { beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { MsgContext } from "../templating.js";
-import { callGateway } from "../../gateway/call.js";
-import { buildCommandContext, handleCommands } from "./commands.js";
-import { parseInlineDirectives } from "./directive-handling.js";
-
-vi.mock("../../gateway/call.js", () => ({
-  callGateway: vi.fn(),
-}));
-
 function buildParams(commandBody: string, cfg: TEXT2LLMConfig, ctxOverrides?: Partial<MsgContext>) {
   const ctx = {
     Body: commandBody,
diff --git a/src/auto-reply/reply/commands-models.ts b/src/auto-reply/reply/commands-models.ts
index 1ef6de5f5..3d15eacbc 100644
--- a/src/auto-reply/reply/commands-models.ts
+++ b/src/auto-reply/reply/commands-models.ts
@@ -27,39 +27,6 @@ export type ModelsProviderData = {
   resolvedDefault: { provider: string; model: string };
 };
 
-/**
- * Build provider/model data from config and catalog.
- * Exported for reuse by callback handlers.
- */
-export async function buildModelsProviderDataimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ReplyPayload } from "../types.js";
-import type { CommandHandler } from "./commands-types.js";
-import { DEFAULT_MODEL, DEFAULT_PROVIDER } from "../../agents/defaults.js";
-import { loadModelCatalog } from "../../agents/model-catalog.js";
-import {
-  buildAllowedModelSet,
-  buildModelAliasIndex,
-  normalizeProviderId,
-  resolveConfiguredModelRef,
-  resolveModelRefFromString,
-} from "../../agents/model-selection.js";
-import {
-  buildModelsKeyboard,
-  buildProviderKeyboard,
-  calculateTotalPages,
-  getModelsPageSize,
-  type ProviderInfo,
-} from "../../telegram/model-buttons.js";
-
-const PAGE_SIZE_DEFAULT = 20;
-const PAGE_SIZE_MAX = 100;
-
-export type ModelsProviderData = {
-  byProvider: Map<string, Set<string>>;
-  providers: string[];
-  resolvedDefault: { provider: string; model: string };
-};
-
 /**
  * Build provider/model data from config and catalog.
  * Exported for reuse by callback handlers.
diff --git a/src/auto-reply/reply/commands-policy.test.ts b/src/auto-reply/reply/commands-policy.test.ts
index 6c1ed3680..06230e1b3 100644
--- a/src/auto-reply/reply/commands-policy.test.ts
+++ b/src/auto-reply/reply/commands-policy.test.ts
@@ -19,29 +19,6 @@ vi.mock("../../config/config.js", async () => {
   };
 });
 
-const readChannelAllowFromStoreMock = vi.hoisted(() => vi.fn());
-const addChannelAllowFromStoreEntryMock = vi.hoisted(() => vi.fn());
-const removeChannelAllowFromStoreEimport { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { MsgContext } from "../templating.js";
-import { buildCommandContext, handleCommands } from "./commands.js";
-import { parseInlineDirectives } from "./directive-handling.js";
-
-const readConfigFileSnapshotMock = vi.hoisted(() => vi.fn());
-const validateConfigObjectWithPluginsMock = vi.hoisted(() => vi.fn());
-const writeConfigFileMock = vi.hoisted(() => vi.fn());
-
-vi.mock("../../config/config.js", async () => {
-  const actual =
-    await vi.importActual<typeof import("../../config/config.js")>("../../config/config.js");
-  return {
-    ...actual,
-    readConfigFileSnapshot: readConfigFileSnapshotMock,
-    validateConfigObjectWithPlugins: validateConfigObjectWithPluginsMock,
-    writeConfigFile: writeConfigFileMock,
-  };
-});
-
 const readChannelAllowFromStoreMock = vi.hoisted(() => vi.fn());
 const addChannelAllowFromStoreEntryMock = vi.hoisted(() => vi.fn());
 const removeChannelAllowFromStoreEntryMock = vi.hoisted(() => vi.fn());
diff --git a/src/auto-reply/reply/directive-handling.impl.ts b/src/auto-reply/reply/directive-handling.impl.ts
index 1404c9b4f..9641adc18 100644
--- a/src/auto-reply/reply/directive-handling.impl.ts
+++ b/src/auto-reply/reply/directive-handling.impl.ts
@@ -14,22 +14,6 @@ import { type SessionEntry, updateSessionStore } from "../../config/sessions.js"
 import { enqueueSystemEvent } from "../../infra/system-events.js";
 import { applyVerboseOverride } from "../../sessions/level-overrides.js";
 import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
-import { formatThinkingLevels, formatXHighModelHint, supportsXHighThinking } from "../thinking.import type { ModelAliasIndex } from "../../agents/model-selection.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ExecAsk, ExecHost, ExecSecurity } from "../../infra/exec-approvals.js";
-import type { ReplyPayload } from "../types.js";
-import type { InlineDirectives } from "./directive-handling.parse.js";
-import type { ElevatedLevel, ReasoningLevel, ThinkLevel, VerboseLevel } from "./directives.js";
-import {
-  resolveAgentConfig,
-  resolveAgentDir,
-  resolveSessionAgentId,
-} from "../../agents/agent-scope.js";
-import { resolveSandboxRuntimeStatus } from "../../agents/sandbox.js";
-import { type SessionEntry, updateSessionStore } from "../../config/sessions.js";
-import { enqueueSystemEvent } from "../../infra/system-events.js";
-import { applyVerboseOverride } from "../../sessions/level-overrides.js";
-import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
 import { formatThinkingLevels, formatXHighModelHint, supportsXHighThinking } from "../thinking.js";
 import {
   maybeHandleModelDirectiveInfo,
diff --git a/src/auto-reply/reply/directive-handling.persist.ts b/src/auto-reply/reply/directive-handling.persist.ts
index fb0a698bd..f06dd286c 100644
--- a/src/auto-reply/reply/directive-handling.persist.ts
+++ b/src/auto-reply/reply/directive-handling.persist.ts
@@ -20,28 +20,6 @@ import { enqueueSystemEvent } from "../../infra/system-events.js";
 import { applyVerboseOverride } from "../../sessions/level-overrides.js";
 import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
 import { resolveProfileOverride } from "./directive-handling.auth.js";
-import { formatElevatedEimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { InlineDirectives } from "./directive-handling.parse.js";
-import type { ElevatedLevel, ReasoningLevel } from "./directives.js";
-import {
-  resolveAgentDir,
-  resolveDefaultAgentId,
-  resolveSessionAgentId,
-} from "../../agents/agent-scope.js";
-import { lookupContextTokens } from "../../agents/context.js";
-import { DEFAULT_CONTEXT_TOKENS } from "../../agents/defaults.js";
-import {
-  buildModelAliasIndex,
-  type ModelAliasIndex,
-  modelKey,
-  resolveDefaultModelForAgent,
-  resolveModelRefFromString,
-} from "../../agents/model-selection.js";
-import { type SessionEntry, updateSessionStore } from "../../config/sessions.js";
-import { enqueueSystemEvent } from "../../infra/system-events.js";
-import { applyVerboseOverride } from "../../sessions/level-overrides.js";
-import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
-import { resolveProfileOverride } from "./directive-handling.auth.js";
 import { formatElevatedEvent, formatReasoningEvent } from "./directive-handling.shared.js";
 
 export async function persistInlineDirectives(params: {
diff --git a/src/auto-reply/reply/dispatch-from-config.ts b/src/auto-reply/reply/dispatch-from-config.ts
index d666bf3db..69402e248 100644
--- a/src/auto-reply/reply/dispatch-from-config.ts
+++ b/src/auto-reply/reply/dispatch-from-config.ts
@@ -16,24 +16,6 @@ import { maybeApplyTtsToPayload, normalizeTtsAutoMode, resolveTtsConfig } from "
 import { getReplyFromConfig } from "../reply.js";
 import { formatAbortReplyText, tryFastAbortFromMessage } from "./abort.js";
 import { shouldSkipDuplicateInbound } from "./inbound-dedupe.js";
-imporimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { FinalizedMsgContext } from "../templating.js";
-import type { GetReplyOptions, ReplyPayload } from "../types.js";
-import type { ReplyDispatcher, ReplyDispatchKind } from "./reply-dispatcher.js";
-import { resolveSessionAgentId } from "../../agents/agent-scope.js";
-import { loadSessionStore, resolveStorePath } from "../../config/sessions.js";
-import { logVerbose } from "../../globals.js";
-import { isDiagnosticsEnabled } from "../../infra/diagnostic-events.js";
-import {
-  logMessageProcessed,
-  logMessageQueued,
-  logSessionStateChange,
-} from "../../logging/diagnostic.js";
-import { getGlobalHookRunner } from "../../plugins/hook-runner-global.js";
-import { maybeApplyTtsToPayload, normalizeTtsAutoMode, resolveTtsConfig } from "../../tts/tts.js";
-import { getReplyFromConfig } from "../reply.js";
-import { formatAbortReplyText, tryFastAbortFromMessage } from "./abort.js";
-import { shouldSkipDuplicateInbound } from "./inbound-dedupe.js";
 import { isRoutableChannel, routeReply } from "./route-reply.js";
 
 const AUDIO_PLACEHOLDER_RE = /^<media:audio>(\s*\([^)]*\))?$/i;
diff --git a/src/auto-reply/reply/memory-flush.ts b/src/auto-reply/reply/memory-flush.ts
index 94e5a802e..93ba19be6 100644
--- a/src/auto-reply/reply/memory-flush.ts
+++ b/src/auto-reply/reply/memory-flush.ts
@@ -14,25 +14,6 @@ export const DEFAULT_MEMORY_FLUSH_PROMPT = [
   `If nothing to store, reply with ${SILENT_REPLY_TOKEN}.`,
 ].join(" ");
 
-export const DEFAULT_MEMORY_FLUSH_SYSTEM_PROMPT = [
-  "Pre-compaction memory flush turn.",
-  "The session is near auto-compaction; capture durable memories to disk.",
-  `You may reply, but usuallimport type { TEXT2LLMConfig } from "../../config/config.js";
-import { lookupContextTokens } from "../../agents/context.js";
-import { DEFAULT_CONTEXT_TOKENS } from "../../agents/defaults.js";
-import { DEFAULT_PI_COMPACTION_RESERVE_TOKENS_FLOOR } from "../../agents/pi-settings.js";
-import { resolveFreshSessionTotalTokens, type SessionEntry } from "../../config/sessions.js";
-import { SILENT_REPLY_TOKEN } from "../tokens.js";
-
-export const DEFAULT_MEMORY_FLUSH_SOFT_TOKENS = 4000;
-
-export const DEFAULT_MEMORY_FLUSH_PROMPT = [
-  "Pre-compaction memory flush.",
-  "Store durable memories now (use memory/YYYY-MM-DD.md; create memory/ if needed).",
-  "IMPORTANT: If the file already exists, APPEND new content only and do not overwrite existing entries.",
-  `If nothing to store, reply with ${SILENT_REPLY_TOKEN}.`,
-].join(" ");
-
 export const DEFAULT_MEMORY_FLUSH_SYSTEM_PROMPT = [
   "Pre-compaction memory flush turn.",
   "The session is near auto-compaction; capture durable memories to disk.",
diff --git a/src/auto-reply/reply/model-selection.inherit-parent.test.ts b/src/auto-reply/reply/model-selection.inherit-parent.test.ts
index cd79d3974..a96f619c7 100644
--- a/src/auto-reply/reply/model-selection.inherit-parent.test.ts
+++ b/src/auto-reply/reply/model-selection.inherit-parent.test.ts
@@ -19,37 +19,6 @@ const makeEntry = (overrides: Record<string, unknown> = {}) => ({
   ...overrides,
 });
 
-async function resolveState(params: {
-  cfg: TEXT2LLMConfig;
-  sessionEntry: ReturnType<typeof makeEntry>;
-  sessionStore: Record<string, ReturnType<typeof makeEntry>>;
-  sessionKey: string;
-  parentSessionKey?: string;
-}) {
-  return createModelSelectionState({
-    cfg: params.cfg,
-    agentCfg: params.cfg.agents?.defaults,
- import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { createModelSelectionState } from "./model-selection.js";
-
-vi.mock("../../agents/model-catalog.js", () => ({
-  loadModelCatalog: vi.fn(async () => [
-    { provider: "openai", id: "gpt-4o-mini", name: "GPT-4o mini" },
-    { provider: "openai", id: "gpt-4o", name: "GPT-4o" },
-    { provider: "anthropic", id: "claude-opus-4-5", name: "Claude Opus 4.5" },
-  ]),
-}));
-
-const defaultProvider = "openai";
-const defaultModel = "gpt-4o-mini";
-
-const makeEntry = (overrides: Record<string, unknown> = {}) => ({
-  sessionId: "session-id",
-  updatedAt: Date.now(),
-  ...overrides,
-});
-
 async function resolveState(params: {
   cfg: TEXT2LLMConfig;
   sessionEntry: ReturnType<typeof makeEntry>;
diff --git a/src/auto-reply/reply/model-selection.override-respected.test.ts b/src/auto-reply/reply/model-selection.override-respected.test.ts
index aec2cd7ce..3ddb5609b 100644
--- a/src/auto-reply/reply/model-selection.override-respected.test.ts
+++ b/src/auto-reply/reply/model-selection.override-respected.test.ts
@@ -19,33 +19,6 @@ const makeEntry = (overrides: Record<string, unknown> = {}) => ({
   ...overrides,
 });
 
-describe("createModelSelectionState respects session model override", () => {
-  it("applies session modelOverride when set", async () => {
-    const cfg = {} as TEXT2LLMConfig;
-    const sessionKey = "agent:main:main";
-    const sessionEntry = makeEntry({
-      providerOverride: "kimi-coding",
-import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { createModelSelectionState } from "./model-selection.js";
-
-vi.mock("../../agents/model-catalog.js", () => ({
-  loadModelCatalog: vi.fn(async () => [
-    { provider: "inferencer", id: "deepseek-v3-4bit-mlx", name: "DeepSeek V3" },
-    { provider: "kimi-coding", id: "k2p5", name: "Kimi K2.5" },
-    { provider: "anthropic", id: "claude-opus-4-5", name: "Claude Opus 4.5" },
-  ]),
-}));
-
-const defaultProvider = "inferencer";
-const defaultModel = "deepseek-v3-4bit-mlx";
-
-const makeEntry = (overrides: Record<string, unknown> = {}) => ({
-  sessionId: "session-id",
-  updatedAt: Date.now(),
-  ...overrides,
-});
-
 describe("createModelSelectionState respects session model override", () => {
   it("applies session modelOverride when set", async () => {
     const cfg = {} as TEXT2LLMConfig;
diff --git a/src/auto-reply/reply/model-selection.ts b/src/auto-reply/reply/model-selection.ts
index 2fcd76562..6152d6de5 100644
--- a/src/auto-reply/reply/model-selection.ts
+++ b/src/auto-reply/reply/model-selection.ts
@@ -23,31 +23,6 @@ export type ModelDirectiveSelection = {
   alias?: string;
 };
 
-type ModelCatalog = Awaited<ReturnType<typeof loadModimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ThinkLevel } from "./directives.js";
-import { clearSessionAuthProfileOverride } from "../../agents/auth-profiles/session-override.js";
-import { lookupContextTokens } from "../../agents/context.js";
-import { DEFAULT_CONTEXT_TOKENS } from "../../agents/defaults.js";
-import { loadModelCatalog } from "../../agents/model-catalog.js";
-import {
-  buildAllowedModelSet,
-  type ModelAliasIndex,
-  modelKey,
-  normalizeProviderId,
-  resolveModelRefFromString,
-  resolveThinkingDefault,
-} from "../../agents/model-selection.js";
-import { type SessionEntry, updateSessionStore } from "../../config/sessions.js";
-import { applyModelOverrideToSessionEntry } from "../../sessions/model-overrides.js";
-import { resolveThreadParentSessionKey } from "../../sessions/session-key-utils.js";
-
-export type ModelDirectiveSelection = {
-  provider: string;
-  model: string;
-  isDefault: boolean;
-  alias?: string;
-};
-
 type ModelCatalog = Awaited<ReturnType<typeof loadModelCatalog>>;
 
 type ModelSelectionState = {
diff --git a/src/auto-reply/reply/session.test.ts b/src/auto-reply/reply/session.test.ts
index 4f79d2094..03659dd00 100644
--- a/src/auto-reply/reply/session.test.ts
+++ b/src/auto-reply/reply/session.test.ts
@@ -6,33 +6,6 @@ import type { TEXT2LLMConfig } from "../../config/config.js";
 import { saveSessionStore } from "../../config/sessions.js";
 import { initSessionState } from "./session.js";
 
-describe("initSessionState thread forking", () => {
-  it("forks a new session from the parent session file", async () => {
-    const root = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-thread-session-"));
-    const sessionsDir = path.join(root, "sessions");
-    await fs.mkdir(sessionsDir, { recursive: true });
-
-    const parentSessionId = "parent-session";
-    const parentSessionFile = path.join(sessionsDir, "parent.jsonl");
-    const header = {
-      type: "session",
-      version: 3,
-      id: parentSessionId,
-      timestamp: new Date().toISOString(),
-      cwd: process.cwd(),
-    };
-    const message = {
-      type: "message",
-      id: "m1",
-      parentId: null,
-      timestamp: new Date()import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { saveSessionStore } from "../../config/sessions.js";
-import { initSessionState } from "./session.js";
-
 describe("initSessionState thread forking", () => {
   it("forks a new session from the parent session file", async () => {
     const root = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-thread-session-"));
diff --git a/src/browser/chrome.test.ts b/src/browser/chrome.test.ts
index a316e553a..8fcbc3137 100644
--- a/src/browser/chrome.test.ts
+++ b/src/browser/chrome.test.ts
@@ -22,39 +22,6 @@ async function readJson(filePath: string): Promise<Record<string, unknown>> {
   return JSON.parse(raw) as Record<string, unknown>;
 }
 
-describe("browser chrome profile decoration", () => {
-  afterEach(() => {
-    vi.unstubAllGlobals();
-    vi.restoreAllMocks();
-  });
-
-  it("writes expected name + signed ARGB seed to Chrome prefs", async () => {
-    const userDataDir = await fsp.mkdtemp(path.join(os.tmpdir(), "text2llm-chrome-test-"));
-    try {
-      decimport fs from "node:fs";
-import fsp from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, describe, expect, it, vi } from "vitest";
-import {
-  decorateTEXT2LLMProfile,
-  ensureProfileCleanExit,
-  findChromeExecutableMac,
-  findChromeExecutableWindows,
-  isChromeReachable,
-  resolveBrowserExecutableForPlatform,
-  stopTEXT2LLMChrome,
-} from "./chrome.js";
-import {
-  DEFAULT_TEXT2LLM_BROWSER_COLOR,
-  DEFAULT_TEXT2LLM_BROWSER_PROFILE_NAME,
-} from "./constants.js";
-
-async function readJson(filePath: string): Promise<Record<string, unknown>> {
-  const raw = await fsp.readFile(filePath, "utf-8");
-  return JSON.parse(raw) as Record<string, unknown>;
-}
-
 describe("browser chrome profile decoration", () => {
   afterEach(() => {
     vi.unstubAllGlobals();
diff --git a/src/browser/pw-tools-core.downloads.ts b/src/browser/pw-tools-core.downloads.ts
index 7e9e254fc..c062843c4 100644
--- a/src/browser/pw-tools-core.downloads.ts
+++ b/src/browser/pw-tools-core.downloads.ts
@@ -24,41 +24,6 @@ function buildTempDownloadPath(fileName: string): string {
   return path.join(resolvePreferredTEXT2LLMTmpDir(), "downloads", `${id}-${safeName}`);
 }
 
-function createPageDownloadWaiter(page: Page, timeoutMs: number) {
-  let done = false;
-  let timer: NodeJS.Timeout | undefined;
-  let handler: ((download: unknown) => void) | undefined;
-
-  const cleanup = () => {
-    if (timer) {
-      clearTimeout(timer);
-    }
-   import type { Page } from "playwright-core";
-import crypto from "node:crypto";
-import fs from "node:fs/promises";
-import path from "node:path";
-import { resolvePreferredTEXT2LLMTmpDir } from "../infra/tmp-text2llm-dir.js";
-import {
-  ensurePageState,
-  getPageForTargetId,
-  refLocator,
-  restoreRoleRefsForTarget,
-} from "./pw-session.js";
-import {
-  bumpDialogArmId,
-  bumpDownloadArmId,
-  bumpUploadArmId,
-  normalizeTimeoutMs,
-  requireRef,
-  toAIFriendlyError,
-} from "./pw-tools-core.shared.js";
-
-function buildTempDownloadPath(fileName: string): string {
-  const id = crypto.randomUUID();
-  const safeName = fileName.trim() ? fileName.trim() : "download.bin";
-  return path.join(resolvePreferredTEXT2LLMTmpDir(), "downloads", `${id}-${safeName}`);
-}
-
 function createPageDownloadWaiter(page: Page, timeoutMs: number) {
   let done = false;
   let timer: NodeJS.Timeout | undefined;
diff --git a/src/browser/routes/agent.debug.ts b/src/browser/routes/agent.debug.ts
index 384c1c696..52907b64a 100644
--- a/src/browser/routes/agent.debug.ts
+++ b/src/browser/routes/agent.debug.ts
@@ -9,30 +9,6 @@ import { toBoolean, toStringOrEmpty } from "./utils.js";
 
 const DEFAULT_TRACE_DIR = resolvePreferredTEXT2LLMTmpDir();
 
-export function registerBrowserAgentDebugRoutes(
-  app: BrowserRouteRegistrar,
-  ctx: BrowserRouteContext,
-) {
-  app.get("/console", async (req, res) => {
-    const profileCtx = resolveProfileContext(req, res, ctx);
-    if (!profileCtx) {
-      return;
-    }
-    const targetId = typeof req.query.targetId === "string" ? req.query.targetId.trim() : "";
-    const level = typeof req.query.level === "string" ? req.query.level : "";
-
-    try {
-      const tab = await profileCtx.ensureTabAvailable(targetimport crypto from "node:crypto";
-import fs from "node:fs/promises";
-import path from "node:path";
-import type { BrowserRouteContext } from "../server-context.js";
-import type { BrowserRouteRegistrar } from "./types.js";
-import { resolvePreferredTEXT2LLMTmpDir } from "../../infra/tmp-text2llm-dir.js";
-import { handleRouteError, readBody, requirePwAi, resolveProfileContext } from "./agent.shared.js";
-import { toBoolean, toStringOrEmpty } from "./utils.js";
-
-const DEFAULT_TRACE_DIR = resolvePreferredTEXT2LLMTmpDir();
-
 export function registerBrowserAgentDebugRoutes(
   app: BrowserRouteRegistrar,
   ctx: BrowserRouteContext,
diff --git a/src/canvas-host/server.state-dir.test.ts b/src/canvas-host/server.state-dir.test.ts
index 1baeeae8e..cc98f1e95 100644
--- a/src/canvas-host/server.state-dir.test.ts
+++ b/src/canvas-host/server.state-dir.test.ts
@@ -9,38 +9,6 @@ import {
   snapshotStateDirEnv,
 } from "../test-helpers/state-dir-env.js";
 
-describe("canvas host state dir defaults", () => {
-  let envSnapshot: ReturnType<typeof snapshotStateDirEnv>;
-
-  beforeEach(() => {
-    envSnapshot = snapshotStateDirEnv();
-  });
-
-  afterEach(() => {
-    vi.resetModules();
-    restoreStateDirEnv(envSnapshot);
-  });
-
-  it("uses TEXT2LLM_STATE_DIR for the default canvas root", async () => {
-    const tempRoot = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-canvas-state-"));
-    const stateDir = path.join(tempRoot, "state");
-    setStateDirEnv(stateDir);
-    vi.resetModules();
-
-    const { createCanvasHostHandler } = await import("./server.js");
-    const handler = await createCanvasHostHandler({
-      runtime: defaultRuntime,
-      alimport fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import { defaultRuntime } from "../runtime.js";
-import {
-  restoreStateDirEnv,
-  setStateDirEnv,
-  snapshotStateDirEnv,
-} from "../test-helpers/state-dir-env.js";
-
 describe("canvas host state dir defaults", () => {
   let envSnapshot: ReturnType<typeof snapshotStateDirEnv>;
 
diff --git a/src/channels/plugins/actions/signal.test.ts b/src/channels/plugins/actions/signal.test.ts
index 46aa10a60..a1643244b 100644
--- a/src/channels/plugins/actions/signal.test.ts
+++ b/src/channels/plugins/actions/signal.test.ts
@@ -10,31 +10,6 @@ vi.mock("../../../signal/send-reactions.js", () => ({
   removeReactionSignal: (...args: unknown[]) => removeReactionSignal(...args),
 }));
 
-describe("signalMessageActions", () => {
-  it("returns no actions when no configured accounts exist", () => {
-    const cfg = {} as TEXT2LLMConfig;
-    expect(signalMessageActions.listActions({ cfg })).toEqual([]);
-  });
-
-  it("hides react when reactions are disabled", () => {
-    const cfg = {
-      channels: { signal: { account: "+15550001111", actions: { reactions: false } } },
-    } as TEXT2LLMConfig;
-    expect(signalMessageActions.listActions({ cfg })).toEqual(["send"]);
-  });
-
-  it("enables react when import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../../config/config.js";
-import { signalMessageActions } from "./signal.js";
-
-const sendReactionSignal = vi.fn(async () => ({ ok: true }));
-const removeReactionSignal = vi.fn(async () => ({ ok: true }));
-
-vi.mock("../../../signal/send-reactions.js", () => ({
-  sendReactionSignal: (...args: unknown[]) => sendReactionSignal(...args),
-  removeReactionSignal: (...args: unknown[]) => removeReactionSignal(...args),
-}));
-
 describe("signalMessageActions", () => {
   it("returns no actions when no configured accounts exist", () => {
     const cfg = {} as TEXT2LLMConfig;
diff --git a/src/channels/plugins/catalog.ts b/src/channels/plugins/catalog.ts
index 2887b4462..198307d10 100644
--- a/src/channels/plugins/catalog.ts
+++ b/src/channels/plugins/catalog.ts
@@ -33,42 +33,6 @@ export type ChannelPluginCatalogEntry = {
   };
 };
 
-type CatalogOptions = {
-  workspaceDirimport fs from "node:fs";
-import path from "node:path";
-import type { TEXT2LLMPackageManifest } from "../../plugins/manifest.js";
-import type { PluginOrigin } from "../../plugins/types.js";
-import type { ChannelMeta } from "./types.js";
-import { MANIFEST_KEY } from "../../compat/legacy-names.js";
-import { discoverTEXT2LLMPlugins } from "../../plugins/discovery.js";
-import { CONFIG_DIR, isRecord, resolveUserPath } from "../../utils.js";
-
-export type ChannelUiMetaEntry = {
-  id: string;
-  label: string;
-  detailLabel: string;
-  systemImage?: string;
-};
-
-export type ChannelUiCatalog = {
-  entries: ChannelUiMetaEntry[];
-  order: string[];
-  labels: Record<string, string>;
-  detailLabels: Record<string, string>;
-  systemImages: Record<string, string>;
-  byId: Record<string, ChannelUiMetaEntry>;
-};
-
-export type ChannelPluginCatalogEntry = {
-  id: string;
-  meta: ChannelMeta;
-  install: {
-    npmSpec: string;
-    localPath?: string;
-    defaultChoice?: "npm" | "local";
-  };
-};
-
 type CatalogOptions = {
   workspaceDir?: string;
   catalogPaths?: string[];
diff --git a/src/channels/plugins/config-writes.ts b/src/channels/plugins/config-writes.ts
index 960a7e5fc..265c35012 100644
--- a/src/channels/plugins/config-writes.ts
+++ b/src/channels/plugins/config-writes.ts
@@ -20,37 +20,6 @@ function resolveAccountConfig(accounts: ChannelConfigWithAccounts["accounts"], a
   return matchKey ? accounts[matchKey] : undefined;
 }
 
-export function resolveChannelConfigWrites(params: {
-  cfg: TEXT2LLMConfig;
-  channelId?: ChannelId | null;
-  accountId?: string | null;
-}): boolean {
-  if (!params.channelId) {
-    return true;
-  }
-  const channels = params.cfg.channels as Record<string, ChannelConfigWithAccounts> | undefined;
-  const channelConfiimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ChannelId } from "./types.js";
-import { normalizeAccountId } from "../../routing/session-key.js";
-
-type ChannelConfigWithAccounts = {
-  configWrites?: boolean;
-  accounts?: Record<string, { configWrites?: boolean }>;
-};
-
-function resolveAccountConfig(accounts: ChannelConfigWithAccounts["accounts"], accountId: string) {
-  if (!accounts || typeof accounts !== "object") {
-    return undefined;
-  }
-  if (accountId in accounts) {
-    return accounts[accountId];
-  }
-  const matchKey = Object.keys(accounts).find(
-    (key) => key.toLowerCase() === accountId.toLowerCase(),
-  );
-  return matchKey ? accounts[matchKey] : undefined;
-}
-
 export function resolveChannelConfigWrites(params: {
   cfg: TEXT2LLMConfig;
   channelId?: ChannelId | null;
diff --git a/src/channels/plugins/media-limits.ts b/src/channels/plugins/media-limits.ts
index 758914f89..c30690dd3 100644
--- a/src/channels/plugins/media-limits.ts
+++ b/src/channels/plugins/media-limits.ts
@@ -23,28 +23,3 @@ export function resolveChannelMediaMaxBytes(params: {
   }
   return undefined;
 }
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { normalizeAccountId } from "../../routing/session-key.js";
-
-const MB = 1024 * 1024;
-
-export function resolveChannelMediaMaxBytes(params: {
-  cfg: TEXT2LLMConfig;
-  // Channel-specific config lives under different keys; keep this helper generic
-  // so shared plugin helpers don't need channel-id branching.
-  resolveChannelLimitMb: (params: { cfg: TEXT2LLMConfig; accountId: string }) => number | undefined;
-  accountId?: string | null;
-}): number | undefined {
-  const accountId = normalizeAccountId(params.accountId);
-  const channelLimit = params.resolveChannelLimitMb({
-    cfg: params.cfg,
-    accountId,
-  });
-  if (channelLimit) {
-    return channelLimit * MB;
-  }
-  if (params.cfg.agents?.defaults?.mediaMaxMb) {
-    return params.cfg.agents.defaults.mediaMaxMb * MB;
-  }
-  return undefined;
-}
diff --git a/src/channels/plugins/message-actions.ts b/src/channels/plugins/message-actions.ts
index 1d74a7c8c..aac9bffca 100644
--- a/src/channels/plugins/message-actions.ts
+++ b/src/channels/plugins/message-actions.ts
@@ -26,35 +26,6 @@ export function supportsChannelMessageButtons(cfg: TEXT2LLMConfig): boolean {
   return false;
 }
 
-export function supportsChannelMessageCards(cfg: TEXT2LLMConfig): boolean {
-  for (const pluginimport type { AgentToolResult } from "@mariozechner/pi-agent-core";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ChannelMessageActionContext, ChannelMessageActionName } from "./types.js";
-import { getChannelPlugin, listChannelPlugins } from "./index.js";
-
-export function listChannelMessageActions(cfg: TEXT2LLMConfig): ChannelMessageActionName[] {
-  const actions = new Set<ChannelMessageActionName>(["send", "broadcast"]);
-  for (const plugin of listChannelPlugins()) {
-    const list = plugin.actions?.listActions?.({ cfg });
-    if (!list) {
-      continue;
-    }
-    for (const action of list) {
-      actions.add(action);
-    }
-  }
-  return Array.from(actions);
-}
-
-export function supportsChannelMessageButtons(cfg: TEXT2LLMConfig): boolean {
-  for (const plugin of listChannelPlugins()) {
-    if (plugin.actions?.supportsButtons?.({ cfg })) {
-      return true;
-    }
-  }
-  return false;
-}
-
 export function supportsChannelMessageCards(cfg: TEXT2LLMConfig): boolean {
   for (const plugin of listChannelPlugins()) {
     if (plugin.actions?.supportsCards?.({ cfg })) {
diff --git a/src/channels/plugins/onboarding/imessage.ts b/src/channels/plugins/onboarding/imessage.ts
index 15b2bea77..999594582 100644
--- a/src/channels/plugins/onboarding/imessage.ts
+++ b/src/channels/plugins/onboarding/imessage.ts
@@ -15,27 +15,6 @@ import { addWildcardAllowFrom, promptAccountId } from "./helpers.js";
 
 const channel = "imessage" as const;
 
-function setIMessageDmPolicy(cfg: TEXT2LLMConfig, dmPolicy: DmPolicy) {
-  const allowFrom =
-    dmPolicy === "open" ? addWildcardAllowFrom(cfg.channels?.imessage?.allowFrom) : undefined;
-  return {
- import type { TEXT2LLMConfig } from "../../../config/config.js";
-import type { DmPolicy } from "../../../config/types.js";
-import type { WizardPrompter } from "../../../wizard/prompts.js";
-import type { ChannelOnboardingAdapter, ChannelOnboardingDmPolicy } from "../onboarding-types.js";
-import { detectBinary } from "../../../commands/onboard-helpers.js";
-import {
-  listIMessageAccountIds,
-  resolveDefaultIMessageAccountId,
-  resolveIMessageAccount,
-} from "../../../imessage/accounts.js";
-import { normalizeIMessageHandle } from "../../../imessage/targets.js";
-import { DEFAULT_ACCOUNT_ID, normalizeAccountId } from "../../../routing/session-key.js";
-import { formatDocsLink } from "../../../terminal/links.js";
-import { addWildcardAllowFrom, promptAccountId } from "./helpers.js";
-
-const channel = "imessage" as const;
-
 function setIMessageDmPolicy(cfg: TEXT2LLMConfig, dmPolicy: DmPolicy) {
   const allowFrom =
     dmPolicy === "open" ? addWildcardAllowFrom(cfg.channels?.imessage?.allowFrom) : undefined;
diff --git a/src/channels/plugins/outbound/telegram.test.ts b/src/channels/plugins/outbound/telegram.test.ts
index fbcbbb80f..c68ae3c43 100644
--- a/src/channels/plugins/outbound/telegram.test.ts
+++ b/src/channels/plugins/outbound/telegram.test.ts
@@ -2,38 +2,6 @@ import { describe, expect, it, vi } from "vitest";
 import type { TEXT2LLMConfig } from "../../../config/config.js";
 import { telegramOutbound } from "./telegram.js";
 
-describe("telegramOutbound.sendPayload", () => {
-  it("sends text payload with buttons", async () => {
-    const sendTelegram = vi.fn(async () => ({ messageId: "m1", chatId: "c1" }));
-
-    const result = await telegramOutbound.sendPayload?.({
-      cfg: {} as TEXT2LLMConfig,
-      to: "telegram:123",
-      text: "ignored",
-      payload: {
-        text: "Hello",
-        channelData: {
-          telegram: {
-            buttons: [[{ text: "Option", callback_data: "/option" }]],
-          },
-        },
-      },
-      deps: { sendTelegram },
-    });
-
-    expect(sendTelegram).toHaveBeenCalledTimes(1);
-    expect(sendTelegram).toHaveBeenCalledWith(
-      "telegram:123",
-      "Hello",
-      expect.objectContaining({
-        buttons: [[{ text: "Option", callback_data: "/option" }]],
-        textMode: "html",
-      }),
-    );
-    expect(result).toEqual(import { describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../../config/config.js";
-import { telegramOutbound } from "./telegram.js";
-
 describe("telegramOutbound.sendPayload", () => {
   it("sends text payload with buttons", async () => {
     const sendTelegram = vi.fn(async () => ({ messageId: "m1", chatId: "c1" }));
diff --git a/src/channels/plugins/setup-helpers.ts b/src/channels/plugins/setup-helpers.ts
index 996b5bd00..cdb680dcc 100644
--- a/src/channels/plugins/setup-helpers.ts
+++ b/src/channels/plugins/setup-helpers.ts
@@ -27,38 +27,6 @@ function shouldStoreNameInAccounts(params: {
   return channelHasAccounts(params.cfg, params.channelKey);
 }
 
-export function applyAccountNameToChannelSection(params: {
-  cfg: TEXT2LLMConfig;
-  channelKey: string;
-  accountId: string;import type { TEXT2LLMConfig } from "../../config/config.js";
-import { DEFAULT_ACCOUNT_ID, normalizeAccountId } from "../../routing/session-key.js";
-
-type ChannelSectionBase = {
-  name?: string;
-  accounts?: Record<string, Record<string, unknown>>;
-};
-
-function channelHasAccounts(cfg: TEXT2LLMConfig, channelKey: string): boolean {
-  const channels = cfg.channels as Record<string, unknown> | undefined;
-  const base = channels?.[channelKey] as ChannelSectionBase | undefined;
-  return Boolean(base?.accounts && Object.keys(base.accounts).length > 0);
-}
-
-function shouldStoreNameInAccounts(params: {
-  cfg: TEXT2LLMConfig;
-  channelKey: string;
-  accountId: string;
-  alwaysUseAccounts?: boolean;
-}): boolean {
-  if (params.alwaysUseAccounts) {
-    return true;
-  }
-  if (params.accountId !== DEFAULT_ACCOUNT_ID) {
-    return true;
-  }
-  return channelHasAccounts(params.cfg, params.channelKey);
-}
-
 export function applyAccountNameToChannelSection(params: {
   cfg: TEXT2LLMConfig;
   channelKey: string;
diff --git a/src/channels/plugins/status.ts b/src/channels/plugins/status.ts
index 740642898..bc02decbd 100644
--- a/src/channels/plugins/status.ts
+++ b/src/channels/plugins/status.ts
@@ -1,32 +1,6 @@
 import type { TEXT2LLMConfig } from "../../config/config.js";
 import type { ChannelAccountSnapshot, ChannelPlugin } from "./types.js";
 
-// Channel docking: status snapshots flow through plugin.status hooks here.
-export async function buildChannelAccountSnapshot<ResolvedAccount>(params: {
-  plugin: ChannelPlugin<ResolvedAccount>;
-  cfg: TEXT2LLMConfig;
-  accountId: string;
-  runtime?: ChannelAccountSnapshot;
-  probe?: unknown;
-  audit?: unknown;
-}): Promise<ChannelAccountSnapshot> {
-  const account = params.plugin.config.resolveAccount(params.cfg, params.accountId);
-  if (params.plugin.status?.buildAccountSnapshot) {
-    return await params.plugin.status.buildAccountSnapshot({
-      account,
-      cfg: params.cfg,
-      runtime: params.runtime,
-      probe: params.probe,
-      audit: params.audit,
-    });
-  }
-  const enabled = params.plugin.config.isEnabled
-    ? params.plugin.config.isEnabled(account, params.cfg)
-    : account && typeof account === "object"
-      ? (account as { enabled?: boolean }).enabled
- import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ChannelAccountSnapshot, ChannelPlugin } from "./types.js";
-
 // Channel docking: status snapshots flow through plugin.status hooks here.
 export async function buildChannelAccountSnapshot<ResolvedAccount>(params: {
   plugin: ChannelPlugin<ResolvedAccount>;
diff --git a/src/channels/plugins/whatsapp-heartbeat.ts b/src/channels/plugins/whatsapp-heartbeat.ts
index cc79b285b..dcac1ba98 100644
--- a/src/channels/plugins/whatsapp-heartbeat.ts
+++ b/src/channels/plugins/whatsapp-heartbeat.ts
@@ -6,29 +6,6 @@ import { normalizeChatChannelId } from "../registry.js";
 type HeartbeatRecipientsResult = { recipients: string[]; source: string };
 type HeartbeatRecipientsOpts = { to?: string; all?: boolean };
 
-function getSessionRecipients(cfg: TEXT2LLMConfig) {
-  const sessionCfg = cfg.session;
-  const scope = sessionCfg?.scope ?? "per-sender";
-  if (scope === "global") {
-    return [];
-  }
-  const storePath = resolveStorePath(cfg.session?.store);
-  const store = loadSessionStore(storePath);
-  const isGroupKey = (key: string) =>
-    key.includes(":group:") || key.includes(":channel:") || key.includes("@g.us");
-  const isCronKey = (key: string) => key.startsWith("cron:");
-
-  const recipients = Object.entries(store)
-    .filter(([key]) => key !== "global" && key !== "unknown")
-    .filter(([key]) => !isGroupKey(key) && !isCronKey(key))
- import type { TEXT2LLMConfig } from "../../config/config.js";
-import { loadSessionStore, resolveStorePath } from "../../config/sessions.js";
-import { normalizeE164 } from "../../utils.js";
-import { normalizeChatChannelId } from "../registry.js";
-
-type HeartbeatRecipientsResult = { recipients: string[]; source: string };
-type HeartbeatRecipientsOpts = { to?: string; all?: boolean };
-
 function getSessionRecipients(cfg: TEXT2LLMConfig) {
   const sessionCfg = cfg.session;
   const scope = sessionCfg?.scope ?? "per-sender";
diff --git a/src/channels/reply-prefix.ts b/src/channels/reply-prefix.ts
index 6122bdd98..c11c9c144 100644
--- a/src/channels/reply-prefix.ts
+++ b/src/channels/reply-prefix.ts
@@ -20,35 +20,6 @@ export type ReplyPrefixOptions = Pick<
   "responsePrefix" | "responsePrefixContextProvider" | "onModelSelected"
 >;
 
-export function createReplyPrefixContext(params: {
-  cfg: TEXT2LLMConfig;
-  agentId: string;
-  channel?: string;
-  accountId?: string;
-}): ReplyPrefixContextBundle {
-  const { cfg, agentId } = params;
-  const prefixCoimport type { GetReplyOptions } from "../auto-reply/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveEffectiveMessagesConfig, resolveIdentityName } from "../agents/identity.js";
-import {
-  extractShortModelName,
-  type ResponsePrefixContext,
-} from "../auto-reply/reply/response-prefix-template.js";
-
-type ModelSelectionContext = Parameters<NonNullable<GetReplyOptions["onModelSelected"]>>[0];
-
-export type ReplyPrefixContextBundle = {
-  prefixContext: ResponsePrefixContext;
-  responsePrefix?: string;
-  responsePrefixContextProvider: () => ResponsePrefixContext;
-  onModelSelected: (ctx: ModelSelectionContext) => void;
-};
-
-export type ReplyPrefixOptions = Pick<
-  ReplyPrefixContextBundle,
-  "responsePrefix" | "responsePrefixContextProvider" | "onModelSelected"
->;
-
 export function createReplyPrefixContext(params: {
   cfg: TEXT2LLMConfig;
   agentId: string;
diff --git a/src/cli/channel-options.ts b/src/cli/channel-options.ts
index 48d74c19b..20412850f 100644
--- a/src/cli/channel-options.ts
+++ b/src/cli/channel-options.ts
@@ -17,33 +17,6 @@ function dedupe(values: string[]): string[] {
   return resolved;
 }
 
-export function resolveCliChannelOptions(): string[] {
-  const catalog = listChannelPluginCatalogEntries().map((entry) => entry.id);
-  const base = dedupe([...CHAT_CHANNEL_ORDER, ...catalog]);
-  if (isTruthyEnvValue(process.env.TEXT2LLM_EAGER_CHANNEL_OPTIONS)) {
-    ensurePluginRegistryLoaded();
-    const pluginIds = listChannelPlugins().map((plugin) => plugin.id);
-    return dedupe([...base, ...pluginIds]);
-  }
-import { listChannelPluginCatalogEntries } from "../channels/plugins/catalog.js";
-import { listChannelPlugins } from "../channels/plugins/index.js";
-import { CHAT_CHANNEL_ORDER } from "../channels/registry.js";
-import { isTruthyEnvValue } from "../infra/env.js";
-import { ensurePluginRegistryLoaded } from "./plugin-registry.js";
-
-function dedupe(values: string[]): string[] {
-  const seen = new Set<string>();
-  const resolved: string[] = [];
-  for (const value of values) {
-    if (!value || seen.has(value)) {
-      continue;
-    }
-    seen.add(value);
-    resolved.push(value);
-  }
-  return resolved;
-}
-
 export function resolveCliChannelOptions(): string[] {
   const catalog = listChannelPluginCatalogEntries().map((entry) => entry.id);
   const base = dedupe([...CHAT_CHANNEL_ORDER, ...catalog]);
diff --git a/src/cli/completion-cli.ts b/src/cli/completion-cli.ts
index a26413fa5..270213a0d 100644
--- a/src/cli/completion-cli.ts
+++ b/src/cli/completion-cli.ts
@@ -13,34 +13,6 @@ function isCompletionShell(value: string): value is CompletionShell {
   return COMPLETION_SHELLS.includes(value as CompletionShell);
 }
 
-export function resolveShellFromEnv(env: NodeJS.ProcessEnv = process.env): CompletionShell {
-  const shellPath = env.SHELL?.trim() ?? "";
-  const shellName = shellPath ? path.basename(shellPath).toLowerCase() : "";
-  if (shellName === "zsh") {
-    return "zsh";
-  }
-  if (shellName === "bash") {
-    return "bash";
-  }
-  if (shellName === "fish") {
-    return "fish";
-  }
-  if (shellName === "pwsh" || shellName === "powershell") {
- import { Command, Option } from "commander";
-import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { resolveStateDir } from "../config/paths.js";
-import { pathExists } from "../utils.js";
-import { getSubCliEntries, registerSubCliByName } from "./program/register.subclis.js";
-
-const COMPLETION_SHELLS = ["zsh", "bash", "powershell", "fish"] as const;
-type CompletionShell = (typeof COMPLETION_SHELLS)[number];
-
-function isCompletionShell(value: string): value is CompletionShell {
-  return COMPLETION_SHELLS.includes(value as CompletionShell);
-}
-
 export function resolveShellFromEnv(env: NodeJS.ProcessEnv = process.env): CompletionShell {
   const shellPath = env.SHELL?.trim() ?? "";
   const shellName = shellPath ? path.basename(shellPath).toLowerCase() : "";
diff --git a/src/cli/gateway-cli/dev.ts b/src/cli/gateway-cli/dev.ts
index a18868ac4..fa5c8236e 100644
--- a/src/cli/gateway-cli/dev.ts
+++ b/src/cli/gateway-cli/dev.ts
@@ -13,30 +13,6 @@ const DEV_IDENTITY_THEME = "protocol droid";
 const DEV_IDENTITY_EMOJI = "≡ƒñû";
 const DEV_AGENT_WORKSPACE_SUFFIX = "dev";
 
-async function loadDevTemplate(name: string, fallback: string): Promise<string> {
-  try {
-    const templateDir = await resolveWorkspaceTemplateDir();
-    const raw = await fs.promises.readFile(path.join(templateDir, name), "utf-8");
-    if (!raw.startsWith("---")) {
-      return raw;
-    }
-    const endIndex = raw.indexOf("\n---", 3);
-    if (endIndex === -1) {
- import fs from "node:fs";
-import os from "node:os";
-import path from "node:path";
-import { resolveWorkspaceTemplateDir } from "../../agents/workspace-templates.js";
-import { resolveDefaultAgentWorkspaceDir } from "../../agents/workspace.js";
-import { handleReset } from "../../commands/onboard-helpers.js";
-import { createConfigIO, writeConfigFile } from "../../config/config.js";
-import { defaultRuntime } from "../../runtime.js";
-import { resolveUserPath, shortenHomePath } from "../../utils.js";
-
-const DEV_IDENTITY_NAME = "C3-PO";
-const DEV_IDENTITY_THEME = "protocol droid";
-const DEV_IDENTITY_EMOJI = "≡ƒñû";
-const DEV_AGENT_WORKSPACE_SUFFIX = "dev";
-
 async function loadDevTemplate(name: string, fallback: string): Promise<string> {
   try {
     const templateDir = await resolveWorkspaceTemplateDir();
diff --git a/src/cli/gateway-cli/run.ts b/src/cli/gateway-cli/run.ts
index a9287ca78..934e55e02 100644
--- a/src/cli/gateway-cli/run.ts
+++ b/src/cli/gateway-cli/run.ts
@@ -18,26 +18,6 @@ import { setConsoleSubsystemFilter, setConsoleTimestampPrefix } from "../../logg
 import { createSubsystemLogger } from "../../logging/subsystem.js";
 import { defaultRuntime } from "../../runtime.js";
 import { formatCliCommand } from "../command-format.js";
-import { forceFreePortAndWait } from "../ports.js"import type { Command } from "commander";
-import fs from "node:fs";
-import type { GatewayAuthMode } from "../../config/config.js";
-import type { GatewayWsLogStyle } from "../../gateway/ws-logging.js";
-import {
-  CONFIG_PATH,
-  loadConfig,
-  readConfigFileSnapshot,
-  resolveGatewayPort,
-} from "../../config/config.js";
-import { resolveGatewayAuth } from "../../gateway/auth.js";
-import { startGatewayServer } from "../../gateway/server.js";
-import { setGatewayWsLogStyle } from "../../gateway/ws-logging.js";
-import { setVerbose } from "../../globals.js";
-import { GatewayLockError } from "../../infra/gateway-lock.js";
-import { formatPortDiagnostics, inspectPortUsage } from "../../infra/ports.js";
-import { setConsoleSubsystemFilter, setConsoleTimestampPrefix } from "../../logging/console.js";
-import { createSubsystemLogger } from "../../logging/subsystem.js";
-import { defaultRuntime } from "../../runtime.js";
-import { formatCliCommand } from "../command-format.js";
 import { forceFreePortAndWait } from "../ports.js";
 import { ensureDevGatewayConfig } from "./dev.js";
 import { runGatewayLoop } from "./run-loop.js";
diff --git a/src/cli/program/build-program.ts b/src/cli/program/build-program.ts
index 4feff385f..35f257692 100644
--- a/src/cli/program/build-program.ts
+++ b/src/cli/program/build-program.ts
@@ -1,10 +1,9 @@
 import { Command } from "commander";
-import { registerProgramCommands } from "./command-registry.js";
 import { createProgramContext } from "./context.js";
 import { configureProgramHelp } from "./help.js";
 import { registerPreActionHooks } from "./preaction.js";
 
-export function buildProgram() {
+export async function buildProgram(options?: { primary?: string }) {
   const program = new Command();
   const ctx = createProgramContext();
   const argv = process.argv;
@@ -12,7 +11,8 @@ export function buildProgram() {
   configureProgramHelp(program, ctx);
   registerPreActionHooks(program, ctx.programVersion);
 
-  registerProgramCommands(program, ctx, argv);
+  const { registerProgramCommands } = await import("./command-registry.js");
+  registerProgramCommands(program, ctx, argv, { primary: options?.primary });
 
   return program;
 }
diff --git a/src/cli/program/command-registry.ts b/src/cli/program/command-registry.ts
index 7d7de6bfb..ef02bacd5 100644
--- a/src/cli/program/command-registry.ts
+++ b/src/cli/program/command-registry.ts
@@ -1,21 +1,9 @@
 import type { Command } from "commander";
 import type { ProgramContext } from "./context.js";
-import { agentsListCommand } from "../../commands/agents.js";
-import { healthCommand } from "../../commands/health.js";
-import { sessionsCommand } from "../../commands/sessions.js";
-import { statusCommand } from "../../commands/status.js";
 import { defaultRuntime } from "../../runtime.js";
 import { getFlagValue, getPositiveIntFlagValue, getVerboseFlag, hasFlag } from "../argv.js";
-import { registerBrowserCli } from "../browser-cli.js";
-import { registerConfigCli } from "../config-cli.js";
-import { registerMemoryCli, runMemoryStatus } from "../memory-cli.js";
-import { registerAgentCommands } from "./register.agent.js";
-import { registerConfigureCommand } from "./register.configure.js";
-import { registerMaintenanceCommands } from "./register.maintenance.js";
-import { registerMessageCommands } from "./register.message.js";
-import { registerOnboardCommand } from "./register.onboard.js";
-import { registerSetupCommand } from "./register.setup.js";
-import { registerStatusHealthSessionsCommands } from "./register.status-health-sessions.js";
+
+
 import { registerSubCliCommands } from "./register.subclis.js";
 
 type CommandRegisterParams = {
@@ -46,6 +34,7 @@ const routeHealth: RouteSpec = {
     if (timeoutMs === null) {
       return false;
     }
+    const { healthCommand } = await import("../../commands/health.js");
     await healthCommand({ json, timeoutMs, verbose }, defaultRuntime);
     return true;
   },
@@ -64,6 +53,7 @@ const routeStatus: RouteSpec = {
     if (timeoutMs === null) {
       return false;
     }
+    const { statusCommand } = await import("../../commands/status.js");
     await statusCommand({ json, deep, all, usage, timeoutMs, verbose }, defaultRuntime);
     return true;
   },
@@ -81,6 +71,7 @@ const routeSessions: RouteSpec = {
     if (active === null) {
       return false;
     }
+    const { sessionsCommand } = await import("../../commands/sessions.js");
     await sessionsCommand({ json, store, active }, defaultRuntime);
     return true;
   },
@@ -91,6 +82,7 @@ const routeAgentsList: RouteSpec = {
   run: async (argv) => {
     const json = hasFlag(argv, "--json");
     const bindings = hasFlag(argv, "--bindings");
+    const { agentsListCommand } = await import("../../commands/agents.js");
     await agentsListCommand({ json, bindings }, defaultRuntime);
     return true;
   },
@@ -107,6 +99,7 @@ const routeMemoryStatus: RouteSpec = {
     const deep = hasFlag(argv, "--deep");
     const index = hasFlag(argv, "--index");
     const verbose = hasFlag(argv, "--verbose");
+    const { runMemoryStatus } = await import("../memory-cli.js");
     await runMemoryStatus({ agent, json, deep, index, verbose });
     return true;
   },
@@ -115,37 +108,38 @@ const routeMemoryStatus: RouteSpec = {
 export const commandRegistry: CommandRegistration[] = [
   {
     id: "setup",
-    register: ({ program }) => registerSetupCommand(program),
+    register: ({ program }) => import("./register.setup.js").then(m => m.registerSetupCommand(program)),
   },
   {
     id: "onboard",
-    register: ({ program }) => registerOnboardCommand(program),
+    register: ({ program }) => import("./register.onboard.js").then(m => m.registerOnboardCommand(program)),
   },
   {
     id: "configure",
-    register: ({ program }) => registerConfigureCommand(program),
+    register: ({ program }) => import("./register.configure.js").then(m => m.registerConfigureCommand(program)),
   },
   {
     id: "config",
-    register: ({ program }) => registerConfigCli(program),
+    register: ({ program }) => import("../config-cli.js").then(m => Promise.resolve(import("../../config/config.js")).then(cfg => m.registerConfigCli(program, cfg.loadConfig()))),
   },
   {
     id: "maintenance",
-    register: ({ program }) => registerMaintenanceCommands(program),
+    register: ({ program }) => import("./register.maintenance.js").then(m => m.registerMaintenanceCommands(program)),
   },
   {
     id: "message",
-    register: ({ program, ctx }) => registerMessageCommands(program, ctx),
+    register: ({ program, ctx }) =>
+      import("./register.message.js").then((m) => m.registerMessageCommands(program, ctx)),
   },
   {
     id: "memory",
-    register: ({ program }) => registerMemoryCli(program),
+    register: ({ program }) => import("../memory-cli.js").then(m => m.registerMemoryCli(program)),
     routes: [routeMemoryStatus],
   },
   {
     id: "agent",
     register: ({ program, ctx }) =>
-      registerAgentCommands(program, { agentChannelOptions: ctx.agentChannelOptions }),
+      import("./register.agent.js").then(m => m.registerAgentCommands(program, { agentChannelOptions: ctx.agentChannelOptions })),
     routes: [routeAgentsList],
   },
   {
@@ -154,12 +148,12 @@ export const commandRegistry: CommandRegistration[] = [
   },
   {
     id: "status-health-sessions",
-    register: ({ program }) => registerStatusHealthSessionsCommands(program),
+    register: ({ program }) => import("./register.status-health-sessions.js").then(m => m.registerStatusHealthSessionsCommands(program)),
     routes: [routeHealth, routeStatus, routeSessions],
   },
   {
     id: "browser",
-    register: ({ program }) => registerBrowserCli(program),
+    register: ({ program }) => import("../browser-cli.js").then(m => m.registerBrowserCli(program)),
   },
 ];
 
@@ -167,8 +161,15 @@ export function registerProgramCommands(
   program: Command,
   ctx: ProgramContext,
   argv: string[] = process.argv,
+  options?: { primary?: string },
 ) {
   for (const entry of commandRegistry) {
+    if (options?.primary) {
+      // Only register the matching command + subclis (for sub-CLI framework)
+      if (entry.id !== options.primary && entry.id !== "subclis") {
+        continue;
+      }
+    }
     entry.register({ program, ctx, argv });
   }
 }
diff --git a/src/cli/program/config-guard.ts b/src/cli/program/config-guard.ts
index 19312c2a1..eb10777e9 100644
--- a/src/cli/program/config-guard.ts
+++ b/src/cli/program/config-guard.ts
@@ -1,5 +1,4 @@
 import type { RuntimeEnv } from "../../runtime.js";
-import { loadAndMaybeMigrateDoctorConfig } from "../../commands/doctor-config-flow.js";
 import { readConfigFileSnapshot } from "../../config/config.js";
 import { colorize, isRich, theme } from "../../terminal/theme.js";
 import { shortenHomePath } from "../../utils.js";
@@ -30,6 +29,9 @@ export async function ensureConfigReady(params: {
 }): Promise<void> {
   if (!didRunDoctorConfigFlow) {
     didRunDoctorConfigFlow = true;
+    const { loadAndMaybeMigrateDoctorConfig } = await import(
+      "../../commands/doctor-config-flow.js"
+    );
     await loadAndMaybeMigrateDoctorConfig({
       options: { nonInteractive: true },
       confirm: async () => false,
diff --git a/src/cli/program/context.ts b/src/cli/program/context.ts
index dc38eb41f..d6b2f6a72 100644
--- a/src/cli/program/context.ts
+++ b/src/cli/program/context.ts
@@ -1,5 +1,4 @@
 import { VERSION } from "../../version.js";
-import { resolveCliChannelOptions } from "../channel-options.js";
 
 export type ProgramContext = {
   programVersion: string;
@@ -8,12 +7,32 @@ export type ProgramContext = {
   agentChannelOptions: string;
 };
 
+let _cachedChannelOptions: string[] | null = null;
+
+export async function resolveChannelOptionsLazy(): Promise<string[]> {
+  if (!_cachedChannelOptions) {
+    const { resolveCliChannelOptions } = await import("../channel-options.js");
+    _cachedChannelOptions = resolveCliChannelOptions();
+  }
+  return _cachedChannelOptions;
+}
+
+function getChannelOptionsSync(): string[] {
+  // After async initialization, this returns the cached value
+  return _cachedChannelOptions ?? [];
+}
+
 export function createProgramContext(): ProgramContext {
-  const channelOptions = resolveCliChannelOptions();
   return {
     programVersion: VERSION,
-    channelOptions,
-    messageChannelOptions: channelOptions.join("|"),
-    agentChannelOptions: ["last", ...channelOptions].join("|"),
+    get channelOptions() {
+      return getChannelOptionsSync();
+    },
+    get messageChannelOptions() {
+      return getChannelOptionsSync().join("|");
+    },
+    get agentChannelOptions() {
+      return ["last", ...getChannelOptionsSync()].join("|");
+    },
   };
 }
diff --git a/src/cli/program/help.ts b/src/cli/program/help.ts
index 9038bd3ec..d5c22937c 100644
--- a/src/cli/program/help.ts
+++ b/src/cli/program/help.ts
@@ -7,29 +7,6 @@ import { replaceCliName, resolveCliName } from "../cli-name.js";
 
 const CLI_NAME = resolveCliName();
 
-const EXAMPLES = [
-  [
-    "text2llm channels login --verbose",
-    "Link personal WhatsApp Web and show QR + connection logs.",
-  ],
-  [
-    'text2llm message send --target +15555550123 --message "Hi" --json',
-    "Send via your web session and print JSON result.",
-  ],
-  ["text2llm gateway --port 18789", "Run the WebSocket Gateway locally."],
-  ["text2llm --dev gateway", "Run a dev Gateway (isolated state/config) on ws://127.0.0.1:19001."],
-  ["text2llm gateway --force", "Kill anything bound to the default gateway port, then start it."],
-  ["text2llm gateway ...", "Gateway control via WebSocket."],
-  [
-    'text2llm agent --to +15import type { Command } from "commander";
-import type { ProgramContext } from "./context.js";
-import { formatDocsLink } from "../../terminal/links.js";
-import { isRich, theme } from "../../terminal/theme.js";
-import { formatCliBannerLine, hasEmittedCliBanner } from "../banner.js";
-import { replaceCliName, resolveCliName } from "../cli-name.js";
-
-const CLI_NAME = resolveCliName();
-
 const EXAMPLES = [
   [
     "text2llm channels login --verbose",
diff --git a/src/cli/program/preaction.ts b/src/cli/program/preaction.ts
index b85e12531..f727b4557 100644
--- a/src/cli/program/preaction.ts
+++ b/src/cli/program/preaction.ts
@@ -5,34 +5,6 @@ import { defaultRuntime } from "../../runtime.js";
 import { getCommandPath, getVerboseFlag, hasHelpOrVersion } from "../argv.js";
 import { emitCliBanner } from "../banner.js";
 import { resolveCliName } from "../cli-name.js";
-import { ensurePluginRegistryLoaded } from "../plugin-registry.js";
-import { ensureConfigReady } from "./config-guard.js";
-
-function setProcessTitleForCommand(actionCommand: Command) {
-  let current: Command = actionCommand;
-  while (current.parent && current.parent.parent) {
-    current = current.parent;
-  }
-  const name = current.name();
-  const cliName = resolveCliName();
-  if (!name || name === cliName) {
-    return;
-  }
-  process.title = `${cliName}-${name}`;
-}
-
-// Commands that need channel plugins loaded
-const PLUGIN_REQUIRED_COMMANDS = new Set(["message", "channels", "directory"]);
-
-export function registerPreActionHooks(program: Command, import type { Command } from "commander";
-import { setVerbose } from "../../globals.js";
-import { isTruthyEnvValue } from "../../infra/env.js";
-import { defaultRuntime } from "../../runtime.js";
-import { getCommandPath, getVerboseFlag, hasHelpOrVersion } from "../argv.js";
-import { emitCliBanner } from "../banner.js";
-import { resolveCliName } from "../cli-name.js";
-import { ensurePluginRegistryLoaded } from "../plugin-registry.js";
-import { ensureConfigReady } from "./config-guard.js";
 
 function setProcessTitleForCommand(actionCommand: Command) {
   let current: Command = actionCommand;
@@ -74,9 +46,11 @@ export function registerPreActionHooks(program: Command, programVersion: string)
     if (commandPath[0] === "doctor" || commandPath[0] === "completion") {
       return;
     }
+    const { ensureConfigReady } = await import("./config-guard.js");
     await ensureConfigReady({ runtime: defaultRuntime, commandPath });
     // Load plugins for commands that need channel access
     if (PLUGIN_REQUIRED_COMMANDS.has(commandPath[0])) {
+      const { ensurePluginRegistryLoaded } = await import("../plugin-registry.js");
       ensurePluginRegistryLoaded();
     }
   });
diff --git a/src/cli/program/register.agent.ts b/src/cli/program/register.agent.ts
index eef1ff57e..d59658973 100644
--- a/src/cli/program/register.agent.ts
+++ b/src/cli/program/register.agent.ts
@@ -1,22 +1,13 @@
 import type { Command } from "commander";
 import { DEFAULT_CHAT_CHANNEL } from "../../channels/registry.js";
-import { agentCliCommand } from "../../commands/agent-via-gateway.js";
-import {
-  agentsAddCommand,
-  agentsDeleteCommand,
-  agentsListCommand,
-  agentsSetIdentityCommand,
-} from "../../commands/agents.js";
 import { setVerbose } from "../../globals.js";
-import { defaultRuntime } from "../../runtime.js";
 import { formatDocsLink } from "../../terminal/links.js";
 import { theme } from "../../terminal/theme.js";
-import { runCommandWithRuntime } from "../cli-utils.js";
 import { hasExplicitOptions } from "../command-options.js";
-import { createDefaultDeps } from "../deps.js";
 import { formatHelpExamples } from "../help-format.js";
 import { collectOption } from "./helpers.js";
 
+
 export function registerAgentCommands(program: Command, args: { agentChannelOptions: string }) {
   program
     .command("agent")
@@ -72,8 +63,12 @@ ${theme.muted("Docs:")} ${formatDocsLink("/cli/agent", "docs.text2llm.ai/cli/age
     )
     .action(async (opts) => {
       const verboseLevel = typeof opts.verbose === "string" ? opts.verbose.toLowerCase() : "";
+      const { setVerbose } = await import("../../globals.js");
       setVerbose(verboseLevel === "on");
-      // Build default deps (keeps parity with other commands; future-proofing).
+      const { createDefaultDeps } = await import("../deps.js");
+      const { defaultRuntime } = await import("../../runtime.js");
+      const { runCommandWithRuntime } = await import("../cli-utils.js");
+      const { agentCliCommand } = await import("../../commands/agent-via-gateway.js");
       const deps = createDefaultDeps();
       await runCommandWithRuntime(defaultRuntime, async () => {
         await agentCliCommand(opts, defaultRuntime, deps);
@@ -95,6 +90,9 @@ ${theme.muted("Docs:")} ${formatDocsLink("/cli/agent", "docs.text2llm.ai/cli/age
     .option("--json", "Output JSON instead of text", false)
     .option("--bindings", "Include routing bindings", false)
     .action(async (opts) => {
+      const { defaultRuntime } = await import("../../runtime.js");
+      const { runCommandWithRuntime } = await import("../cli-utils.js");
+      const { agentsListCommand } = await import("../../commands/agents.js");
       await runCommandWithRuntime(defaultRuntime, async () => {
         await agentsListCommand(
           { json: Boolean(opts.json), bindings: Boolean(opts.bindings) },
@@ -113,6 +111,10 @@ ${theme.muted("Docs:")} ${formatDocsLink("/cli/agent", "docs.text2llm.ai/cli/age
     .option("--non-interactive", "Disable prompts; requires --workspace", false)
     .option("--json", "Output JSON summary", false)
     .action(async (name, opts, command) => {
+      const { defaultRuntime } = await import("../../runtime.js");
+      const { runCommandWithRuntime } = await import("../cli-utils.js");
+      const { agentsAddCommand } = await import("../../commands/agents.js");
+      const { hasExplicitOptions } = await import("../command-options.js");
       await runCommandWithRuntime(defaultRuntime, async () => {
         const hasFlags = hasExplicitOptions(command, [
           "workspace",
@@ -169,6 +171,9 @@ ${formatHelpExamples([
 `,
     )
     .action(async (opts) => {
+      const { defaultRuntime } = await import("../../runtime.js");
+      const { runCommandWithRuntime } = await import("../cli-utils.js");
+      const { agentsSetIdentityCommand } = await import("../../commands/agents.js");
       await runCommandWithRuntime(defaultRuntime, async () => {
         await agentsSetIdentityCommand(
           {
@@ -193,6 +198,9 @@ ${formatHelpExamples([
     .option("--force", "Skip confirmation", false)
     .option("--json", "Output JSON summary", false)
     .action(async (id, opts) => {
+      const { defaultRuntime } = await import("../../runtime.js");
+      const { runCommandWithRuntime } = await import("../cli-utils.js");
+      const { agentsDeleteCommand } = await import("../../commands/agents.js");
       await runCommandWithRuntime(defaultRuntime, async () => {
         await agentsDeleteCommand(
           {
@@ -206,6 +214,9 @@ ${formatHelpExamples([
     });
 
   agents.action(async () => {
+    const { defaultRuntime } = await import("../../runtime.js");
+    const { runCommandWithRuntime } = await import("../cli-utils.js");
+    const { agentsListCommand } = await import("../../commands/agents.js");
     await runCommandWithRuntime(defaultRuntime, async () => {
       await agentsListCommand({}, defaultRuntime);
     });
diff --git a/src/cli/program/register.maintenance.ts b/src/cli/program/register.maintenance.ts
index 7fc2de8fc..ba89c7e6e 100644
--- a/src/cli/program/register.maintenance.ts
+++ b/src/cli/program/register.maintenance.ts
@@ -1,8 +1,4 @@
 import type { Command } from "commander";
-import { dashboardCommand } from "../../commands/dashboard.js";
-import { doctorCommand } from "../../commands/doctor.js";
-import { resetCommand } from "../../commands/reset.js";
-import { uninstallCommand } from "../../commands/uninstall.js";
 import { defaultRuntime } from "../../runtime.js";
 import { formatDocsLink } from "../../terminal/links.js";
 import { theme } from "../../terminal/theme.js";
@@ -27,6 +23,7 @@ export function registerMaintenanceCommands(program: Command) {
     .option("--deep", "Scan system services for extra gateway installs", false)
     .action(async (opts) => {
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { doctorCommand } = await import("../../commands/doctor.js");
         await doctorCommand(defaultRuntime, {
           workspaceSuggestions: opts.workspaceSuggestions,
           yes: Boolean(opts.yes),
@@ -50,6 +47,7 @@ export function registerMaintenanceCommands(program: Command) {
     .option("--no-open", "Print URL but do not launch a browser", false)
     .action(async (opts) => {
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { dashboardCommand } = await import("../../commands/dashboard.js");
         await dashboardCommand(defaultRuntime, {
           noOpen: Boolean(opts.noOpen),
         });
@@ -70,6 +68,7 @@ export function registerMaintenanceCommands(program: Command) {
     .option("--dry-run", "Print actions without removing files", false)
     .action(async (opts) => {
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { resetCommand } = await import("../../commands/reset.js");
         await resetCommand(defaultRuntime, {
           scope: opts.scope,
           yes: Boolean(opts.yes),
@@ -97,6 +96,7 @@ export function registerMaintenanceCommands(program: Command) {
     .option("--dry-run", "Print actions without removing files", false)
     .action(async (opts) => {
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { uninstallCommand } = await import("../../commands/uninstall.js");
         await uninstallCommand(defaultRuntime, {
           service: Boolean(opts.service),
           state: Boolean(opts.state),
diff --git a/src/cli/program/register.onboard.ts b/src/cli/program/register.onboard.ts
index ec77b5f2c..3e92d685b 100644
--- a/src/cli/program/register.onboard.ts
+++ b/src/cli/program/register.onboard.ts
@@ -7,7 +7,6 @@ import type {
   NodeManagerChoice,
   TailscaleMode,
 } from "../../commands/onboard-types.js";
-import { onboardCommand } from "../../commands/onboard.js";
 import { defaultRuntime } from "../../runtime.js";
 import { formatDocsLink } from "../../terminal/links.js";
 import { theme } from "../../terminal/theme.js";
@@ -124,6 +123,7 @@ export function registerOnboardCommand(program: Command) {
         });
         const gatewayPort =
           typeof opts.gatewayPort === "string" ? Number.parseInt(opts.gatewayPort, 10) : undefined;
+        const { onboardCommand } = await import("../../commands/onboard.js");
         await onboardCommand(
           {
             workspace: opts.workspace as string | undefined,
diff --git a/src/cli/program/register.setup.ts b/src/cli/program/register.setup.ts
index 428ff4c6c..b58bbb7a9 100644
--- a/src/cli/program/register.setup.ts
+++ b/src/cli/program/register.setup.ts
@@ -1,6 +1,4 @@
 import type { Command } from "commander";
-import { onboardCommand } from "../../commands/onboard.js";
-import { setupCommand } from "../../commands/setup.js";
 import { defaultRuntime } from "../../runtime.js";
 import { formatDocsLink } from "../../terminal/links.js";
 import { theme } from "../../terminal/theme.js";
@@ -35,6 +33,7 @@ export function registerSetupCommand(program: Command) {
           "remoteToken",
         ]);
         if (opts.wizard || hasWizardFlags) {
+          const { onboardCommand } = await import("../../commands/onboard.js");
           await onboardCommand(
             {
               workspace: opts.workspace as string | undefined,
@@ -47,6 +46,7 @@ export function registerSetupCommand(program: Command) {
           );
           return;
         }
+        const { setupCommand } = await import("../../commands/setup.js");
         await setupCommand({ workspace: opts.workspace as string | undefined }, defaultRuntime);
       });
     });
diff --git a/src/cli/program/register.status-health-sessions.ts b/src/cli/program/register.status-health-sessions.ts
index 0c71de584..49491cd5f 100644
--- a/src/cli/program/register.status-health-sessions.ts
+++ b/src/cli/program/register.status-health-sessions.ts
@@ -1,7 +1,4 @@
 import type { Command } from "commander";
-import { healthCommand } from "../../commands/health.js";
-import { sessionsCommand } from "../../commands/sessions.js";
-import { statusCommand } from "../../commands/status.js";
 import { setVerbose } from "../../globals.js";
 import { defaultRuntime } from "../../runtime.js";
 import { formatDocsLink } from "../../terminal/links.js";
@@ -63,6 +60,7 @@ export function registerStatusHealthSessionsCommands(program: Command) {
         return;
       }
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { statusCommand } = await import("../../commands/status.js");
         await statusCommand(
           {
             json: Boolean(opts.json),
@@ -97,6 +95,7 @@ export function registerStatusHealthSessionsCommands(program: Command) {
         return;
       }
       await runCommandWithRuntime(defaultRuntime, async () => {
+        const { healthCommand } = await import("../../commands/health.js");
         await healthCommand(
           {
             json: Boolean(opts.json),
@@ -134,6 +133,7 @@ export function registerStatusHealthSessionsCommands(program: Command) {
     )
     .action(async (opts) => {
       setVerbose(Boolean(opts.verbose));
+      const { sessionsCommand } = await import("../../commands/sessions.js");
       await sessionsCommand(
         {
           json: Boolean(opts.json),
diff --git a/src/cli/route.ts b/src/cli/route.ts
index e97b0e4ff..81042659a 100644
--- a/src/cli/route.ts
+++ b/src/cli/route.ts
@@ -3,9 +3,6 @@ import { defaultRuntime } from "../runtime.js";
 import { VERSION } from "../version.js";
 import { getCommandPath, hasHelpOrVersion } from "./argv.js";
 import { emitCliBanner } from "./banner.js";
-import { ensurePluginRegistryLoaded } from "./plugin-registry.js";
-import { findRoutedCommand } from "./program/command-registry.js";
-import { ensureConfigReady } from "./program/config-guard.js";
 
 async function prepareRoutedCommand(params: {
   argv: string[];
@@ -13,8 +10,10 @@ async function prepareRoutedCommand(params: {
   loadPlugins?: boolean;
 }) {
   emitCliBanner(VERSION, { argv: params.argv });
+  const { ensureConfigReady } = await import("./program/config-guard.js");
   await ensureConfigReady({ runtime: defaultRuntime, commandPath: params.commandPath });
   if (params.loadPlugins) {
+    const { ensurePluginRegistryLoaded } = await import("./plugin-registry.js");
     ensurePluginRegistryLoaded();
   }
 }
@@ -31,6 +30,7 @@ export async function tryRouteCli(argv: string[]): Promise<boolean> {
   if (!path[0]) {
     return false;
   }
+  const { findRoutedCommand } = await import("./program/command-registry.js");
   const route = findRoutedCommand(path);
   if (!route) {
     return false;
diff --git a/src/cli/run-main.ts b/src/cli/run-main.ts
index de343a863..140664396 100644
--- a/src/cli/run-main.ts
+++ b/src/cli/run-main.ts
@@ -40,8 +40,12 @@ export async function runCli(argv: string[] = process.argv) {
   // Capture all console output into structured logs while keeping stdout/stderr behavior.
   enableConsoleCapture();
 
+  // Compute primary command early so buildProgram only registers the needed command.
+  const parseArgv = rewriteUpdateFlagArgv(normalizedArgv);
+  const primary = getPrimaryCommand(parseArgv);
+
   const { buildProgram } = await import("./program.js");
-  const program = buildProgram();
+  const program = await buildProgram({ primary: primary || undefined });
 
   // Global error handlers to prevent silent crashes from unhandled rejections/exceptions.
   // These log the error and exit gracefully instead of crashing without trace.
@@ -52,15 +56,26 @@ export async function runCli(argv: string[] = process.argv) {
     process.exit(1);
   });
 
-  const parseArgv = rewriteUpdateFlagArgv(normalizedArgv);
   // Register the primary subcommand if one exists (for lazy-loading)
-  const primary = getPrimaryCommand(parseArgv);
   if (primary) {
     const { registerSubCliByName } = await import("./program/register.subclis.js");
     await registerSubCliByName(program, primary);
   }
 
-  const shouldSkipPluginRegistration = !primary && hasHelpOrVersion(parseArgv);
+  let shouldSkipPluginRegistration = !primary && hasHelpOrVersion(parseArgv);
+
+  if (!shouldSkipPluginRegistration && primary) {
+    const { commandRegistry, findRoutedCommand } = await import("./program/command-registry.js");
+    const { getSubCliEntries } = await import("./program/register.subclis.js");
+    const route = findRoutedCommand(parseArgv);
+    const isCore =
+      commandRegistry.some((c) => c.id === primary || c.routes?.some((r) => r.match([primary]))) ||
+      getSubCliEntries().some((e) => e.name === primary);
+    if (isCore && !route?.loadPlugins) {
+      shouldSkipPluginRegistration = true;
+    }
+  }
+
   if (!shouldSkipPluginRegistration) {
     // Register plugin CLI commands before parsing
     const { registerPluginCliCommands } = await import("../plugins/cli.js");
@@ -68,6 +83,12 @@ export async function runCli(argv: string[] = process.argv) {
     registerPluginCliCommands(program, loadConfig());
   }
 
+  // Resolve channel options lazily (skip for --help to avoid heavy plugin/catalog loading)
+  if (!hasHelpOrVersion(parseArgv)) {
+    const { resolveChannelOptionsLazy } = await import("./program/context.js");
+    await resolveChannelOptionsLazy();
+  }
+
   await program.parseAsync(parseArgv);
 }
 
diff --git a/src/commands/agent/delivery.ts b/src/commands/agent/delivery.ts
index f6c4b3b40..296e39a7e 100644
--- a/src/commands/agent/delivery.ts
+++ b/src/commands/agent/delivery.ts
@@ -19,28 +19,6 @@ import {
 } from "../../infra/outbound/payloads.js";
 import { isInternalMessageChannel } from "../../utils/message-channel.js";
 
-type RunResult = Awaited<
-  ReturnTimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { SessionEntry } from "../../config/sessions.js";
-import type { RuntimeEnv } from "../../runtime.js";
-import type { AgentCommandOpts } from "./types.js";
-import { AGENT_LANE_NESTED } from "../../agents/lanes.js";
-import { getChannelPlugin, normalizeChannelId } from "../../channels/plugins/index.js";
-import { createOutboundSendDeps, type CliDeps } from "../../cli/outbound-send-deps.js";
-import {
-  resolveAgentDeliveryPlan,
-  resolveAgentOutboundTarget,
-} from "../../infra/outbound/agent-delivery.js";
-import { deliverOutboundPayloads } from "../../infra/outbound/deliver.js";
-import { buildOutboundResultEnvelope } from "../../infra/outbound/envelope.js";
-import {
-  formatOutboundPayloadLog,
-  type NormalizedOutboundPayload,
-  normalizeOutboundPayloads,
-  normalizeOutboundPayloadsForJson,
-} from "../../infra/outbound/payloads.js";
-import { isInternalMessageChannel } from "../../utils/message-channel.js";
-
 type RunResult = Awaited<
   ReturnType<(typeof import("../../agents/pi-embedded.js"))["runEmbeddedPiAgent"]>
 >;
diff --git a/src/commands/agent/session-store.ts b/src/commands/agent/session-store.ts
index 3ddbec71b..fa2a19ec6 100644
--- a/src/commands/agent/session-store.ts
+++ b/src/commands/agent/session-store.ts
@@ -10,35 +10,6 @@ type RunResult = Awaited<
   ReturnType<(typeof import("../../agents/pi-embedded.js"))["runEmbeddedPiAgent"]>
 >;
 
-export async function updateSessionStoreAfterAgentRun(params: {
-  cfg: TEXT2LLMConfig;
-  contextTokensOverride?: number;
-  sessionId: string;
-  sessionKey: string;
-  storePath: string;
-  sessionStore: Record<string, SessionEntry>;
-  defaultProvider: string;
-  defaultModel: string;
-  fallbackProvider?: string;
-  fallbackModel?: string;
-  result: RunResult;
-}) {
-  const {
-    cfg,
-    sessionId,
-    sessionKey,
-    storePatimport type { TEXT2LLMConfig } from "../../config/config.js";
-import { setCliSessionId } from "../../agents/cli-session.js";
-import { lookupContextTokens } from "../../agents/context.js";
-import { DEFAULT_CONTEXT_TOKENS } from "../../agents/defaults.js";
-import { isCliProvider } from "../../agents/model-selection.js";
-import { deriveSessionTotalTokens, hasNonzeroUsage } from "../../agents/usage.js";
-import { type SessionEntry, updateSessionStore } from "../../config/sessions.js";
-
-type RunResult = Awaited<
-  ReturnType<(typeof import("../../agents/pi-embedded.js"))["runEmbeddedPiAgent"]>
->;
-
 export async function updateSessionStoreAfterAgentRun(params: {
   cfg: TEXT2LLMConfig;
   contextTokensOverride?: number;
diff --git a/src/commands/agents.bindings.ts b/src/commands/agents.bindings.ts
index 502ae0995..997af28a2 100644
--- a/src/commands/agents.bindings.ts
+++ b/src/commands/agents.bindings.ts
@@ -18,33 +18,6 @@ function bindingMatchKey(match: AgentBinding["match"]) {
   ].join("|");
 }
 
-export function describeBinding(binding: AgentBinding) {
-  const match = binding.match;
-  const parts = [match.channel];
-  if (match.accountId) {
-    parts.push(`accountId=${match.accountId}`);
-  }
-  if (match.peer) {
-    parts.push(`peer=${match.peeimport type { ChannelId } from "../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { AgentBinding } from "../config/types.js";
-import type { ChannelChoice } from "./onboard-types.js";
-import { resolveChannelDefaultAccountId } from "../channels/plugins/helpers.js";
-import { getChannelPlugin, normalizeChannelId } from "../channels/plugins/index.js";
-import { DEFAULT_ACCOUNT_ID, normalizeAgentId } from "../routing/session-key.js";
-
-function bindingMatchKey(match: AgentBinding["match"]) {
-  const accountId = match.accountId?.trim() || DEFAULT_ACCOUNT_ID;
-  return [
-    match.channel,
-    accountId,
-    match.peer?.kind ?? "",
-    match.peer?.id ?? "",
-    match.guildId ?? "",
-    match.teamId ?? "",
-  ].join("|");
-}
-
 export function describeBinding(binding: AgentBinding) {
   const match = binding.match;
   const parts = [match.channel];
diff --git a/src/commands/auth-choice.apply.ts b/src/commands/auth-choice.apply.ts
index 47876b284..25f45bf3e 100644
--- a/src/commands/auth-choice.apply.ts
+++ b/src/commands/auth-choice.apply.ts
@@ -11,19 +11,6 @@ import { applyAuthChoiceGoogleGeminiCli } from "./auth-choice.apply.google-gemin
 import { applyAuthChoiceMiniMax } from "./auth-choice.apply.minimax.js";
 import { applyAuthChoiceOAuth } from "./auth-choice.apply.oauth.js";
 import { applyAuthChoiceOpenAI } from "./auth-choice.apply.openai.js";
-import { applyAuthChoiceQwenPortal } from "./auth-choice.apply.qwen-portaimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { RuntimeEnv } from "../runtime.js";
-import type { WizardPrompter } from "../wizard/prompts.js";
-import type { AuthChoice } from "./onboard-types.js";
-import { applyAuthChoiceAnthropic } from "./auth-choice.apply.anthropic.js";
-import { applyAuthChoiceApiProviders } from "./auth-choice.apply.api-providers.js";
-import { applyAuthChoiceCopilotProxy } from "./auth-choice.apply.copilot-proxy.js";
-import { applyAuthChoiceGitHubCopilot } from "./auth-choice.apply.github-copilot.js";
-import { applyAuthChoiceGoogleAntigravity } from "./auth-choice.apply.google-antigravity.js";
-import { applyAuthChoiceGoogleGeminiCli } from "./auth-choice.apply.google-gemini-cli.js";
-import { applyAuthChoiceMiniMax } from "./auth-choice.apply.minimax.js";
-import { applyAuthChoiceOAuth } from "./auth-choice.apply.oauth.js";
-import { applyAuthChoiceOpenAI } from "./auth-choice.apply.openai.js";
 import { applyAuthChoiceQwenPortal } from "./auth-choice.apply.qwen-portal.js";
 import { applyAuthChoiceXAI } from "./auth-choice.apply.xai.js";
 
diff --git a/src/commands/auth-choice.default-model.ts b/src/commands/auth-choice.default-model.ts
index d01b9be49..bcdf90f89 100644
--- a/src/commands/auth-choice.default-model.ts
+++ b/src/commands/auth-choice.default-model.ts
@@ -2,31 +2,6 @@ import type { TEXT2LLMConfig } from "../config/config.js";
 import type { WizardPrompter } from "../wizard/prompts.js";
 import { ensureModelAllowlistEntry } from "./model-allowlist.js";
 
-export async function applyDefaultModelChoice(params: {
-  config: TEXT2LLMConfig;
-  setDefaultModel: boolean;
-  defaultModel: string;
-  applyDefaultConfig: (config: TEXT2LLMConfig) => TEXT2LLMConfig;
-  applyProviderConfig: (config: TEXT2LLMConfig) => TEXT2LLMConfig;
-  noteDefault?: string;
-  noteAgentModel: (model: string) => Promise<void>;
-  prompter: WizardPrompter;
-}): Promise<{ config: TEXT2LLMConfig; agentModelOverride?: string }> {
-  if (params.setDefaultModel) {
-    const next = params.applyDefaultConfig(params.config);
-    if (params.noteDefault) {
-      await params.prompter.note(`Default model set to ${params.noteDefault}`, "Model configured");
-    }
-    return { config: next };
-  }
-
-  const next = params.applyProviderConfig(params.config);
-  const nextWithModel = ensureModelAllowlistEntry({
-    cfg: next,
-    modelRimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { WizardPrompter } from "../wizard/prompts.js";
-import { ensureModelAllowlistEntry } from "./model-allowlist.js";
-
 export async function applyDefaultModelChoice(params: {
   config: TEXT2LLMConfig;
   setDefaultModel: boolean;
diff --git a/src/commands/configure.gateway.ts b/src/commands/configure.gateway.ts
index b7dc8b763..0d2ab6a74 100644
--- a/src/commands/configure.gateway.ts
+++ b/src/commands/configure.gateway.ts
@@ -9,35 +9,6 @@ import { guardCancel, normalizeGatewayTokenInput, randomToken } from "./onboard-
 
 type GatewayAuthChoice = "token" | "password";
 
-export async function promptGatewayConfig(
-  cfg: TEXT2LLMConfig,
-  runtime: RuntimeEnv,
-): Promise<{
-  config: TEXT2LLMConfig;
-  port: number;
-  token?: string;
-}> {
-  const portRaw = guardCancel(
-    await text({
-      message: "Gateway port",
-      initialValue: String(resolveGatewayPort(cfg)),
-      validate: (value) => (Number.isFinite(Number(value)) ? undefined : "Invalid port"),
-    }),
-    runtime,
-  );
-  const port = Number.parseInt(String(portRaw), 10);
-
-  let binimport type { TEXT2LLMConfig } from "../config/config.js";
-import type { RuntimeEnv } from "../runtime.js";
-import { resolveGatewayPort } from "../config/config.js";
-import { findTailscaleBinary } from "../infra/tailscale.js";
-import { note } from "../terminal/note.js";
-import { buildGatewayAuthConfig } from "./configure.gateway-auth.js";
-import { confirm, select, text } from "./configure.shared.js";
-import { guardCancel, normalizeGatewayTokenInput, randomToken } from "./onboard-helpers.js";
-
-type GatewayAuthChoice = "token" | "password";
-
 export async function promptGatewayConfig(
   cfg: TEXT2LLMConfig,
   runtime: RuntimeEnv,
diff --git a/src/commands/doctor-security.test.ts b/src/commands/doctor-security.test.ts
index ae7a4a7d8..6b4d940b9 100644
--- a/src/commands/doctor-security.test.ts
+++ b/src/commands/doctor-security.test.ts
@@ -13,40 +13,6 @@ vi.mock("../channels/plugins/index.js", () => ({
 
 import { noteSecurityWarnings } from "./doctor-security.js";
 
-describe("noteSecurityWarnings gateway exposure", () => {
-  let prevToken: string | undefined;
-  let prevPassword: string | undefined;
-
-  beforeEach(() => {
-    note.mockClear();
-    prevToken = process.env.TEXT2LLM_GATEWAY_TOKEN;
-    prevPassword = process.env.TEXT2LLM_GATEWAY_PASSWORD;
-    delete process.env.TEXT2LLM_GATEWAY_TOKEN;
-    delete process.env.TEXT2LLM_GATEWAY_PASSWORD;
-  });
-
-  afterEach(() => {
-    if (prevToken === undefined) {
-      delete process.env.TEXT2LLM_GATEWAY_TOKEN;
-    } else {
-      process.env.TEXT2LLM_GATEWAY_TOKEN = prevToken;
-    }
-    if (prevPassword === undefined) {
-      delete process.env.TEXT2LLM_GATEimport { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-
-const note = vi.hoisted(() => vi.fn());
-
-vi.mock("../terminal/note.js", () => ({
-  note,
-}));
-
-vi.mock("../channels/plugins/index.js", () => ({
-  listChannelPlugins: () => [],
-}));
-
-import { noteSecurityWarnings } from "./doctor-security.js";
-
 describe("noteSecurityWarnings gateway exposure", () => {
   let prevToken: string | undefined;
   let prevPassword: string | undefined;
diff --git a/src/commands/doctor.runs-legacy-state-migrations-yes-mode-without.test.ts b/src/commands/doctor.runs-legacy-state-migrations-yes-mode-without.test.ts
index 04e9a396f..ca3040588 100644
--- a/src/commands/doctor.runs-legacy-state-migrations-yes-mode-without.test.ts
+++ b/src/commands/doctor.runs-legacy-state-migrations-yes-mode-without.test.ts
@@ -19,42 +19,6 @@ function setStdinTty(value: boolean | undefined) {
   }
 }
 
-beforeEach(() => {
-  confirm.mockReset().mockResolvedValue(true);
-  select.mockReset().mockResolvedValue("node");
-  note.mockClear();
-
-  readConfigFileSnapshot.mockReset();
-  writeConfigFile.mockReset().mockResolvedValue(undefined);
-  resolveTEXT2LLMPackageRoot.mockReset().mockResolvedValue(null);
-  runGatewayUpdate.mockReset().mockResolvedValue({
-    status: "skipped",
-    mode: "unknown",
-    steps: [],
-    durationMs: 0,
-  });
-  legacyReadConfigFileSnapshot.mockReset().mockResolvedValue({
-    pathimport fs from "node:fs";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-
-let originalIsTTY: boolean | undefined;
-let originalStateDir: string | undefined;
-let originalUpdateInProgress: string | undefined;
-let tempStateDir: string | undefined;
-
-function setStdinTty(value: boolean | undefined) {
-  try {
-    Object.defineProperty(process.stdin, "isTTY", {
-      value,
-      configurable: true,
-    });
-  } catch {
-    // ignore
-  }
-}
-
 beforeEach(() => {
   confirm.mockReset().mockResolvedValue(true);
   select.mockReset().mockResolvedValue("node");
diff --git a/src/commands/google-gemini-model-default.ts b/src/commands/google-gemini-model-default.ts
index d67af9961..3e011169a 100644
--- a/src/commands/google-gemini-model-default.ts
+++ b/src/commands/google-gemini-model-default.ts
@@ -13,39 +13,6 @@ function resolvePrimaryModel(model?: AgentModelListConfig | string): string | un
   return undefined;
 }
 
-export function applyGoogleGeminiModelDefault(cfg: TEXT2LLMConfig): {
-  next: TEXT2LLMConfig;
-  changed: boolean;
-} {
-  const current = resolvePrimaryModel(cfg.agents?.defaults?.model)?.trim();
-  if (current === GOOGLE_GEMINI_DEFAULT_MODEL) {
-    return { next: cfg, changed: false };
-  }
-
-  return {
-    next: {
-      ...cfg,
-      agents: {
-        ...cfg.agents,
-        defaults: {
-          ...cfg.agents?.defaults,
-          model:
-            cfg.agents?.defaults?.model && typeof cfg.agents.defaults.model === "object"
-              ? {import type { TEXT2LLMConfig } from "../config/config.js";
-import type { AgentModelListConfig } from "../config/types.js";
-
-export const GOOGLE_GEMINI_DEFAULT_MODEL = "google/gemini-3-pro-preview";
-
-function resolvePrimaryModel(model?: AgentModelListConfig | string): string | undefined {
-  if (typeof model === "string") {
-    return model;
-  }
-  if (model && typeof model === "object" && typeof model.primary === "string") {
-    return model.primary;
-  }
-  return undefined;
-}
-
 export function applyGoogleGeminiModelDefault(cfg: TEXT2LLMConfig): {
   next: TEXT2LLMConfig;
   changed: boolean;
diff --git a/src/commands/health.ts b/src/commands/health.ts
index 987acbfd2..312332844 100644
--- a/src/commands/health.ts
+++ b/src/commands/health.ts
@@ -15,23 +15,6 @@ import {
   type HeartbeatSummary,
   resolveHeartbeatSummaryForAgent,
 } from "../infra/heartbeat-runner.js";
-import { buildChannelAccountBindings, resolvePreferredAccountId } from "../routing/bindings.js"import type { ChannelAccountSnapshot } from "../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { RuntimeEnv } from "../runtime.js";
-import { resolveDefaultAgentId } from "../agents/agent-scope.js";
-import { resolveChannelDefaultAccountId } from "../channels/plugins/helpers.js";
-import { getChannelPlugin, listChannelPlugins } from "../channels/plugins/index.js";
-import { withProgress } from "../cli/progress.js";
-import { loadConfig } from "../config/config.js";
-import { loadSessionStore, resolveStorePath } from "../config/sessions.js";
-import { buildGatewayConnectionDetails, callGateway } from "../gateway/call.js";
-import { info } from "../globals.js";
-import { isTruthyEnvValue } from "../infra/env.js";
-import { formatErrorMessage } from "../infra/errors.js";
-import {
-  type HeartbeatSummary,
-  resolveHeartbeatSummaryForAgent,
-} from "../infra/heartbeat-runner.js";
 import { buildChannelAccountBindings, resolvePreferredAccountId } from "../routing/bindings.js";
 import { normalizeAgentId } from "../routing/session-key.js";
 import { theme } from "../terminal/theme.js";
diff --git a/src/commands/model-allowlist.ts b/src/commands/model-allowlist.ts
index 8f5255aee..b9524bc1e 100644
--- a/src/commands/model-allowlist.ts
+++ b/src/commands/model-allowlist.ts
@@ -39,44 +39,3 @@ export function ensureModelAllowlistEntry(params: {
     },
   };
 }
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { DEFAULT_PROVIDER } from "../agents/defaults.js";
-import { resolveAllowlistModelKey } from "../agents/model-selection.js";
-
-export function ensureModelAllowlistEntry(params: {
-  cfg: TEXT2LLMConfig;
-  modelRef: string;
-  defaultProvider?: string;
-}): TEXT2LLMConfig {
-  const rawModelRef = params.modelRef.trim();
-  if (!rawModelRef) {
-    return params.cfg;
-  }
-
-  const models = { ...params.cfg.agents?.defaults?.models };
-  const keySet = new Set<string>([rawModelRef]);
-  const canonicalKey = resolveAllowlistModelKey(
-    rawModelRef,
-    params.defaultProvider ?? DEFAULT_PROVIDER,
-  );
-  if (canonicalKey) {
-    keySet.add(canonicalKey);
-  }
-
-  for (const key of keySet) {
-    models[key] = {
-      ...models[key],
-    };
-  }
-
-  return {
-    ...params.cfg,
-    agents: {
-      ...params.cfg.agents,
-      defaults: {
-        ...params.cfg.agents?.defaults,
-        models,
-      },
-    },
-  };
-}
diff --git a/src/commands/models/auth.ts b/src/commands/models/auth.ts
index cfe907cf7..b87c0d920 100644
--- a/src/commands/models/auth.ts
+++ b/src/commands/models/auth.ts
@@ -326,7 +326,7 @@ function credentialMode(credential: AuthProfileCredential): "api_key" | "oauth"
 }
 
 export async function modelsAuthLoginCommand(opts: LoginOptions, runtime: RuntimeEnv) {
-  if (!process.stdin.isTTY) {
+  if (!process.stdin.isTTY && !process.env.TEXT2LLM_ALLOW_HEADLESS_AUTH) {
     throw new Error("models auth login requires an interactive TTY.");
   }
 
diff --git a/src/commands/models/list.auth-overview.ts b/src/commands/models/list.auth-overview.ts
index 24ea16ad8..536ef3030 100644
--- a/src/commands/models/list.auth-overview.ts
+++ b/src/commands/models/list.auth-overview.ts
@@ -12,30 +12,6 @@ import { getCustomProviderApiKey, resolveEnvApiKey } from "../../agents/model-au
 import { shortenHomePath } from "../../utils.js";
 import { maskApiKey } from "./list.format.js";
 
-export function resolveProviderAuthOverview(params: {
-  provider: string;
-  cfg: TEXT2LLMConfig;
-  store: AuthProfileStore;
-  modelsPath: string;
-}): ProviderAuthOverview {
-  const { provider, cfg, store } = params;
-  const now = Date.now();
-  const profiles = listProfilesForProvider(store, provider);
-  const withUnusableSuffix = (base: string, profileId: string) => {
-    const unusableUntil = resolveProfileUnusableUntilForDisplay(stimport type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ProviderAuthOverview } from "./list.types.js";
-import { formatRemainingShort } from "../../agents/auth-health.js";
-import {
-  type AuthProfileStore,
-  listProfilesForProvider,
-  resolveAuthProfileDisplayLabel,
-  resolveAuthStorePathForDisplay,
-  resolveProfileUnusableUntilForDisplay,
-} from "../../agents/auth-profiles.js";
-import { getCustomProviderApiKey, resolveEnvApiKey } from "../../agents/model-auth.js";
-import { shortenHomePath } from "../../utils.js";
-import { maskApiKey } from "./list.format.js";
-
 export function resolveProviderAuthOverview(params: {
   provider: string;
   cfg: TEXT2LLMConfig;
diff --git a/src/commands/models/shared.ts b/src/commands/models/shared.ts
index 12d8619ff..3c3a9897a 100644
--- a/src/commands/models/shared.ts
+++ b/src/commands/models/shared.ts
@@ -30,39 +30,6 @@ export const formatTokenK = (value?: number | null) => {
   return `${Math.round(value / 1024)}k`;
 };
 
-export const formatMs = (value?: number | null) => {
-  if (value === null || value === undefiimport { listAgentIds } from "../../agents/agent-scope.js";
-import { DEFAULT_MODEL, DEFAULT_PROVIDER } from "../../agents/defaults.js";
-import {
-  buildModelAliasIndex,
-  modelKey,
-  parseModelRef,
-  resolveModelRefFromString,
-} from "../../agents/model-selection.js";
-import { formatCliCommand } from "../../cli/command-format.js";
-import {
-  type TEXT2LLMConfig,
-  readConfigFileSnapshot,
-  writeConfigFile,
-} from "../../config/config.js";
-import { normalizeAgentId } from "../../routing/session-key.js";
-
-export const ensureFlagCompatibility = (opts: { json?: boolean; plain?: boolean }) => {
-  if (opts.json && opts.plain) {
-    throw new Error("Choose either --json or --plain, not both.");
-  }
-};
-
-export const formatTokenK = (value?: number | null) => {
-  if (!value || !Number.isFinite(value)) {
-    return "-";
-  }
-  if (value < 1024) {
-    return `${Math.round(value)}`;
-  }
-  return `${Math.round(value / 1024)}k`;
-};
-
 export const formatMs = (value?: number | null) => {
   if (value === null || value === undefined) {
     return "-";
diff --git a/src/commands/onboard-non-interactive/local/daemon-install.ts b/src/commands/onboard-non-interactive/local/daemon-install.ts
index 35ed9dad3..c8be64602 100644
--- a/src/commands/onboard-non-interactive/local/daemon-install.ts
+++ b/src/commands/onboard-non-interactive/local/daemon-install.ts
@@ -7,29 +7,6 @@ import { buildGatewayInstallPlan, gatewayInstallErrorHint } from "../../daemon-i
 import { DEFAULT_GATEWAY_DAEMON_RUNTIME, isGatewayDaemonRuntime } from "../../daemon-runtime.js";
 import { ensureSystemdUserLingerNonInteractive } from "../../systemd-linger.js";
 
-export async function installGatewayDaemonNonInteractive(params: {
-  nextConfig: TEXT2LLMConfig;
-  opts: OnboardOptions;
-  runtime: RuntimeEnv;
-  port: number;
-  gatewayToken?: string;
-}) {
-  const { opts, runtime, port, gatewayToken } = params;
-  if (!opts.installDaemon) {
-    return;
-  }
-
-  const daemonRuntimeRaw = opts.daemonRuntime ?? DEFAULT_GATEWAY_DAEMON_RUNTIME;
-  const systemdAvailable =
-    process.platfoimport type { TEXT2LLMConfig } from "../../../config/config.js";
-import type { RuntimeEnv } from "../../../runtime.js";
-import type { OnboardOptions } from "../../onboard-types.js";
-import { resolveGatewayService } from "../../../daemon/service.js";
-import { isSystemdUserServiceAvailable } from "../../../daemon/systemd.js";
-import { buildGatewayInstallPlan, gatewayInstallErrorHint } from "../../daemon-install-helpers.js";
-import { DEFAULT_GATEWAY_DAEMON_RUNTIME, isGatewayDaemonRuntime } from "../../daemon-runtime.js";
-import { ensureSystemdUserLingerNonInteractive } from "../../systemd-linger.js";
-
 export async function installGatewayDaemonNonInteractive(params: {
   nextConfig: TEXT2LLMConfig;
   opts: OnboardOptions;
diff --git a/src/commands/onboard-non-interactive/local/skills-config.ts b/src/commands/onboard-non-interactive/local/skills-config.ts
index c8d0793a3..4c95fced9 100644
--- a/src/commands/onboard-non-interactive/local/skills-config.ts
+++ b/src/commands/onboard-non-interactive/local/skills-config.ts
@@ -29,34 +29,3 @@ export function applyNonInteractiveSkillsConfig(params: {
     },
   };
 }
-import type { TEXT2LLMConfig } from "../../../config/config.js";
-import type { RuntimeEnv } from "../../../runtime.js";
-import type { OnboardOptions } from "../../onboard-types.js";
-
-export function applyNonInteractiveSkillsConfig(params: {
-  nextConfig: TEXT2LLMConfig;
-  opts: OnboardOptions;
-  runtime: RuntimeEnv;
-}) {
-  const { nextConfig, opts, runtime } = params;
-  if (opts.skipSkills) {
-    return nextConfig;
-  }
-
-  const nodeManager = opts.nodeManager ?? "npm";
-  if (!["npm", "pnpm", "bun"].includes(nodeManager)) {
-    runtime.error("Invalid --node-manager (use npm, pnpm, or bun)");
-    runtime.exit(1);
-    return nextConfig;
-  }
-  return {
-    ...nextConfig,
-    skills: {
-      ...nextConfig.skills,
-      install: {
-        ...nextConfig.skills?.install,
-        nodeManager,
-      },
-    },
-  };
-}
diff --git a/src/commands/setup.ts b/src/commands/setup.ts
index a5a07e3aa..f534ea5c8 100644
--- a/src/commands/setup.ts
+++ b/src/commands/setup.ts
@@ -24,33 +24,6 @@ async function readConfigFileRaw(configPath: string): Promise<{
   }
 }
 
-export async function setupCommand(
-  opts?: { worksimport JSON5 from "json5";
-import fs from "node:fs/promises";
-import type { RuntimeEnv } from "../runtime.js";
-import { DEFAULT_AGENT_WORKSPACE_DIR, ensureAgentWorkspace } from "../agents/workspace.js";
-import { type TEXT2LLMConfig, createConfigIO, writeConfigFile } from "../config/config.js";
-import { formatConfigPath, logConfigUpdated } from "../config/logging.js";
-import { resolveSessionTranscriptsDir } from "../config/sessions.js";
-import { defaultRuntime } from "../runtime.js";
-import { shortenHomePath } from "../utils.js";
-
-async function readConfigFileRaw(configPath: string): Promise<{
-  exists: boolean;
-  parsed: TEXT2LLMConfig;
-}> {
-  try {
-    const raw = await fs.readFile(configPath, "utf-8");
-    const parsed = JSON5.parse(raw);
-    if (parsed && typeof parsed === "object") {
-      return { exists: true, parsed: parsed as TEXT2LLMConfig };
-    }
-    return { exists: true, parsed: {} };
-  } catch {
-    return { exists: false, parsed: {} };
-  }
-}
-
 export async function setupCommand(
   opts?: { workspace?: string },
   runtime: RuntimeEnv = defaultRuntime,
diff --git a/src/commands/status-all/agents.ts b/src/commands/status-all/agents.ts
index 0abcd9d2a..1618d7ef2 100644
--- a/src/commands/status-all/agents.ts
+++ b/src/commands/status-all/agents.ts
@@ -14,37 +14,6 @@ async function fileExists(p: string): Promise<boolean> {
   }
 }
 
-export async function getAgentLocalStatuses(cfg: TEXT2LLMConfig) {
-  const agentList = listAgentsForGateway(cfg);
-  const now = Date.now();
-
-  const agents = await Promise.all(
-    agentList.agents.map(async (agent) => {
-      const workspaceDir = (() => {
-        try {
-          return resolveAgentWorkspaceDir(cfg, agent.id);
-        } catch {
-          return null;
-        }
-      })();
-      const bootstrapPending =
-        workspaceDir != null ? await fileExists(path.join(workspaceDir, "BOOTSTRAP.md")) : null;
-      constimport fs from "node:fs/promises";
-import path from "node:path";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { resolveAgentWorkspaceDir } from "../../agents/agent-scope.js";
-import { loadSessionStore, resolveStorePath } from "../../config/sessions.js";
-import { listAgentsForGateway } from "../../gateway/session-utils.js";
-
-async function fileExists(p: string): Promise<boolean> {
-  try {
-    await fs.access(p);
-    return true;
-  } catch {
-    return false;
-  }
-}
-
 export async function getAgentLocalStatuses(cfg: TEXT2LLMConfig) {
   const agentList = listAgentsForGateway(cfg);
   const now = Date.now();
diff --git a/src/config/agent-dirs.ts b/src/config/agent-dirs.ts
index a9d9457b9..f49098d4f 100644
--- a/src/config/agent-dirs.ts
+++ b/src/config/agent-dirs.ts
@@ -29,38 +29,6 @@ function canonicalizeAgentDir(agentDir: string): string {
   return resolved;
 }
 
-function collectReferencedAgentIds(cfg: TEXT2LLMConfig): string[] {
-  const ids = new import os from "node:os";
-import path from "node:path";
-import type { TEXT2LLMConfig } from "./types.js";
-import { resolveRequiredHomeDir } from "../infra/home-dir.js";
-import { DEFAULT_AGENT_ID, normalizeAgentId } from "../routing/session-key.js";
-import { resolveUserPath } from "../utils.js";
-import { resolveStateDir } from "./paths.js";
-
-export type DuplicateAgentDir = {
-  agentDir: string;
-  agentIds: string[];
-};
-
-export class DuplicateAgentDirError extends Error {
-  readonly duplicates: DuplicateAgentDir[];
-
-  constructor(duplicates: DuplicateAgentDir[]) {
-    super(formatDuplicateAgentDirError(duplicates));
-    this.name = "DuplicateAgentDirError";
-    this.duplicates = duplicates;
-  }
-}
-
-function canonicalizeAgentDir(agentDir: string): string {
-  const resolved = path.resolve(agentDir);
-  if (process.platform === "darwin" || process.platform === "win32") {
-    return resolved.toLowerCase();
-  }
-  return resolved;
-}
-
 function collectReferencedAgentIds(cfg: TEXT2LLMConfig): string[] {
   const ids = new Set<string>();
 
diff --git a/src/config/config.backup-rotation.test.ts b/src/config/config.backup-rotation.test.ts
index f4951e3b3..e625b95eb 100644
--- a/src/config/config.backup-rotation.test.ts
+++ b/src/config/config.backup-rotation.test.ts
@@ -3,33 +3,6 @@ import { describe, expect, it } from "vitest";
 import type { TEXT2LLMConfig } from "./types.js";
 import { withTempHome } from "./test-helpers.js";
 
-describe("config backup rotation", () => {
-  it("keeps a 5-deep backup ring for config writes", async () => {
-    await withTempHome(async () => {
-      const { resolveConfigPath, writeConfigFile } = await import("./config.js");
-      const configPath = resolveConfigPath();
-      const buildConfig = (version: number): TEXT2LLMConfig =>
-        ({
-          agents: { list: [{ id: `v${version}` }] },
-        }) as TEXT2LLMConfig;
-
-      for (let version = 0; version <= 6; version += 1) {
-        await writeConfigFile(buildConfig(version));
-      }
-
-      const readName = async (suffix = "") => {
-        const raw = await fs.readFile(`${configPath}${suffix}`, "utf-8");
-        return (
-          (JSON.parse(raw) as { agents?: { list?: Array<{ id?: string }> } }).agents?.list?.[0]
-            ?.id ?? null
-        );
-      };
-
-      aimport fs from "node:fs/promises";
-import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "./types.js";
-import { withTempHome } from "./test-helpers.js";
-
 describe("config backup rotation", () => {
   it("keeps a 5-deep backup ring for config writes", async () => {
     await withTempHome(async () => {
diff --git a/src/config/defaults.ts b/src/config/defaults.ts
index be6756583..f3af9c2c6 100644
--- a/src/config/defaults.ts
+++ b/src/config/defaults.ts
@@ -25,33 +25,6 @@ const DEFAULT_MODEL_ALIASES: Readonly<Record<string, string>> = {
   "gemini-flash": "google/gemini-3-flash-preview",
 };
 
-const DEFAULT_MODEL_COST: ModelDefinitionConfig["cimport type { TEXT2LLMConfig } from "./types.js";
-import type { ModelDefinitionConfig } from "./types.models.js";
-import { DEFAULT_CONTEXT_TOKENS } from "../agents/defaults.js";
-import { parseModelRef } from "../agents/model-selection.js";
-import { DEFAULT_AGENT_MAX_CONCURRENT, DEFAULT_SUBAGENT_MAX_CONCURRENT } from "./agent-limits.js";
-import { resolveTalkApiKey } from "./talk.js";
-
-type WarnState = { warned: boolean };
-
-let defaultWarnState: WarnState = { warned: false };
-
-type AnthropicAuthDefaultsMode = "api_key" | "oauth";
-
-const DEFAULT_MODEL_ALIASES: Readonly<Record<string, string>> = {
-  // Anthropic (pi-ai catalog uses "latest" ids without date suffix)
-  opus: "anthropic/claude-opus-4-6",
-  sonnet: "anthropic/claude-sonnet-4-5",
-
-  // OpenAI
-  gpt: "openai/gpt-5.2",
-  "gpt-mini": "openai/gpt-5-mini",
-
-  // Google Gemini (3.x are preview ids in the catalog)
-  gemini: "google/gemini-3-pro-preview",
-  "gemini-flash": "google/gemini-3-flash-preview",
-};
-
 const DEFAULT_MODEL_COST: ModelDefinitionConfig["cost"] = {
   input: 0,
   output: 0,
diff --git a/src/config/io.compat.test.ts b/src/config/io.compat.test.ts
index c5e6048b4..96f183bb7 100644
--- a/src/config/io.compat.test.ts
+++ b/src/config/io.compat.test.ts
@@ -26,37 +26,6 @@ async function writeConfig(
   return configPath;
 }
 
-describe("config io paths", () => {
-  it("uses ~/.text2llm/text2llm.json when config exists", async () => {
-    await withTempHome(async (home) => {
-      const configPath = await writeConfig(home, ".text2llm", 19import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { describe, expect, it } from "vitest";
-import { createConfigIO } from "./io.js";
-
-async function withTempHome(run: (home: string) => Promise<void>): Promise<void> {
-  const home = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-config-"));
-  try {
-    await run(home);
-  } finally {
-    await fs.rm(home, { recursive: true, force: true });
-  }
-}
-
-async function writeConfig(
-  home: string,
-  dirname: ".text2llm",
-  port: number,
-  filename: string = "text2llm.json",
-) {
-  const dir = path.join(home, dirname);
-  await fs.mkdir(dir, { recursive: true });
-  const configPath = path.join(dir, filename);
-  await fs.writeFile(configPath, JSON.stringify({ gateway: { port } }, null, 2));
-  return configPath;
-}
-
 describe("config io paths", () => {
   it("uses ~/.text2llm/text2llm.json when config exists", async () => {
     await withTempHome(async (home) => {
diff --git a/src/config/markdown-tables.ts b/src/config/markdown-tables.ts
index 3c8ea9db8..474f2a5f3 100644
--- a/src/config/markdown-tables.ts
+++ b/src/config/markdown-tables.ts
@@ -18,38 +18,6 @@ const DEFAULT_TABLE_MODES = new Map<string, MarkdownTableMode>([
   ["whatsapp", "bullets"],
 ]);
 
-const isMarkdownTableMode = (value: unknown): value is MarkdownTableMode =>
-  value === "off" || value === "bullets" || value === "code";
-
-function resolveMarkdownModeFromSection(
-  section: MarkdownConfigSection | undefined,
-  accountId?: string | null,
-): MarkdownTableMode | undefined {
-  if (!section) {
-    return undefined;
-  }
-  const normalizedAccountId = normalizeAccountId(accountId);
-  const accounts = section.accounts;
-  if (accounts && typeof accounts ===import type { TEXT2LLMConfig } from "./config.js";
-import type { MarkdownTableMode } from "./types.base.js";
-import { normalizeChannelId } from "../channels/plugins/index.js";
-import { normalizeAccountId } from "../routing/session-key.js";
-
-type MarkdownConfigEntry = {
-  markdown?: {
-    tables?: MarkdownTableMode;
-  };
-};
-
-type MarkdownConfigSection = MarkdownConfigEntry & {
-  accounts?: Record<string, MarkdownConfigEntry>;
-};
-
-const DEFAULT_TABLE_MODES = new Map<string, MarkdownTableMode>([
-  ["signal", "bullets"],
-  ["whatsapp", "bullets"],
-]);
-
 const isMarkdownTableMode = (value: unknown): value is MarkdownTableMode =>
   value === "off" || value === "bullets" || value === "code";
 
diff --git a/src/config/normalize-paths.ts b/src/config/normalize-paths.ts
index 7007b14df..f7440e9c7 100644
--- a/src/config/normalize-paths.ts
+++ b/src/config/normalize-paths.ts
@@ -19,39 +19,6 @@ function normalizeStringValue(key: string | undefined, value: string): string {
   return value;
 }
 
-function normalizeAny(key: string | undefined, value: unknown): unknown {
-  if (typeof value === "string") {
-    return normalizeStringValue(key, value);
-  }
-
-  if (Array.isArray(value)) {
-    const normalizeChildren = Boolean(key && PATH_LIST_KEYS.has(key));
-    return value.map((entry) => {
-      if (typeof entry === "string") {
-        return normalizeChildren ? normalizeStringValue(key, entry) : entry;
-      }
-      if (Array.isArray(entry)) {
- import type { TEXT2LLMConfig } from "./types.js";
-import { isPlainObject, resolveUserPath } from "../utils.js";
-
-const PATH_VALUE_RE = /^~(?=$|[\\/])/;
-
-const PATH_KEY_RE = /(dir|path|paths|file|root|workspace)$/i;
-const PATH_LIST_KEYS = new Set(["paths", "pathPrepend"]);
-
-function normalizeStringValue(key: string | undefined, value: string): string {
-  if (!PATH_VALUE_RE.test(value.trim())) {
-    return value;
-  }
-  if (!key) {
-    return value;
-  }
-  if (PATH_KEY_RE.test(key) || PATH_LIST_KEYS.has(key)) {
-    return resolveUserPath(value);
-  }
-  return value;
-}
-
 function normalizeAny(key: string | undefined, value: unknown): unknown {
   if (typeof value === "string") {
     return normalizeStringValue(key, value);
diff --git a/src/config/sessions/store.pruning.test.ts b/src/config/sessions/store.pruning.test.ts
index 32af525e5..7208a4518 100644
--- a/src/config/sessions/store.pruning.test.ts
+++ b/src/config/sessions/store.pruning.test.ts
@@ -30,38 +30,6 @@ function makeStore(entries: Array<[string, SessionEntry]>): Record<string, Sessi
   return Object.fromEntries(entries);
 }
 
-// -------------------------import crypto from "node:crypto";
-import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { SessionEntry } from "./types.js";
-import {
-  capEntryCount,
-  clearSessionStoreCacheForTest,
-  loadSessionStore,
-  pruneStaleEntries,
-  rotateSessionFile,
-  saveSessionStore,
-} from "./store.js";
-
-// Mock loadConfig so resolveMaintenanceConfig() never reads a real text2llm.json.
-// Unit tests always pass explicit overrides so this mock is inert for them.
-// Integration tests set return values to control the config.
-vi.mock("../config.js", () => ({
-  loadConfig: vi.fn().mockReturnValue({}),
-}));
-
-const DAY_MS = 24 * 60 * 60 * 1000;
-
-function makeEntry(updatedAt: number): SessionEntry {
-  return { sessionId: crypto.randomUUID(), updatedAt };
-}
-
-function makeStore(entries: Array<[string, SessionEntry]>): Record<string, SessionEntry> {
-  return Object.fromEntries(entries);
-}
-
 // ---------------------------------------------------------------------------
 // Unit tests ΓÇö each function called with explicit override parameters.
 // No config loading needed; overrides bypass resolveMaintenanceConfig().
diff --git a/src/config/types.text2llm.ts b/src/config/types.text2llm.ts
index a3a763f4a..fb89d6741 100644
--- a/src/config/types.text2llm.ts
+++ b/src/config/types.text2llm.ts
@@ -97,6 +97,28 @@ export type TEXT2LLMConfig = {
   talk?: TalkConfig;
   gateway?: GatewayConfig;
   memory?: MemoryConfig;
+
+  /**
+   * Resources added to the text2llm-web store.
+   * This property is injected dynamically by the web UI backend.
+   */
+  storeResourcesByProject?: Record<
+    string,
+    Array<{
+      id: string;
+      projectId?: string;
+      type: string;
+      source: string;
+      name: string;
+      author?: string;
+      description?: string;
+      url?: string;
+      metrics?: Record<string, unknown>;
+      tags?: string[];
+      license?: string;
+      addedAt?: string;
+    }>
+  >;
 };
 
 export type ConfigValidationIssue = {
diff --git a/src/config/zod-schema.ts b/src/config/zod-schema.ts
index 95638610d..3a5a6dfb8 100644
--- a/src/config/zod-schema.ts
+++ b/src/config/zod-schema.ts
@@ -12,42 +12,6 @@ import {
   SessionSendPolicySchema,
 } from "./zod-schema.session.js";
 
-const BrowserSnapshotDefaultsSchema = z
-  .object({
-    mode: z.literal("efficient").optional(),
-  })
-  .strict()
-  .optional();
-
-const NodeHostSchema = z
-  .object({
-    browserProxy: z
-      .object({
-        enabled: z.boolean().optional(),
-        allowProfiles: z.array(z.string()).optional(),
-      })
-      .strict()
-      .optional(),
-  })
-  .strict()
-  .optional();
-
-const MemoryQmdPathSchema = z
-  .object({
- import { z } from "zod";
-import { ToolsSchema } from "./zod-schema.agent-runtime.js";
-import { AgentsSchema, AudioSchema, BindingsSchema, BroadcastSchema } from "./zod-schema.agents.js";
-import { ApprovalsSchema } from "./zod-schema.approvals.js";
-import { HexColorSchema, ModelsConfigSchema } from "./zod-schema.core.js";
-import { HookMappingSchema, HooksGmailSchema, InternalHooksSchema } from "./zod-schema.hooks.js";
-import { ChannelsSchema } from "./zod-schema.providers.js";
-import {
-  CommandsSchema,
-  MessagesSchema,
-  SessionSchema,
-  SessionSendPolicySchema,
-} from "./zod-schema.session.js";
-
 const BrowserSnapshotDefaultsSchema = z
   .object({
     mode: z.literal("efficient").optional(),
@@ -365,6 +329,7 @@ export const TEXT2LLMSchema = z
           })
           .strict()
           .optional(),
+        providers: z.record(z.string(), z.any()).optional(),
       })
       .strict()
       .optional(),
diff --git a/src/cron/isolated-agent/run.ts b/src/cron/isolated-agent/run.ts
index 3ab465d24..d66d885d8 100644
--- a/src/cron/isolated-agent/run.ts
+++ b/src/cron/isolated-agent/run.ts
@@ -16,28 +16,6 @@ import { resolveCronStyleNow } from "../../agents/current-time.js";
 import { DEFAULT_CONTEXT_TOKENS, DEFAULT_MODEL, DEFAULT_PROVIDER } from "../../agents/defaults.js";
 import { loadModelCatalog } from "../../agents/model-catalog.js";
 import { runWithModelFallback } from "../../agents/model-fallback.js";
-import {
-  getModelRefStatus,
-  isCliProvider,
-  resolveAllowedModelRef,
-  resolveConfiimport type { MessagingToolSend } from "../../agents/pi-embedded-messaging.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { AgentDefaultsConfig } from "../../config/types.js";
-import type { CronJob } from "../types.js";
-import {
-  resolveAgentConfig,
-  resolveAgentDir,
-  resolveAgentModelFallbacksOverride,
-  resolveAgentWorkspaceDir,
-  resolveDefaultAgentId,
-} from "../../agents/agent-scope.js";
-import { runCliAgent } from "../../agents/cli-runner.js";
-import { getCliSessionId, setCliSessionId } from "../../agents/cli-session.js";
-import { lookupContextTokens } from "../../agents/context.js";
-import { resolveCronStyleNow } from "../../agents/current-time.js";
-import { DEFAULT_CONTEXT_TOKENS, DEFAULT_MODEL, DEFAULT_PROVIDER } from "../../agents/defaults.js";
-import { loadModelCatalog } from "../../agents/model-catalog.js";
-import { runWithModelFallback } from "../../agents/model-fallback.js";
 import {
   getModelRefStatus,
   isCliProvider,
diff --git a/src/discord/monitor/native-command.ts b/src/discord/monitor/native-command.ts
index fc1a5b94e..6f3c91caa 100644
--- a/src/discord/monitor/native-command.ts
+++ b/src/discord/monitor/native-command.ts
@@ -30,38 +30,6 @@ import {
   resolveCommandArgMenu,
   serializeCommandArgs,
 } from "../../auto-reply/commands-registry.js";
-import { finalizeInboundContext } from "../../autimport {
-  Button,
-  ChannelType,
-  Command,
-  Row,
-  type AutocompleteInteraction,
-  type ButtonInteraction,
-  type CommandInteraction,
-  type CommandOptions,
-  type ComponentData,
-} from "@buape/carbon";
-import { ApplicationCommandOptionType, ButtonStyle } from "discord-api-types/v10";
-import type {
-  ChatCommandDefinition,
-  CommandArgDefinition,
-  CommandArgValues,
-  CommandArgs,
-  NativeCommandSpec,
-} from "../../auto-reply/commands-registry.js";
-import type { ReplyPayload } from "../../auto-reply/types.js";
-import type { TEXT2LLMConfig, loadConfig } from "../../config/config.js";
-import { resolveHumanDelayConfig } from "../../agents/identity.js";
-import { resolveChunkMode, resolveTextChunkLimit } from "../../auto-reply/chunk.js";
-import {
-  buildCommandTextFromArgs,
-  findCommandByNativeName,
-  listChatCommands,
-  parseCommandArgs,
-  resolveCommandArgChoices,
-  resolveCommandArgMenu,
-  serializeCommandArgs,
-} from "../../auto-reply/commands-registry.js";
 import { finalizeInboundContext } from "../../auto-reply/reply/inbound-context.js";
 import { dispatchReplyWithDispatcher } from "../../auto-reply/reply/provider-dispatcher.js";
 import { resolveCommandAuthorizedFromAuthorizers } from "../../channels/command-gating.js";
diff --git a/src/discord/monitor/provider.ts b/src/discord/monitor/provider.ts
index a5d5a334a..f0eb19ad5 100644
--- a/src/discord/monitor/provider.ts
+++ b/src/discord/monitor/provider.ts
@@ -15,23 +15,6 @@ import {
   resolveNativeSkillsEnabled,
 } from "../../config/commands.js";
 import { loadConfig } from "../../config/config.js";
-import { danger, logVerbose, shouldLogVerbose, warn } from "../import { Client, type BaseMessageInteractiveComponent } from "@buape/carbon";
-import { GatewayIntents, GatewayPlugin } from "@buape/carbon/gateway";
-import { Routes } from "discord-api-types/v10";
-import { inspect } from "node:util";
-import type { HistoryEntry } from "../../auto-reply/reply/history.js";
-import type { TEXT2LLMConfig, ReplyToMode } from "../../config/config.js";
-import type { RuntimeEnv } from "../../runtime.js";
-import { resolveTextChunkLimit } from "../../auto-reply/chunk.js";
-import { listNativeCommandSpecsForConfig } from "../../auto-reply/commands-registry.js";
-import { listSkillCommandsForAgents } from "../../auto-reply/skill-commands.js";
-import { mergeAllowlist, summarizeMapping } from "../../channels/allowlists/resolve-utils.js";
-import {
-  isNativeCommandsExplicitlyDisabled,
-  resolveNativeCommandsEnabled,
-  resolveNativeSkillsEnabled,
-} from "../../config/commands.js";
-import { loadConfig } from "../../config/config.js";
 import { danger, logVerbose, shouldLogVerbose, warn } from "../../globals.js";
 import { formatErrorMessage } from "../../infra/errors.js";
 import { createDiscordRetryRunner } from "../../infra/retry-policy.js";
diff --git a/src/discord/token.test.ts b/src/discord/token.test.ts
index 0c628b40f..1e9b798a3 100644
--- a/src/discord/token.test.ts
+++ b/src/discord/token.test.ts
@@ -2,38 +2,6 @@ import { afterEach, describe, expect, it, vi } from "vitest";
 import type { TEXT2LLMConfig } from "../config/config.js";
 import { resolveDiscordToken } from "./token.js";
 
-describe("resolveDiscordToken", () => {
-  afterEach(() => {
-    vi.unstubAllEnvs();
-  });
-
-  it("prefers config token over env", () => {
-    vi.stubEnv("DISCORD_BOT_TOKEN", "env-token");
-    const cfg = {
-      channels: { discord: { token: "cfg-token" } },
-    } as TEXT2LLMConfig;
-    const res = resolveDiscordToken(cfg);
-    expect(res.token).toBe("cfg-token");
-    expect(res.source).toBe("config");
-  });
-
-  it("uses env token when config is missing", () => {
-    vi.stubEnv("DISCORD_BOT_TOKEN", "env-token");
-    const cfg = {
-      channels: { discord: {} },
-    } as TEXT2LLMConfig;
-    const res = resolveDiscordToken(cfg);
-    expect(res.token).toBe("env-token");
-    expect(res.source).toBe("env");
-  });
-
-  it("prefers account token for non-default accounts", () => {
-    vi.stubEnv("DISCORD_BOT_TOKEN", "env-token");
-    const cfg = {
-   import { afterEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveDiscordToken } from "./token.js";
-
 describe("resolveDiscordToken", () => {
   afterEach(() => {
     vi.unstubAllEnvs();
diff --git a/src/gateway/assistant-identity.test.ts b/src/gateway/assistant-identity.test.ts
index 187f5aa78..6e4c2c742 100644
--- a/src/gateway/assistant-identity.test.ts
+++ b/src/gateway/assistant-identity.test.ts
@@ -2,42 +2,6 @@ import { describe, expect, it } from "vitest";
 import type { TEXT2LLMConfig } from "../config/config.js";
 import { DEFAULT_ASSISTANT_IDENTITY, resolveAssistantIdentity } from "./assistant-identity.js";
 
-describe("resolveAssistantIdentity avatar normalization", () => {
-  it("drops sentence-like avatar placeholders", () => {
-    const cfg: TEXT2LLMConfig = {
-      ui: {
-        assistant: {
-          avatar: "workspace-relative path, http(s) URL, or data URI",
-        },
-      },
-    };
-
-    expect(resolveAssistantIdentity({ cfg, workspaceDir: "" }).avatar).toBe(
-      DEFAULT_ASSISTANT_IDENTITY.avatar,
-    );
-  });
-
-  it("keeps short text avatars", () => {
-    const cfg: TEXT2LLMConfig = {
-      ui: {
-        assistant: {
-          avatar: "PS",
-        },
-      },
-    };
-
-    expect(resolveAssistantIdentity({ cfg, workspaceDir: "" }).avatar).toBe("PS");
-  });
-
-  it("keeps path avatars", () => {
-    const cfg: TEXT2LLMConfig = {
-      ui: {
-        assistant: {
-          avatar: "avatars/text2llm.png",
-       import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { DEFAULT_ASSISTANT_IDENTITY, resolveAssistantIdentity } from "./assistant-identity.js";
-
 describe("resolveAssistantIdentity avatar normalization", () => {
   it("drops sentence-like avatar placeholders", () => {
     const cfg: TEXT2LLMConfig = {
diff --git a/src/gateway/assistant-identity.ts b/src/gateway/assistant-identity.ts
index 74be15162..7c31bc40b 100644
--- a/src/gateway/assistant-identity.ts
+++ b/src/gateway/assistant-identity.ts
@@ -35,43 +35,6 @@ function coerceIdentityValue(value: string | undefined, maxLength: number): stri
   return trimmed.slice(0, maxLength);
 }
 
-function isAvatarimport type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveAgentWorkspaceDir, resolveDefaultAgentId } from "../agents/agent-scope.js";
-import { resolveAgentIdentity } from "../agents/identity.js";
-import { loadAgentIdentity } from "../commands/agents.config.js";
-import { normalizeAgentId } from "../routing/session-key.js";
-
-const MAX_ASSISTANT_NAME = 50;
-const MAX_ASSISTANT_AVATAR = 200;
-const MAX_ASSISTANT_EMOJI = 16;
-
-export const DEFAULT_ASSISTANT_IDENTITY: AssistantIdentity = {
-  agentId: "main",
-  name: "Assistant",
-  avatar: "A",
-};
-
-export type AssistantIdentity = {
-  agentId: string;
-  name: string;
-  avatar: string;
-  emoji?: string;
-};
-
-function coerceIdentityValue(value: string | undefined, maxLength: number): string | undefined {
-  if (typeof value !== "string") {
-    return undefined;
-  }
-  const trimmed = value.trim();
-  if (!trimmed) {
-    return undefined;
-  }
-  if (trimmed.length <= maxLength) {
-    return trimmed;
-  }
-  return trimmed.slice(0, maxLength);
-}
-
 function isAvatarUrl(value: string): boolean {
   return /^https?:\/\//i.test(value) || /^data:image\//i.test(value);
 }
diff --git a/src/gateway/auth.ts b/src/gateway/auth.ts
index 28e32cf37..c645144a4 100644
--- a/src/gateway/auth.ts
+++ b/src/gateway/auth.ts
@@ -37,45 +37,6 @@ type TailscaleUser = {
 
 type TailscaleWhoisLookup = (ip: string) => Promise<TailscaleWhoisIdentity | null>;
 
-function normaliimport type { IncomingMessage } from "node:http";
-import type { GatewayAuthConfig, GatewayTailscaleMode } from "../config/config.js";
-import { readTailscaleWhoisIdentity, type TailscaleWhoisIdentity } from "../infra/tailscale.js";
-import { safeEqualSecret } from "../security/secret-equal.js";
-import {
-  isLoopbackAddress,
-  isTrustedProxyAddress,
-  parseForwardedForClientIp,
-  resolveGatewayClientIp,
-} from "./net.js";
-export type ResolvedGatewayAuthMode = "token" | "password";
-
-export type ResolvedGatewayAuth = {
-  mode: ResolvedGatewayAuthMode;
-  token?: string;
-  password?: string;
-  allowTailscale: boolean;
-};
-
-export type GatewayAuthResult = {
-  ok: boolean;
-  method?: "token" | "password" | "tailscale" | "device-token";
-  user?: string;
-  reason?: string;
-};
-
-type ConnectAuth = {
-  token?: string;
-  password?: string;
-};
-
-type TailscaleUser = {
-  login: string;
-  name: string;
-  profilePic?: string;
-};
-
-type TailscaleWhoisLookup = (ip: string) => Promise<TailscaleWhoisIdentity | null>;
-
 function normalizeLogin(login: string): string {
   return login.trim().toLowerCase();
 }
diff --git a/src/gateway/hooks.ts b/src/gateway/hooks.ts
index b11d6f5f6..dd9584822 100644
--- a/src/gateway/hooks.ts
+++ b/src/gateway/hooks.ts
@@ -26,34 +26,6 @@ export type HookAgentPolicyResolved = {
   allowedAgentIds?: Set<string>;
 };
 
-exporimport type { IncomingMessage } from "node:http";
-import { randomUUID } from "node:crypto";
-import type { ChannelId } from "../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { listAgentIds, resolveDefaultAgentId } from "../agents/agent-scope.js";
-import { listChannelPlugins } from "../channels/plugins/index.js";
-import { normalizeAgentId } from "../routing/session-key.js";
-import { normalizeMessageChannel } from "../utils/message-channel.js";
-import { type HookMappingResolved, resolveHookMappings } from "./hooks-mapping.js";
-
-const DEFAULT_HOOKS_PATH = "/hooks";
-const DEFAULT_HOOKS_MAX_BODY_BYTES = 256 * 1024;
-
-export type HooksConfigResolved = {
-  basePath: string;
-  token: string;
-  maxBodyBytes: number;
-  mappings: HookMappingResolved[];
-  agentPolicy: HookAgentPolicyResolved;
-  sessionPolicy: HookSessionPolicyResolved;
-};
-
-export type HookAgentPolicyResolved = {
-  defaultAgentId: string;
-  knownAgentIds: Set<string>;
-  allowedAgentIds?: Set<string>;
-};
-
 export type HookSessionPolicyResolved = {
   defaultSessionKey?: string;
   allowRequestSessionKey: boolean;
diff --git a/src/gateway/server-constants.ts b/src/gateway/server-constants.ts
index 4735bc1ad..a6b8906ac 100644
--- a/src/gateway/server-constants.ts
+++ b/src/gateway/server-constants.ts
@@ -6,28 +6,6 @@ let maxChatHistoryMessagesBytes = DEFAULT_MAX_CHAT_HISTORY_MESSAGES_BYTES;
 
 export const getMaxChatHistoryMessagesBytes = () => maxChatHistoryMessagesBytes;
 
-export const __setMaxChatHistoryMessagesBytesForTest = (value?: number) => {
-  if (!process.env.VITEST && process.env.NODE_ENV !== "test") {
-    return;
-  }
-  if (value === undefined) {
-    maxChatHistoryMessagesBytes = DEFAULT_MAX_CHAT_HISTORY_MESSAGES_BYTES;
-    return;
-  }
-  if (Number.isFinite(value) && value > 0) {
-    maxChatHistoryMessagesBytes = value;
-  }
-};
-export const DEFAULT_HANDSHAKE_TIMEOUT_MS = 10_000;
-export const getHandshakeTimeoutMs = () => {
-  if (process.env.VITESTexport const MAX_PAYLOAD_BYTES = 8 * 1024 * 1024; // cap incoming frame size (~8 MiB; fits ~5,000,000 decoded bytes as base64 + JSON overhead)
-export const MAX_BUFFERED_BYTES = 16 * 1024 * 1024; // per-connection send buffer limit (2x max payload)
-
-const DEFAULT_MAX_CHAT_HISTORY_MESSAGES_BYTES = 6 * 1024 * 1024; // keep history responses comfortably under client WS limits
-let maxChatHistoryMessagesBytes = DEFAULT_MAX_CHAT_HISTORY_MESSAGES_BYTES;
-
-export const getMaxChatHistoryMessagesBytes = () => maxChatHistoryMessagesBytes;
-
 export const __setMaxChatHistoryMessagesBytesForTest = (value?: number) => {
   if (!process.env.VITEST && process.env.NODE_ENV !== "test") {
     return;
diff --git a/src/gateway/server-methods/channels.ts b/src/gateway/server-methods/channels.ts
index fa4c42019..7f850d966 100644
--- a/src/gateway/server-methods/channels.ts
+++ b/src/gateway/server-methods/channels.ts
@@ -14,28 +14,6 @@ import { loadConfig, readConfigFileSnapshot } from "../../config/config.js";
 import { getChannelActivity } from "../../infra/channel-activity.js";
 import { DEFAULT_ACCOUNT_ID } from "../../routing/session-key.js";
 import { defaultRuntime } from "../../runtime.js";
-import {
-  ErrorCodes,
-  errorShape,
-  formatValidationErrors,
-  validateChannelsLogoutParams,
-  validateChannelsStatusParams,
-} from "../protocol/indimport type { ChannelAccountSnapshot, ChannelPlugin } from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { GatewayRequestContext, GatewayRequestHandlers } from "./types.js";
-import { buildChannelUiCatalog } from "../../channels/plugins/catalog.js";
-import { resolveChannelDefaultAccountId } from "../../channels/plugins/helpers.js";
-import {
-  type ChannelId,
-  getChannelPlugin,
-  listChannelPlugins,
-  normalizeChannelId,
-} from "../../channels/plugins/index.js";
-import { buildChannelAccountSnapshot } from "../../channels/plugins/status.js";
-import { loadConfig, readConfigFileSnapshot } from "../../config/config.js";
-import { getChannelActivity } from "../../infra/channel-activity.js";
-import { DEFAULT_ACCOUNT_ID } from "../../routing/session-key.js";
-import { defaultRuntime } from "../../runtime.js";
 import {
   ErrorCodes,
   errorShape,
diff --git a/src/gateway/server-methods/update.ts b/src/gateway/server-methods/update.ts
index c6b3bcba5..e41b87bcf 100644
--- a/src/gateway/server-methods/update.ts
+++ b/src/gateway/server-methods/update.ts
@@ -16,34 +16,6 @@ import {
   validateUpdateRunParams,
 } from "../protocol/index.js";
 
-export const updateHandlers: GatewayRequestHandlers = {
-  "update.run": async ({ params, respond }) => {
-    if (!validateUpdateRunParams(params)) {
-      respond(
-        false,
-        undefined,
-        errorShape(
-          ErrorCodes.INVALID_REQUEST,
-          `invalid update.run params: ${formatValidationErrors(validateUpdateRunParams.errors)}`,
-        ),
- import type { GatewayRequestHandlers } from "./types.js";
-import { loadConfig } from "../../config/config.js";
-import { resolveTEXT2LLMPackageRoot } from "../../infra/text2llm-root.js";
-import {
-  formatDoctorNonInteractiveHint,
-  type RestartSentinelPayload,
-  writeRestartSentinel,
-} from "../../infra/restart-sentinel.js";
-import { scheduleGatewaySigusr1Restart } from "../../infra/restart.js";
-import { normalizeUpdateChannel } from "../../infra/update-channels.js";
-import { runGatewayUpdate } from "../../infra/update-runner.js";
-import {
-  ErrorCodes,
-  errorShape,
-  formatValidationErrors,
-  validateUpdateRunParams,
-} from "../protocol/index.js";
-
 export const updateHandlers: GatewayRequestHandlers = {
   "update.run": async ({ params, respond }) => {
     if (!validateUpdateRunParams(params)) {
diff --git a/src/gateway/server-plugins.test.ts b/src/gateway/server-plugins.test.ts
index 847b89543..1bc7ddcac 100644
--- a/src/gateway/server-plugins.test.ts
+++ b/src/gateway/server-plugins.test.ts
@@ -24,44 +24,6 @@ const createRegistry = (diagnostics: PluginDiagnostic[]): PluginRegistry => ({
   diagnostics,
 });
 
-describe("loadGatewayPlugins", () => {
-  test("logs plugin errors with details", () => {
-    const diagnostics: PluginDiagnostic[] = [
-      {
-        level: "error",
-        pluginId: "telegram",
-        source: "/tmp/telegram/index.ts",
-        message: "failed to load plugin: boom",
-      },
-    ];
-    loadTEXT2LLMPlugins.mockReturnValue(createRegistry(diagnostics));
-
-import { describe, expect, test, vi } from "vitest";
-import type { PluginRegistry } from "../plugins/registry.js";
-import type { PluginDiagnostic } from "../plugins/types.js";
-import { loadGatewayPlugins } from "./server-plugins.js";
-
-const loadTEXT2LLMPlugins = vi.hoisted(() => vi.fn());
-
-vi.mock("../plugins/loader.js", () => ({
-  loadTEXT2LLMPlugins,
-}));
-
-const createRegistry = (diagnostics: PluginDiagnostic[]): PluginRegistry => ({
-  plugins: [],
-  tools: [],
-  hooks: [],
-  typedHooks: [],
-  channels: [],
-  providers: [],
-  gatewayHandlers: {},
-  httpHandlers: [],
-  httpRoutes: [],
-  cliRegistrars: [],
-  services: [],
-  diagnostics,
-});
-
 describe("loadGatewayPlugins", () => {
   test("logs plugin errors with details", () => {
     const diagnostics: PluginDiagnostic[] = [
diff --git a/src/gateway/server-runtime-config.ts b/src/gateway/server-runtime-config.ts
index c971e9067..345dc1532 100644
--- a/src/gateway/server-runtime-config.ts
+++ b/src/gateway/server-runtime-config.ts
@@ -29,37 +29,6 @@ export type GatewayRuntimeConfig = {
   canvasHostEnabled: boolean;
 };
 
-export async function resolveGatewayRuntimeConimport type {
-  GatewayAuthConfig,
-  GatewayBindMode,
-  GatewayTailscaleConfig,
-  loadConfig,
-} from "../config/config.js";
-import {
-  assertGatewayAuthConfigured,
-  type ResolvedGatewayAuth,
-  resolveGatewayAuth,
-} from "./auth.js";
-import { normalizeControlUiBasePath } from "./control-ui-shared.js";
-import { resolveHooksConfig } from "./hooks.js";
-import { isLoopbackHost, resolveGatewayBindHost } from "./net.js";
-
-export type GatewayRuntimeConfig = {
-  bindHost: string;
-  controlUiEnabled: boolean;
-  openAiChatCompletionsEnabled: boolean;
-  openResponsesEnabled: boolean;
-  openResponsesConfig?: import("../config/types.gateway.js").GatewayHttpResponsesConfig;
-  controlUiBasePath: string;
-  controlUiRoot?: string;
-  resolvedAuth: ResolvedGatewayAuth;
-  authMode: ResolvedGatewayAuth["mode"];
-  tailscaleConfig: GatewayTailscaleConfig;
-  tailscaleMode: "off" | "serve" | "funnel";
-  hooksConfig: ReturnType<typeof resolveHooksConfig>;
-  canvasHostEnabled: boolean;
-};
-
 export async function resolveGatewayRuntimeConfig(params: {
   cfg: ReturnType<typeof loadConfig>;
   port: number;
diff --git a/src/gateway/server.canvas-auth.e2e.test.ts b/src/gateway/server.canvas-auth.e2e.test.ts
index 163a304d0..740aba2d7 100644
--- a/src/gateway/server.canvas-auth.e2e.test.ts
+++ b/src/gateway/server.canvas-auth.e2e.test.ts
@@ -9,25 +9,6 @@ import type { GatewayWsClient } from "./server/ws-types.js";
 import { A2UI_PATH, CANVAS_HOST_PATH, CANVAS_WS_PATH } from "../canvas-host/a2ui.js";
 import { attachGatewayUpgradeHandler, createGatewayHttpServer } from "./server-http.js";
 
-async function withTempConfig(params: { cfg: unknown; run: () => Promise<void> }): Promise<void> {
-  const prevConfigPath = process.env.TEXT2LLM_CONFIG_PATH;
-  const prevDisableCache = process.env.TEXT2LLM_DISABLE_CONFIG_CACHE;
-
-  const dir = await mkdtemp(path.join(os.tmpdir(), "text2llm-canvas-auth-test-"));
-  const configPath = path.join(dir, "text2llm.json");
-
-  process.env.TEXT2LLM_CONFIG_PATH = configPath;
-  process.env.TEXT2LLM_DISABLE_CONFIGimport { mkdtemp, rm, writeFile } from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { describe, expect, test } from "vitest";
-import { WebSocket, WebSocketServer } from "ws";
-import type { CanvasHostHandler } from "../canvas-host/server.js";
-import type { ResolvedGatewayAuth } from "./auth.js";
-import type { GatewayWsClient } from "./server/ws-types.js";
-import { A2UI_PATH, CANVAS_HOST_PATH, CANVAS_WS_PATH } from "../canvas-host/a2ui.js";
-import { attachGatewayUpgradeHandler, createGatewayHttpServer } from "./server-http.js";
-
 async function withTempConfig(params: { cfg: unknown; run: () => Promise<void> }): Promise<void> {
   const prevConfigPath = process.env.TEXT2LLM_CONFIG_PATH;
   const prevDisableCache = process.env.TEXT2LLM_DISABLE_CONFIG_CACHE;
diff --git a/src/gateway/session-utils.ts b/src/gateway/session-utils.ts
index a8b780890..71d54313d 100644
--- a/src/gateway/session-utils.ts
+++ b/src/gateway/session-utils.ts
@@ -30,38 +30,6 @@ import {
   normalizeMainKey,
   parseAgentSessionKey,
 } from "../routing/session-key.js";
-import fs from "node:fs";
-import path from "node:path";
-import type {
-  GatewayAgentRow,
-  GatewaySessionRow,
-  GatewaySessionsDefaults,
-  SessionsListResult,
-} from "./session-utils.types.js";
-import { resolveAgentWorkspaceDir, resolveDefaultAgentId } from "../agents/agent-scope.js";
-import { lookupContextTokens } from "../agents/context.js";
-import { DEFAULT_CONTEXT_TOKENS, DEFAULT_MODEL, DEFAULT_PROVIDER } from "../agents/defaults.js";
-import {
-  resolveConfiguredModelRef,
-  resolveDefaultModelForAgent,
-} from "../agents/model-selection.js";
-import { type TEXT2LLMConfig, loadConfig } from "../config/config.js";
-import { resolveStateDir } from "../config/paths.js";
-import {
-  buildGroupDisplayName,
-  canonicalizeMainSessionAlias,
-  loadSessionStore,
-  resolveFreshSessionTotalTokens,
-  resolveMainSessionKey,
-  resolveStorePath,
-  type SessionEntry,
-  type SessionScope,
-} from "../config/sessions.js";
-import {
-  normalizeAgentId,
-  normalizeMainKey,
-  parseAgentSessionKey,
-} from "../routing/session-key.js";
 import { isCronRunSessionKey } from "../sessions/session-key-utils.js";
 import { normalizeSessionDeliveryFields } from "../utils/delivery-context.js";
 import {
diff --git a/src/gateway/test-helpers.server.ts b/src/gateway/test-helpers.server.ts
index 566b76fac..e14d17989 100644
--- a/src/gateway/test-helpers.server.ts
+++ b/src/gateway/test-helpers.server.ts
@@ -17,25 +17,6 @@ import { rawDataToString } from "../infra/ws.js";
 import { resetLogger, setLoggerOverride } from "../logging.js";
 import { DEFAULT_AGENT_ID, toAgentStoreSessionKey } from "../routing/session-key.js";
 import { getDeterministicFreePortBlock } from "../test-utils/ports.js";
-import { GATEWAY_CLIENT_MODES, GATEWAY_CLIENT_NAMES } froimport fs from "node:fs/promises";
-import { type AddressInfo, createServer } from "node:net";
-import os from "node:os";
-import path from "node:path";
-import { afterAll, afterEach, beforeAll, beforeEach, expect, vi } from "vitest";
-import { WebSocket } from "ws";
-import type { GatewayServerOptions } from "./server.js";
-import { resolveMainSessionKeyFromConfig, type SessionEntry } from "../config/sessions.js";
-import { resetAgentRunContextForTest } from "../infra/agent-events.js";
-import {
-  loadOrCreateDeviceIdentity,
-  publicKeyRawBase64UrlFromPem,
-  signDevicePayload,
-} from "../infra/device-identity.js";
-import { drainSystemEvents, peekSystemEvents } from "../infra/system-events.js";
-import { rawDataToString } from "../infra/ws.js";
-import { resetLogger, setLoggerOverride } from "../logging.js";
-import { DEFAULT_AGENT_ID, toAgentStoreSessionKey } from "../routing/session-key.js";
-import { getDeterministicFreePortBlock } from "../test-utils/ports.js";
 import { GATEWAY_CLIENT_MODES, GATEWAY_CLIENT_NAMES } from "../utils/message-channel.js";
 import { buildDeviceAuthPayload } from "./device-auth.js";
 import { PROTOCOL_VERSION } from "./protocol/index.js";
diff --git a/src/hooks/bundled/session-memory/handler.test.ts b/src/hooks/bundled/session-memory/handler.test.ts
index 508063939..6a4dc3a53 100644
--- a/src/hooks/bundled/session-memory/handler.test.ts
+++ b/src/hooks/bundled/session-memory/handler.test.ts
@@ -17,35 +17,6 @@ beforeAll(async () => {
   ({ default: handler } = await import("./handler.js"));
 });
 
-/**
- * Create a mock session JSONL file with various entry types
- */
-function createMockSessionContent(
-  entries: Array<{ role: string; content: string } | { type: string }>,
-): string {
-  return entries
-    .map((entry) => {
-      if ("role" in entry) {
-        return JSON.stringify({
-          type: "messaimport fs from "node:fs/promises";
-import path from "node:path";
-import { beforeAll, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../../config/config.js";
-import type { HookHandler } from "../../hooks.js";
-import { makeTempWorkspace, writeWorkspaceFile } from "../../../test-helpers/workspace.js";
-import { createHookEvent } from "../../hooks.js";
-
-// Avoid calling the embedded Pi agent (global command lane); keep this unit test deterministic.
-vi.mock("../../llm-slug-generator.js", () => ({
-  generateSlugViaLLM: vi.fn().mockResolvedValue("simple-math"),
-}));
-
-let handler: HookHandler;
-
-beforeAll(async () => {
-  ({ default: handler } = await import("./handler.js"));
-});
-
 /**
  * Create a mock session JSONL file with various entry types
  */
diff --git a/src/hooks/frontmatter.ts b/src/hooks/frontmatter.ts
index b2d32a9f8..aeedb6330 100644
--- a/src/hooks/frontmatter.ts
+++ b/src/hooks/frontmatter.ts
@@ -30,42 +30,6 @@ function normalizeStringList(input: unknown): string[] {
   return [];
 }
 
-function parseInstallSpec(input: unknown): HookInstallSpec | undefined {
-  if (!input || typeof input !== "object") {
-    return undefined;
-  }
-  const raw = input as Record<string, unkimport JSON5 from "json5";
-import type {
-  TEXT2LLMHookMetadata,
-  HookEntry,
-  HookInstallSpec,
-  HookInvocationPolicy,
-  ParsedHookFrontmatter,
-} from "./types.js";
-import { LEGACY_MANIFEST_KEYS, MANIFEST_KEY } from "../compat/legacy-names.js";
-import { parseFrontmatterBlock } from "../markdown/frontmatter.js";
-import { parseBooleanValue } from "../utils/boolean.js";
-
-export function parseFrontmatter(content: string): ParsedHookFrontmatter {
-  return parseFrontmatterBlock(content);
-}
-
-function normalizeStringList(input: unknown): string[] {
-  if (!input) {
-    return [];
-  }
-  if (Array.isArray(input)) {
-    return input.map((value) => String(value).trim()).filter(Boolean);
-  }
-  if (typeof input === "string") {
-    return input
-      .split(",")
-      .map((value) => value.trim())
-      .filter(Boolean);
-  }
-  return [];
-}
-
 function parseInstallSpec(input: unknown): HookInstallSpec | undefined {
   if (!input || typeof input !== "object") {
     return undefined;
diff --git a/src/hooks/gmail-watcher.ts b/src/hooks/gmail-watcher.ts
index 6a7f3a0e0..9cceb602b 100644
--- a/src/hooks/gmail-watcher.ts
+++ b/src/hooks/gmail-watcher.ts
@@ -26,36 +26,6 @@ export function isAddressInUseError(line: string): boolean {
   return ADDRESS_IN_USE_RE.test(line);
 }
 
-let watcherProcess: ChildProcess | null = null;
-let renewInterval: ReturnType<typeof setInterval> | null = null;
-let shuttingDown = fal/**
- * Gmail Watcher Service
- *
- * Automatically starts `gog gmail watch serve` when the gateway starts,
- * if hooks.gmail is configured with an account.
- */
-
-import { type ChildProcess, spawn } from "node:child_process";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { hasBinary } from "../agents/skills.js";
-import { createSubsystemLogger } from "../logging/subsystem.js";
-import { runCommandWithTimeout } from "../process/exec.js";
-import { ensureTailscaleEndpoint } from "./gmail-setup-utils.js";
-import {
-  buildGogWatchServeArgs,
-  buildGogWatchStartArgs,
-  type GmailHookRuntimeConfig,
-  resolveGmailHookRuntimeConfig,
-} from "./gmail.js";
-
-const log = createSubsystemLogger("gmail-watcher");
-
-const ADDRESS_IN_USE_RE = /address already in use|EADDRINUSE/i;
-
-export function isAddressInUseError(line: string): boolean {
-  return ADDRESS_IN_USE_RE.test(line);
-}
-
 let watcherProcess: ChildProcess | null = null;
 let renewInterval: ReturnType<typeof setInterval> | null = null;
 let shuttingDown = false;
diff --git a/src/hooks/hooks-install.e2e.test.ts b/src/hooks/hooks-install.e2e.test.ts
index 014cd40f0..45e3c24c9 100644
--- a/src/hooks/hooks-install.e2e.test.ts
+++ b/src/hooks/hooks-install.e2e.test.ts
@@ -11,37 +11,6 @@ async function makeTempDir() {
   return dir;
 }
 
-describe("hooks install (e2e)", () => {
-  let prevStateDir: string | undefined;
-  let prevBundledDir: string | undefined;
-  let workspaceDir: string;
-
-  beforeEach(async () => {
-    const baseDir = await makeTempDir();
-    workspaceDir = path.join(baseDir, "workspace");
-    await fs.mkdir(workspaceDir, { recursive: true });
-
-    prevStateDir = process.env.TEXT2LLM_STATE_DIR;
-    prevBundledDir = process.env.TEXT2LLM_BUNDLED_HOOKS_DIR;
-    process.env.TEXT2LLM_STATE_DIR = path.join(baseDir, "state");
-    process.env.TEXT2LLM_BUNDLED_HOOKS_DIR = path.join(baseDir, "bundled-none");
-    vi.resetModules();
-  });
-
-  afterEach(async () => {
-    if (prevStateDir === undefined)import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-
-const tempDirs: string[] = [];
-
-async function makeTempDir() {
-  const dir = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-hooks-e2e-"));
-  tempDirs.push(dir);
-  return dir;
-}
-
 describe("hooks install (e2e)", () => {
   let prevStateDir: string | undefined;
   let prevBundledDir: string | undefined;
diff --git a/src/index.ts b/src/index.ts
index 1be4f3970..c8606914f 100644
--- a/src/index.ts
+++ b/src/index.ts
@@ -21,34 +21,6 @@ import { normalizeEnv } from "./infra/env.js";
 import { formatUncaughtError } from "./infra/errors.js";
 import { isMainModule } from "./infra/is-main.js";
 import { ensureTEXT2LLMCliOnPath } from "./infra/path-env.js";
-import {
-  describePortOwner,
-  ensurePortAvailable,
-  handlePortError,
-  PortInUseError,
-} from "./i#!/usr/bin/env node
-import process from "node:process";
-import { fileURLToPath } from "node:url";
-import { getReplyFromConfig } from "./auto-reply/reply.js";
-import { applyTemplate } from "./auto-reply/templating.js";
-import { monitorWebChannel } from "./channel-web.js";
-import { createDefaultDeps } from "./cli/deps.js";
-import { promptYesNo } from "./cli/prompt.js";
-import { waitForever } from "./cli/wait.js";
-import { loadConfig } from "./config/config.js";
-import {
-  deriveSessionKey,
-  loadSessionStore,
-  resolveSessionKey,
-  resolveStorePath,
-  saveSessionStore,
-} from "./config/sessions.js";
-import { ensureBinary } from "./infra/binaries.js";
-import { loadDotEnv } from "./infra/dotenv.js";
-import { normalizeEnv } from "./infra/env.js";
-import { formatUncaughtError } from "./infra/errors.js";
-import { isMainModule } from "./infra/is-main.js";
-import { ensureTEXT2LLMCliOnPath } from "./infra/path-env.js";
 import {
   describePortOwner,
   ensurePortAvailable,
diff --git a/src/infra/bonjour-discovery.test.ts b/src/infra/bonjour-discovery.test.ts
index efb79d1b9..eb54ffa72 100644
--- a/src/infra/bonjour-discovery.test.ts
+++ b/src/infra/bonjour-discovery.test.ts
@@ -4,30 +4,6 @@ import { discoverGatewayBeacons } from "./bonjour-discovery.js";
 
 const WIDE_AREA_DOMAIN = "text2llm.internal.";
 
-describe("bonjour-discovery", () => {
-  it("discovers beacons on darwin across local + wide-area domains", async () => {
-    const calls: Array<{ argv: string[]; timeoutMs: number }> = [];
-    const studioInstance = "PeterΓÇÖs Mac Studio Gateway";
-
-    const run = vi.fn(async (argv: string[], options: { timeoutMs: number }) => {
-      calls.push({ argv, timeoutMs: options.timeoutMs });
-      const domain = argv[3] ?? "";
-
-      if (argv[0] === "dns-sd" && argv[1] === "-B") {
-        if (domain === "local.") {
-          return {
-            stdout: [
-              "Add 2 3 local. _TEXT2LLM-gw._tcp. Peter\\226\\128\\153s Mac Studio Gateway",
-              "Add 2 3 local. _TEXT2LLM-gw._tcp. Laptop Gateway",
-              "",
-            ].join("\n"),
-            stderr: "",
-            import { describe, expect, it, vi } from "vitest";
-import type { runCommandWithTimeout } from "../process/exec.js";
-import { discoverGatewayBeacons } from "./bonjour-discovery.js";
-
-const WIDE_AREA_DOMAIN = "text2llm.internal.";
-
 describe("bonjour-discovery", () => {
   it("discovers beacons on darwin across local + wide-area domains", async () => {
     const calls: Array<{ argv: string[]; timeoutMs: number }> = [];
diff --git a/src/infra/bonjour-discovery.ts b/src/infra/bonjour-discovery.ts
index 67cb2fda5..5a524eda2 100644
--- a/src/infra/bonjour-discovery.ts
+++ b/src/infra/bonjour-discovery.ts
@@ -30,47 +30,6 @@ export type GatewayBonjourDiscoverOpts = {
 const DEFAULT_TIMEOUT_MS = 2000;
 const GATEWAY_SERVICE_TYPE = "_TEXT2LLM-gw._tcp";
 
-function decodeDnsSdEscapes(value: string): string {
-  let decoded = false;
-  const bytes: number[] = [];
-  let pending = "";
-
-  const flush = () => {
-    if (!pending) {
-      return;
-    }
-    bytes.push(...Buffer.from(pending, "utfimport { runCommandWithTimeout } from "../process/exec.js";
-import { resolveWideAreaDiscoveryDomain } from "./widearea-dns.js";
-
-export type GatewayBonjourBeacon = {
-  instanceName: string;
-  domain?: string;
-  displayName?: string;
-  host?: string;
-  port?: number;
-  lanHost?: string;
-  tailnetDns?: string;
-  gatewayPort?: number;
-  sshPort?: number;
-  gatewayTls?: boolean;
-  gatewayTlsFingerprintSha256?: string;
-  cliPath?: string;
-  role?: string;
-  transport?: string;
-  txt?: Record<string, string>;
-};
-
-export type GatewayBonjourDiscoverOpts = {
-  timeoutMs?: number;
-  domains?: string[];
-  wideAreaDomain?: string | null;
-  platform?: NodeJS.Platform;
-  run?: typeof runCommandWithTimeout;
-};
-
-const DEFAULT_TIMEOUT_MS = 2000;
-const GATEWAY_SERVICE_TYPE = "_TEXT2LLM-gw._tcp";
-
 function decodeDnsSdEscapes(value: string): string {
   let decoded = false;
   const bytes: number[] = [];
diff --git a/src/infra/gateway-lock.test.ts b/src/infra/gateway-lock.test.ts
index fdd3a5d12..f2bedce26 100644
--- a/src/infra/gateway-lock.test.ts
+++ b/src/infra/gateway-lock.test.ts
@@ -26,35 +26,7 @@ async function makeEnv() {
 
 function resolveLockPath(env: NodeJS.ProcessEnv) {
   const stateDir = resolveStateDir(env);
-  const configPath = resolveConfigPath(env, stateDimport { createHash } from "node:crypto";
-import fsSync from "node:fs";
-import fs from "node:fs/promises";
-import os from "node:os";
-import path from "node:path";
-import { describe, expect, it, vi } from "vitest";
-import { resolveConfigPath, resolveGatewayLockDir, resolveStateDir } from "../config/paths.js";
-import { acquireGatewayLock, GatewayLockError } from "./gateway-lock.js";
-
-async function makeEnv() {
-  const dir = await fs.mkdtemp(path.join(os.tmpdir(), "text2llm-gateway-lock-"));
-  const configPath = path.join(dir, "text2llm.json");
-  await fs.writeFile(configPath, "{}", "utf8");
-  await fs.mkdir(resolveGatewayLockDir(), { recursive: true });
-  return {
-    env: {
-      ...process.env,
-      TEXT2LLM_STATE_DIR: dir,
-      TEXT2LLM_CONFIG_PATH: configPath,
-    },
-    cleanup: async () => {
-      await fs.rm(dir, { recursive: true, force: true });
-    },
-  };
-}
-
-function resolveLockPath(env: NodeJS.ProcessEnv) {
-  const stateDir = resolveStateDir(env);
-  const configPath = resolveConfigPath(env, stateDir);
+  const configPath = resolveConfigPath(env, stateDr);
   const hash = createHash("sha1").update(configPath).digest("hex").slice(0, 8);
   const lockDir = resolveGatewayLockDir();
   return { lockPath: path.join(lockDir, `gateway.${hash}.lock`), configPath };
diff --git a/src/infra/heartbeat-active-hours.ts b/src/infra/heartbeat-active-hours.ts
index 78d2cbbf5..3d66361b9 100644
--- a/src/infra/heartbeat-active-hours.ts
+++ b/src/infra/heartbeat-active-hours.ts
@@ -23,33 +23,6 @@ function resolveActiveHoursTimezone(cfg: TEXT2LLMConfig, raw?: string): string {
   }
 }
 
-function parseActiveHoursTime(opts: { allow24: boolean }, raw?: string): number | null {
-  if (!raw || !ACTIVE_HOURS_TIME_PATTERN.test(raw)) {
- import type { TEXT2LLMConfig } from "../config/config.js";
-import type { AgentDefaultsConfig } from "../config/types.agent-defaults.js";
-import { resolveUserTimezone } from "../agents/date-time.js";
-
-type HeartbeatConfig = AgentDefaultsConfig["heartbeat"];
-
-const ACTIVE_HOURS_TIME_PATTERN = /^([01]\d|2[0-3]|24):([0-5]\d)$/;
-
-function resolveActiveHoursTimezone(cfg: TEXT2LLMConfig, raw?: string): string {
-  const trimmed = raw?.trim();
-  if (!trimmed || trimmed === "user") {
-    return resolveUserTimezone(cfg.agents?.defaults?.userTimezone);
-  }
-  if (trimmed === "local") {
-    const host = Intl.DateTimeFormat().resolvedOptions().timeZone;
-    return host?.trim() || "UTC";
-  }
-  try {
-    new Intl.DateTimeFormat("en-US", { timeZone: trimmed }).format(new Date());
-    return trimmed;
-  } catch {
-    return resolveUserTimezone(cfg.agents?.defaults?.userTimezone);
-  }
-}
-
 function parseActiveHoursTime(opts: { allow24: boolean }, raw?: string): number | null {
   if (!raw || !ACTIVE_HOURS_TIME_PATTERN.test(raw)) {
     return null;
diff --git a/src/infra/heartbeat-visibility.test.ts b/src/infra/heartbeat-visibility.test.ts
index b58c37db1..9cdb4428a 100644
--- a/src/infra/heartbeat-visibility.test.ts
+++ b/src/infra/heartbeat-visibility.test.ts
@@ -2,44 +2,6 @@ import { describe, expect, it } from "vitest";
 import type { TEXT2LLMConfig } from "../config/config.js";
 import { resolveHeartbeatVisibility } from "./heartbeat-visibility.js";
 
-describe("resolveHeartbeatVisibility", () => {
-  it("returns default values when no config is provided", () => {
-    const cfg = {} as TEXT2LLMConfig;
-    const result = resolveHeartbeatVisibility({ cfg, channel: "telegram" });
-
-    expect(result).toEqual({
-      showOk: false,
-      showAlerts: true,
-      useIndicator: true,
-    });
-  });
-
-  it("uses channel defaults when provided", () => {
-    const cfg = {
-      channels: {
-        defaults: {
-          heartbeat: {
-            showOk: true,
-            showAlerts: false,
-            useIndicator: false,
-          },
-        },
-      },
-    } as TEXT2LLMConfig;
-
-    const result = resolveHeartbeatVisibility({ cfg, channel: "telegram" });
-
-    expect(result).toEqual({
-      showOk: true,
-      showAlerts: false,
-      useIndicator: false,
-    });
-  });
-
-  it("per-channel config ovimport { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveHeartbeatVisibility } from "./heartbeat-visibility.js";
-
 describe("resolveHeartbeatVisibility", () => {
   it("returns default values when no config is provided", () => {
     const cfg = {} as TEXT2LLMConfig;
diff --git a/src/infra/home-dir.test.ts b/src/infra/home-dir.test.ts
index a35ad016f..a199acdc9 100644
--- a/src/infra/home-dir.test.ts
+++ b/src/infra/home-dir.test.ts
@@ -2,32 +2,6 @@ import path from "node:path";
 import { describe, expect, it } from "vitest";
 import { expandHomePrefix, resolveEffectiveHomeDir, resolveRequiredHomeDir } from "./home-dir.js";
 
-describe("resolveEffectiveHomeDir", () => {
-  it("prefers TEXT2LLM_HOME over HOME and USERPROFILE", () => {
-    const env = {
-      TEXT2LLM_HOME: "/srv/text2llm-home",
-      HOME: "/home/other",
-      USERPROFILE: "C:/Users/other",
-    } as NodeJS.ProcessEnv;
-
-    expect(resolveEffectiveHomeDir(env, () => "/fallback")).toBe(
-      path.resolve("/srv/text2llm-home"),
-    );
-  });
-
-  it("falls back to HOME then USERPROFILE then homedir", () => {
-    expect(resolveEffectiveHomeDir({ HOME: "/home/alice" } as NodeJS.ProcessEnv)).toBe(
-      path.resolve("/home/alice"),
-    );
-    expect(resolveEffectiveHomeDir({ USERPROFILE: "C:/Users/alice" } as NodeJS.ProcessEnv)).toBe(
-      path.resolve("C:/Users/alice"),
-    );
-    expect(resolveEffectiveHomeDir({} as NodeJS.ProcessEnv, () => "/fallback")).toBe(
-      path.resolve("/fallback"),
-    );import path from "node:path";
-import { describe, expect, it } from "vitest";
-import { expandHomePrefix, resolveEffectiveHomeDir, resolveRequiredHomeDir } from "./home-dir.js";
-
 describe("resolveEffectiveHomeDir", () => {
   it("prefers TEXT2LLM_HOME over HOME and USERPROFILE", () => {
     const env = {
diff --git a/src/infra/infra-parsing.test.ts b/src/infra/infra-parsing.test.ts
index c56ce1b55..26158cdfc 100644
--- a/src/infra/infra-parsing.test.ts
+++ b/src/infra/infra-parsing.test.ts
@@ -5,27 +5,6 @@ import { isMainModule } from "./is-main.js";
 import { buildNodeShellCommand } from "./node-shell.js";
 import { parseSshTarget } from "./ssh-tunnel.js";
 
-describe("infra parsing", () => {
-  describe("diagnostic flags", () => {
-    it("merges config + env flags", () => {
-      const cfg = {
-        diagnostics: { flags: ["telegram.http", "cache.*"] },
-      } as TEXT2LLMConfig;
-      const env = {
-        TEXT2LLM_DIAGNOSTICS: "foo,bar",
-      } as NodeJS.ProcessEnv;
-
-      const flags = resolveDiagnosticFlags(cfg, env);
-      expect(flags).toEqual(expect.arrayContaining(["telegram.http", "cache.*", "foo", "bar"]));
-      expect(isDiagnosticFlagEnabled("telegram.http", cfg, env)).toBe(true);
-      expect(isDiagnosticFlagEnabled("cache.hit", cfg, env)).toBe(true);
-      expect(isDiagnosticFlagEnabled("foo", cfg, env)).toimport { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { isDiagnosticFlagEnabled, resolveDiagnosticFlags } from "./diagnostic-flags.js";
-import { isMainModule } from "./is-main.js";
-import { buildNodeShellCommand } from "./node-shell.js";
-import { parseSshTarget } from "./ssh-tunnel.js";
-
 describe("infra parsing", () => {
   describe("diagnostic flags", () => {
     it("merges config + env flags", () => {
diff --git a/src/infra/outbound/deliver.ts b/src/infra/outbound/deliver.ts
index 0cc845a71..0ce2f0d43 100644
--- a/src/infra/outbound/deliver.ts
+++ b/src/infra/outbound/deliver.ts
@@ -16,24 +16,6 @@ import {
 } from "../../auto-reply/chunk.js";
 import { resolveChannelMediaMaxBytes } from "../../channels/plugins/media-limits.js";
 import { loadChannelOutboundAdapter } from "../../channels/plugins/outbound/load.js";
-import { resolveMarkdownTableMode } from "../../config/markdown-taimport type { ReplyPayload } from "../../auto-reply/types.js";
-import type { ChannelOutboundAdapter } from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { sendMessageDiscord } from "../../discord/send.js";
-import type { sendMessageIMessage } from "../../imessage/send.js";
-import type { sendMessageSlack } from "../../slack/send.js";
-import type { sendMessageTelegram } from "../../telegram/send.js";
-import type { sendMessageWhatsApp } from "../../web/outbound.js";
-import type { NormalizedOutboundPayload } from "./payloads.js";
-import type { OutboundChannel } from "./targets.js";
-import {
-  chunkByParagraph,
-  chunkMarkdownTextWithMode,
-  resolveChunkMode,
-  resolveTextChunkLimit,
-} from "../../auto-reply/chunk.js";
-import { resolveChannelMediaMaxBytes } from "../../channels/plugins/media-limits.js";
-import { loadChannelOutboundAdapter } from "../../channels/plugins/outbound/load.js";
 import { resolveMarkdownTableMode } from "../../config/markdown-tables.js";
 import {
   appendAssistantMessageToSessionTranscript,
diff --git a/src/infra/outbound/message-action-runner.threading.test.ts b/src/infra/outbound/message-action-runner.threading.test.ts
index 64733bd09..e9582ab52 100644
--- a/src/infra/outbound/message-action-runner.threading.test.ts
+++ b/src/infra/outbound/message-action-runner.threading.test.ts
@@ -20,34 +20,6 @@ vi.mock("./outbound-send-service.js", async () => {
   };
 });
 
-vi.mock("../../config/sessions.js", async () => {
-  const actual = await vi.importActual<typeof import("../../config/sessions.js")>(
-    "../../config/sessions.js",
-  );
-  return {
-    ...actual,
-  import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { slackPlugin } from "../../../extensions/slack/src/channel.js";
-import { telegramPlugin } from "../../../extensions/telegram/src/channel.js";
-import { setActivePluginRegistry } from "../../plugins/runtime.js";
-import { createTestRegistry } from "../../test-utils/channel-plugins.js";
-
-const mocks = vi.hoisted(() => ({
-  executeSendAction: vi.fn(),
-  recordSessionMetaFromInbound: vi.fn(async () => ({ ok: true })),
-}));
-
-vi.mock("./outbound-send-service.js", async () => {
-  const actual = await vi.importActual<typeof import("./outbound-send-service.js")>(
-    "./outbound-send-service.js",
-  );
-  return {
-    ...actual,
-    executeSendAction: mocks.executeSendAction,
-  };
-});
-
 vi.mock("../../config/sessions.js", async () => {
   const actual = await vi.importActual<typeof import("../../config/sessions.js")>(
     "../../config/sessions.js",
diff --git a/src/infra/outbound/outbound-policy.test.ts b/src/infra/outbound/outbound-policy.test.ts
index 6f34be2d6..2eb66af62 100644
--- a/src/infra/outbound/outbound-policy.test.ts
+++ b/src/infra/outbound/outbound-policy.test.ts
@@ -21,46 +21,6 @@ const discordConfig = {
   },
 } as TEXT2LLMConfig;
 
-describe("outbound policy", () => {
-  it("blocks cross-provider sends by default", () => {
-    expect(() =>
-      enforceCrossContextPolicy({
-        cfg: slackConfig,
-        channel: "telegram",
-        action: "send",
-        args: { to: "telegram:@ops" },
-        toolContext: { currentChannelId: "C12345678", currentChannelProvider: "slack" },
-      }),
-    ).toThrow(/Cross-context messaging denied/);
-  });
-
-  it("allows cross-provider sends when enabled", () => {
-    const cfg = {
-      ...slackConfig,
-      tools: {
-        message: { crossContext: import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import {
-  applyCrossContextDecoration,
-  buildCrossContextDecoration,
-  enforceCrossContextPolicy,
-} from "./outbound-policy.js";
-
-const slackConfig = {
-  channels: {
-    slack: {
-      botToken: "xoxb-test",
-      appToken: "xapp-test",
-    },
-  },
-} as TEXT2LLMConfig;
-
-const discordConfig = {
-  channels: {
-    discord: {},
-  },
-} as TEXT2LLMConfig;
-
 describe("outbound policy", () => {
   it("blocks cross-provider sends by default", () => {
     expect(() =>
diff --git a/src/infra/outbound/outbound-policy.ts b/src/infra/outbound/outbound-policy.ts
index 8d3be2e1c..883fe8771 100644
--- a/src/infra/outbound/outbound-policy.ts
+++ b/src/infra/outbound/outbound-policy.ts
@@ -35,47 +35,6 @@ const CONTEXT_MARKER_ACTIONS = new Set<ChannelMessageActionName>([
   "sticker",
 ]);
 
-function resolveContextGuardTarget(
-  action: ChannelMessageActionName,
-  params: Record<string, unknown>,
-): string | undefined {
-  if (!CONTimport type {
-  ChannelId,
-  ChannelMessageActionName,
-  ChannelThreadingToolContext,
-} from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { getChannelMessageAdapter } from "./channel-adapters.js";
-import { normalizeTargetForProvider } from "./target-normalization.js";
-import { formatTargetDisplay, lookupDirectoryDisplay } from "./target-resolver.js";
-
-export type CrossContextDecoration = {
-  prefix: string;
-  suffix: string;
-  embeds?: unknown[];
-};
-
-const CONTEXT_GUARDED_ACTIONS = new Set<ChannelMessageActionName>([
-  "send",
-  "poll",
-  "reply",
-  "sendWithEffect",
-  "sendAttachment",
-  "thread-create",
-  "thread-reply",
-  "sticker",
-]);
-
-const CONTEXT_MARKER_ACTIONS = new Set<ChannelMessageActionName>([
-  "send",
-  "poll",
-  "reply",
-  "sendWithEffect",
-  "sendAttachment",
-  "thread-reply",
-  "sticker",
-]);
-
 function resolveContextGuardTarget(
   action: ChannelMessageActionName,
   params: Record<string, unknown>,
diff --git a/src/infra/outbound/outbound-session.ts b/src/infra/outbound/outbound-session.ts
index e53b62fe5..13dc6aed5 100644
--- a/src/infra/outbound/outbound-session.ts
+++ b/src/infra/outbound/outbound-session.ts
@@ -15,23 +15,6 @@ import {
   resolveSignalSender,
 } from "../../signal/identity.js";
 import { resolveSlackAccount } from "../../slack/accounts.js";
-import { createSlackWebClient } from "../../slackimport type { MsgContext } from "../../auto-reply/templating.js";
-import type { ChatType } from "../../channels/chat-type.js";
-import type { ChannelId } from "../../channels/plugins/types.js";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { ResolvedMessagingTarget } from "./target-resolver.js";
-import { getChannelPlugin } from "../../channels/plugins/index.js";
-import { recordSessionMetaFromInbound, resolveStorePath } from "../../config/sessions.js";
-import { parseDiscordTarget } from "../../discord/targets.js";
-import { parseIMessageTarget, normalizeIMessageHandle } from "../../imessage/targets.js";
-import { buildAgentSessionKey, type RoutePeer } from "../../routing/resolve-route.js";
-import { resolveThreadSessionKeys } from "../../routing/session-key.js";
-import {
-  resolveSignalPeerId,
-  resolveSignalRecipient,
-  resolveSignalSender,
-} from "../../signal/identity.js";
-import { resolveSlackAccount } from "../../slack/accounts.js";
 import { createSlackWebClient } from "../../slack/client.js";
 import { normalizeAllowListLower } from "../../slack/monitor/allow-list.js";
 import { parseSlackTarget } from "../../slack/targets.js";
diff --git a/src/infra/provider-usage.test.ts b/src/infra/provider-usage.test.ts
index edb8378b1..f5e33e223 100644
--- a/src/infra/provider-usage.test.ts
+++ b/src/infra/provider-usage.test.ts
@@ -10,38 +10,6 @@ import {
   type UsageSummary,
 } from "./provider-usage.js";
 
-describe("provider usage formatting", () => {
-  it("returns null when no usage is available", () => {
-    const summary: UsageSummary = { updatedAt: 0, providers: [] };
-    expect(formatUsageSummaryLine(summary)).toBeNull();
-  });
-
-  it("picks the most-used window for summary line", () => {
-    const summary: UsageSummary = {
-      updatedAt: 0,
-      providers: [
-        {
-          provider: "anthropic",
-          displayName: "Claude",
-          windows: [
-            { label: "5h", usedPercent: 10 },
-            { label: "Week", usedPercent: 60 },
-          ],
-        },
-      ],
-    };
-    const line = forimport fs from "node:fs";
-import path from "node:path";
-import { describe, expect, it, vi } from "vitest";
-import { withTempHome } from "../../test/helpers/temp-home.js";
-import { ensureAuthProfileStore, listProfilesForProvider } from "../agents/auth-profiles.js";
-import {
-  formatUsageReportLines,
-  formatUsageSummaryLine,
-  loadProviderUsageSummary,
-  type UsageSummary,
-} from "./provider-usage.js";
-
 describe("provider usage formatting", () => {
   it("returns null when no usage is available", () => {
     const summary: UsageSummary = { updatedAt: 0, providers: [] };
diff --git a/src/infra/session-maintenance-warning.ts b/src/infra/session-maintenance-warning.ts
index 87b5abc8d..fc9caea9b 100644
--- a/src/infra/session-maintenance-warning.ts
+++ b/src/infra/session-maintenance-warning.ts
@@ -30,39 +30,6 @@ function buildWarningContext(params: WarningParams): string {
     .join("|");
 }
 
-function formatDuration(ms: number): string {
-  if (ms >= import type { TEXT2LLMConfig } from "../config/config.js";
-import type { SessionEntry, SessionMaintenanceWarning } from "../config/sessions.js";
-import { isDeliverableMessageChannel, normalizeMessageChannel } from "../utils/message-channel.js";
-import { resolveSessionDeliveryTarget } from "./outbound/targets.js";
-import { enqueueSystemEvent } from "./system-events.js";
-
-type WarningParams = {
-  cfg: TEXT2LLMConfig;
-  sessionKey: string;
-  entry: SessionEntry;
-  warning: SessionMaintenanceWarning;
-};
-
-const warnedContexts = new Map<string, string>();
-
-function shouldSendWarning(): boolean {
-  return !process.env.VITEST && process.env.NODE_ENV !== "test";
-}
-
-function buildWarningContext(params: WarningParams): string {
-  const { warning } = params;
-  return [
-    warning.activeSessionKey,
-    warning.pruneAfterMs,
-    warning.maxEntries,
-    warning.wouldPrune ? "prune" : "",
-    warning.wouldCap ? "cap" : "",
-  ]
-    .filter(Boolean)
-    .join("|");
-}
-
 function formatDuration(ms: number): string {
   if (ms >= 86_400_000) {
     const days = Math.round(ms / 86_400_000);
diff --git a/src/infra/system-presence.ts b/src/infra/system-presence.ts
index f0d63f4d3..018edd96c 100644
--- a/src/infra/system-presence.ts
+++ b/src/infra/system-presence.ts
@@ -42,51 +42,6 @@ function normalizePresenceKey(key: string | undefined): string | undefined {
   return trimmed.toLowerCase();
 }
 
-function resolvePrimaryIPv4(): string | undefined {
-  const nets = os.networimport { spawnSync } from "node:child_process";
-import os from "node:os";
-
-export type SystemPresence = {
-  host?: string;
-  ip?: string;
-  version?: string;
-  platform?: string;
-  deviceFamily?: string;
-  modelIdentifier?: string;
-  lastInputSeconds?: number;
-  mode?: string;
-  reason?: string;
-  deviceId?: string;
-  roles?: string[];
-  scopes?: string[];
-  instanceId?: string;
-  text: string;
-  ts: number;
-};
-
-export type SystemPresenceUpdate = {
-  key: string;
-  previous?: SystemPresence;
-  next: SystemPresence;
-  changes: Partial<SystemPresence>;
-  changedKeys: (keyof SystemPresence)[];
-};
-
-const entries = new Map<string, SystemPresence>();
-const TTL_MS = 5 * 60 * 1000; // 5 minutes
-const MAX_ENTRIES = 200;
-
-function normalizePresenceKey(key: string | undefined): string | undefined {
-  if (!key) {
-    return undefined;
-  }
-  const trimmed = key.trim();
-  if (!trimmed) {
-    return undefined;
-  }
-  return trimmed.toLowerCase();
-}
-
 function resolvePrimaryIPv4(): string | undefined {
   const nets = os.networkInterfaces();
   const prefer = ["en0", "eth0"];
diff --git a/src/infra/tmp-text2llm-dir.ts b/src/infra/tmp-text2llm-dir.ts
index ee6acb817..3f5464296 100644
--- a/src/infra/tmp-text2llm-dir.ts
+++ b/src/infra/tmp-text2llm-dir.ts
@@ -21,41 +21,6 @@ function isNodeErrorWithCode(err: unknown, code: string): err is MaybeNodeError
   );
 }
 
-export function resolvePreferredTEXT2LLMTmpDir(
-  options: ResolvePreferredTEXT2LLMTmpDirOptions = {},
-): string {
-  const accessSync = options.accessSync ?? fs.accessSync;
-  const statSync = options.statSync ?? fs.statSync;
-  const tmpdir = options.tmpdir ?? os.tmpdir;
-
-  try {
-    const preferred = statSync(POSIX_TEXT2LLM_TMP_DIR);
-    if (!preferred.isDirectory()) {
-      return path.join(tmpdir(), "text2llm");
-    }
-    accessSync(import fs from "node:fs";
-import os from "node:os";
-import path from "node:path";
-
-export const POSIX_TEXT2LLM_TMP_DIR = "/tmp/text2llm";
-
-type ResolvePreferredTEXT2LLMTmpDirOptions = {
-  accessSync?: (path: string, mode?: number) => void;
-  statSync?: (path: string) => { isDirectory(): boolean };
-  tmpdir?: () => string;
-};
-
-type MaybeNodeError = { code?: string };
-
-function isNodeErrorWithCode(err: unknown, code: string): err is MaybeNodeError {
-  return (
-    typeof err === "object" &&
-    err !== null &&
-    "code" in err &&
-    (err as MaybeNodeError).code === code
-  );
-}
-
 export function resolvePreferredTEXT2LLMTmpDir(
   options: ResolvePreferredTEXT2LLMTmpDirOptions = {},
 ): string {
diff --git a/src/infra/warning-filter.test.ts b/src/infra/warning-filter.test.ts
index 25535e026..db22c651a 100644
--- a/src/infra/warning-filter.test.ts
+++ b/src/infra/warning-filter.test.ts
@@ -31,40 +31,7 @@ describe("warning filter", () => {
       }),
     ).toBe(true);
     expect(
-      shouldIgnoreWarnimport { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import { installProcessWarningFilter, shouldIgnoreWarning } from "./warning-filter.js";
-
-const warningFilterKey = Symbol.for("text2llm.warning-filter");
-const baseEmitWarning = process.emitWarning.bind(process);
-
-function resetWarningFilterInstallState(): void {
-  const globalState = globalThis as typeof globalThis & {
-    [warningFilterKey]?: { installed: boolean };
-  };
-  delete globalState[warningFilterKey];
-  process.emitWarning = baseEmitWarning;
-}
-
-describe("warning filter", () => {
-  beforeEach(() => {
-    resetWarningFilterInstallState();
-  });
-
-  afterEach(() => {
-    resetWarningFilterInstallState();
-    vi.restoreAllMocks();
-  });
-
-  it("suppresses known deprecation and experimental warning signatures", () => {
-    expect(
-      shouldIgnoreWarning({
-        name: "DeprecationWarning",
-        code: "DEP0040",
-        message: "The punycode module is deprecated.",
-      }),
-    ).toBe(true);
-    expect(
-      shouldIgnoreWarning({
+      shouldIgnoreWarnng({
         name: "DeprecationWarning",
         code: "DEP0060",
         message: "The `util._extend` API is deprecated.",
diff --git a/src/line/bot-handlers.ts b/src/line/bot-handlers.ts
index 004a620e5..b2e83e5cc 100644
--- a/src/line/bot-handlers.ts
+++ b/src/line/bot-handlers.ts
@@ -27,37 +27,6 @@ import {
 import { downloadLineMedia } from "./download.js";
 import { pushMessageLine, replyMessageLine } from "./send.js";
 
-interface MediaRef {
-  path: string;
-  contentType?import type {
-  WebhookEvent,
-  MessageEvent,
-  FollowEvent,
-  UnfollowEvent,
-  JoinEvent,
-  LeaveEvent,
-  PostbackEvent,
-  EventSource,
-} from "@line/bot-sdk";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { RuntimeEnv } from "../runtime.js";
-import type { LineGroupConfig, ResolvedLineAccount } from "./types.js";
-import { danger, logVerbose } from "../globals.js";
-import { resolvePairingIdLabel } from "../pairing/pairing-labels.js";
-import { buildPairingReply } from "../pairing/pairing-messages.js";
-import {
-  readChannelAllowFromStore,
-  upsertChannelPairingRequest,
-} from "../pairing/pairing-store.js";
-import { firstDefined, isSenderAllowed, normalizeAllowFromWithStore } from "./bot-access.js";
-import {
-  buildLineMessageContext,
-  buildLinePostbackContext,
-  type LineInboundContext,
-} from "./bot-message-context.js";
-import { downloadLineMedia } from "./download.js";
-import { pushMessageLine, replyMessageLine } from "./send.js";
-
 interface MediaRef {
   path: string;
   contentType?: string;
diff --git a/src/logging/config.ts b/src/logging/config.ts
index b3c5550bc..754f69cc9 100644
--- a/src/logging/config.ts
+++ b/src/logging/config.ts
@@ -22,27 +22,3 @@ export function readLoggingConfig(): LoggingConfig | undefined {
     return undefined;
   }
 }
-import json5 from "json5";
-import fs from "node:fs";
-import type { TEXT2LLMConfig } from "../config/types.js";
-import { resolveConfigPath } from "../config/paths.js";
-
-type LoggingConfig = TEXT2LLMConfig["logging"];
-
-export function readLoggingConfig(): LoggingConfig | undefined {
-  const configPath = resolveConfigPath();
-  try {
-    if (!fs.existsSync(configPath)) {
-      return undefined;
-    }
-    const raw = fs.readFileSync(configPath, "utf-8");
-    const parsed = json5.parse(raw);
-    const logging = parsed?.logging;
-    if (!logging || typeof logging !== "object" || Array.isArray(logging)) {
-      return undefined;
-    }
-    return logging as LoggingConfig;
-  } catch {
-    return undefined;
-  }
-}
diff --git a/src/logging/console.ts b/src/logging/console.ts
index ccf4b7fd2..4305d21fa 100644
--- a/src/logging/console.ts
+++ b/src/logging/console.ts
@@ -24,37 +24,6 @@ function normalizeConsoleLevel(level?: string): LogLevel {
   return normalizeLogLevel(level, "info");
 }
 
-function normalizeConsoleStyle(style?: string): ConsoleStyle {
-  if (style === "compact" || style === "json" || style === "pretty") {
-    return style;
-  }
-  if (!process.stdout.isTTY) {
-    reimport { createRequire } from "node:module";
-import util from "node:util";
-import type { TEXT2LLMConfig } from "../config/types.js";
-import { isVerbose } from "../globals.js";
-import { stripAnsi } from "../terminal/ansi.js";
-import { readLoggingConfig } from "./config.js";
-import { type LogLevel, normalizeLogLevel } from "./levels.js";
-import { getLogger, type LoggerSettings } from "./logger.js";
-import { loggingState } from "./state.js";
-
-export type ConsoleStyle = "pretty" | "compact" | "json";
-type ConsoleSettings = {
-  level: LogLevel;
-  style: ConsoleStyle;
-};
-export type ConsoleLoggerSettings = ConsoleSettings;
-
-const requireConfig = createRequire(import.meta.url);
-
-function normalizeConsoleLevel(level?: string): LogLevel {
-  if (isVerbose()) {
-    return "debug";
-  }
-  return normalizeLogLevel(level, "info");
-}
-
 function normalizeConsoleStyle(style?: string): ConsoleStyle {
   if (style === "compact" || style === "json" || style === "pretty") {
     return style;
diff --git a/src/logging/redact.ts b/src/logging/redact.ts
index 5c16fa492..7b0abac66 100644
--- a/src/logging/redact.ts
+++ b/src/logging/redact.ts
@@ -10,30 +10,6 @@ const DEFAULT_REDACT_MIN_LENGTH = 18;
 const DEFAULT_REDACT_KEEP_START = 6;
 const DEFAULT_REDACT_KEEP_END = 4;
 
-const DEFAULT_REDACT_PATTERNS: string[] = [
-  // ENV-style assignments.
-  String.raw`\b[A-Z0-9_]*(?:KEY|TOKEN|SECRET|PASSWORD|PASSWD)\b\s*[=:]\s*(["']?)([^\s"'\\]+)\1`,
-  // JSON fields.
-  String.raw`"(?:apiKey|token|secret|password|passwd|accessToken|refreshToken)"\s*:\s*"([^"]+)"`,
-  // CLI flags.
-  String.raw`--(?:api[-_]?key|token|secret|password|passwd)\s+(["']?)([^\s"']+)\1`,
-  // Authorization headers.
-  String.raw`Authorization\s*[:=]\s*Bearer\s+([A-Za-z0-9._\-+=]+)`,
-  String.raw`\bBearer\s+([A-Za-z0-9._\-+=]{18,})\b`,
-  // PEM blocks.
-  String.raw`-----BEGIN [A-Z ]*PRIVATE KEY-----[\s\S]+?-----END [A-Z ]*PRIVATE KEY-----`,
-  import { createRequire } from "node:module";
-import type { TEXT2LLMConfig } from "../config/config.js";
-
-const requireConfig = createRequire(import.meta.url);
-
-export type RedactSensitiveMode = "off" | "tools";
-
-const DEFAULT_REDACT_MODE: RedactSensitiveMode = "tools";
-const DEFAULT_REDACT_MIN_LENGTH = 18;
-const DEFAULT_REDACT_KEEP_START = 6;
-const DEFAULT_REDACT_KEEP_END = 4;
-
 const DEFAULT_REDACT_PATTERNS: string[] = [
   // ENV-style assignments.
   String.raw`\b[A-Z0-9_]*(?:KEY|TOKEN|SECRET|PASSWORD|PASSWD)\b\s*[=:]\s*(["']?)([^\s"'\\]+)\1`,
diff --git a/src/macos/relay-smoke.test.ts b/src/macos/relay-smoke.test.ts
index 0ab07ef79..f49f67aa4 100644
--- a/src/macos/relay-smoke.test.ts
+++ b/src/macos/relay-smoke.test.ts
@@ -24,36 +24,6 @@ describe("parseRelaySmokeTest", () => {
   });
 });
 
-describe("runRelaySmokeTest", () => {
-  it("runs qr smoke test", async () => {
-    await runRelaySmokeTest("qr");
-    const mod = await import("../web/qr-image.js");
-    expeimport { describe, expect, it, vi } from "vitest";
-import { parseRelaySmokeTest, runRelaySmokeTest } from "./relay-smoke.js";
-
-vi.mock("../web/qr-image.js", () => ({
-  renderQrPngBase64: vi.fn(async () => "base64"),
-}));
-
-describe("parseRelaySmokeTest", () => {
-  it("parses --smoke qr", () => {
-    expect(parseRelaySmokeTest(["--smoke", "qr"], {})).toBe("qr");
-  });
-
-  it("parses --smoke-qr", () => {
-    expect(parseRelaySmokeTest(["--smoke-qr"], {})).toBe("qr");
-  });
-
-  it("parses env var smoke mode only when no args", () => {
-    expect(parseRelaySmokeTest([], { TEXT2LLM_SMOKE_QR: "1" })).toBe("qr");
-    expect(parseRelaySmokeTest(["send"], { TEXT2LLM_SMOKE_QR: "1" })).toBe(null);
-  });
-
-  it("rejects unknown smoke values", () => {
-    expect(() => parseRelaySmokeTest(["--smoke", "nope"], {})).toThrow("Unknown smoke test");
-  });
-});
-
 describe("runRelaySmokeTest", () => {
   it("runs qr smoke test", async () => {
     await runRelaySmokeTest("qr");
diff --git a/src/media-understanding/audio-preflight.ts b/src/media-understanding/audio-preflight.ts
index 2e9c38ac8..963d5626e 100644
--- a/src/media-understanding/audio-preflight.ts
+++ b/src/media-understanding/audio-preflight.ts
@@ -11,33 +11,6 @@ import {
   runCapability,
 } from "./runner.js";
 
-/**
- * Transcribes the first audio attachment BEFORE mention checking.
- * This allows voice notes to be processed in group chats with requireMention: true.
- * Returns the transcript or undefined if transcription fails or no audio is found.
- */
-export async function transcribeFirstAudio(params: {
-  ctx: MsgContext;
-  cfg: TEXT2LLMConfig;
-  agentDir?: string;
-  providers?: Record<string, MediaUnderstandingProvider>;
-  activeModel?: ActiveMediaModel;
-}): Promise<string | undefined> {
-  const { ctx, cfg } = params;
-
-  // Check if audio transcription is enabled in import type { MsgContext } from "../auto-reply/templating.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { MediaUnderstandingProvider } from "./types.js";
-import { logVerbose, shouldLogVerbose } from "../globals.js";
-import { isAudioAttachment } from "./attachments.js";
-import {
-  type ActiveMediaModel,
-  buildProviderRegistry,
-  createMediaAttachmentCache,
-  normalizeMediaAttachments,
-  runCapability,
-} from "./runner.js";
-
 /**
  * Transcribes the first audio attachment BEFORE mention checking.
  * This allows voice notes to be processed in group chats with requireMention: true.
diff --git a/src/media-understanding/providers/deepgram/audio.live.test.ts b/src/media-understanding/providers/deepgram/audio.live.test.ts
index 6c6f82ada..345f1f23f 100644
--- a/src/media-understanding/providers/deepgram/audio.live.test.ts
+++ b/src/media-understanding/providers/deepgram/audio.live.test.ts
@@ -15,29 +15,6 @@ const LIVE =
 
 const describeLive = LIVE && DEEPGRAM_KEY ? describe : describe.skip;
 
-async function fetchSampleBuffer(url: string, timeoutMs: number): Promise<Buffer> {
-  const controller = new AbortController();
-  const timer = setTimeout(() => controller.abort(), Math.max(1, timeoutMs));
-  try {
-    const res = await fetch(url, { signal: controller.signal });
-    if (!res.ok) {
- import { describe, expect, it } from "vitest";
-import { isTruthyEnvValue } from "../../../infra/env.js";
-import { transcribeDeepgramAudio } from "./audio.js";
-
-const DEEPGRAM_KEY = process.env.DEEPGRAM_API_KEY ?? "";
-const DEEPGRAM_MODEL = process.env.DEEPGRAM_MODEL?.trim() || "nova-3";
-const DEEPGRAM_BASE_URL = process.env.DEEPGRAM_BASE_URL?.trim();
-const SAMPLE_URL =
-  process.env.DEEPGRAM_SAMPLE_URL?.trim() ||
-  "https://static.deepgram.com/examples/Bueller-Life-moves-pretty-fast.wav";
-const LIVE =
-  isTruthyEnvValue(process.env.DEEPGRAM_LIVE_TEST) ||
-  isTruthyEnvValue(process.env.LIVE) ||
-  isTruthyEnvValue(process.env.TEXT2LLM_LIVE_TEST);
-
-const describeLive = LIVE && DEEPGRAM_KEY ? describe : describe.skip;
-
 async function fetchSampleBuffer(url: string, timeoutMs: number): Promise<Buffer> {
   const controller = new AbortController();
   const timer = setTimeout(() => controller.abort(), Math.max(1, timeoutMs));
diff --git a/src/media-understanding/resolve.test.ts b/src/media-understanding/resolve.test.ts
index 56fc6f840..e6d999ba0 100644
--- a/src/media-understanding/resolve.test.ts
+++ b/src/media-understanding/resolve.test.ts
@@ -7,41 +7,6 @@ const providerRegistry = new Map([
   ["groq", { capabilities: ["audio"] }],
 ]);
 
-describe("resolveModelEntries", () => {
-  it("uses provider capabilities for shared entries without explicit caps", () => {
-    const cfg: TEXT2LLMConfig = {
-      tools: {
-        media: {
-          models: [{ provider: "openai", model: "gpt-5.2" }],
-        },
-      },
-    };
-
-    const imageEntries = resolveModelEntries({
-      cfg,
-      capability: "image",
-      providerRegistry,
-    });
-    expect(imageEntries).toHaveLength(1);
-
-    const audioEntries = resolveModelEntries({
-      cfg,
-      capability: "audio",
-      providerRegistry,
-    });
-    expect(audioEntries).toHaveLength(0);
-  });
-
-  it("keeps per-capability entries even without explicit caps", () => {
-    const cfg: TEXT2LLMConfigimport { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveEntriesWithActiveFallback, resolveModelEntries } from "./resolve.js";
-
-const providerRegistry = new Map([
-  ["openai", { capabilities: ["image"] }],
-  ["groq", { capabilities: ["audio"] }],
-]);
-
 describe("resolveModelEntries", () => {
   it("uses provider capabilities for shared entries without explicit caps", () => {
     const cfg: TEXT2LLMConfig = {
diff --git a/src/media-understanding/types.ts b/src/media-understanding/types.ts
index 8cf8ad4e1..35c70222b 100644
--- a/src/media-understanding/types.ts
+++ b/src/media-understanding/types.ts
@@ -42,51 +42,6 @@ export type MediaUnderstandingAttachmentDecision = {
   chosen?: MediaUnderstandingModelDecision;
 };
 
-export type MediaUnderstandingDecision = {
-  capability: export type MediaUnderstandingKind =
-  | "audio.transcription"
-  | "video.description"
-  | "image.description";
-
-export type MediaUnderstandingCapability = "image" | "audio" | "video";
-
-export type MediaAttachment = {
-  path?: string;
-  url?: string;
-  mime?: string;
-  index: number;
-  alreadyTranscribed?: boolean;
-};
-
-export type MediaUnderstandingOutput = {
-  kind: MediaUnderstandingKind;
-  attachmentIndex: number;
-  text: string;
-  provider: string;
-  model?: string;
-};
-
-export type MediaUnderstandingDecisionOutcome =
-  | "success"
-  | "skipped"
-  | "disabled"
-  | "no-attachment"
-  | "scope-deny";
-
-export type MediaUnderstandingModelDecision = {
-  provider?: string;
-  model?: string;
-  type: "provider" | "cli";
-  outcome: "success" | "skipped" | "failed";
-  reason?: string;
-};
-
-export type MediaUnderstandingAttachmentDecision = {
-  attachmentIndex: number;
-  attempts: MediaUnderstandingModelDecision[];
-  chosen?: MediaUnderstandingModelDecision;
-};
-
 export type MediaUnderstandingDecision = {
   capability: MediaUnderstandingCapability;
   outcome: MediaUnderstandingDecisionOutcome;
diff --git a/src/memory/batch-gemini.ts b/src/memory/batch-gemini.ts
index f17fa57ab..4b651aaa9 100644
--- a/src/memory/batch-gemini.ts
+++ b/src/memory/batch-gemini.ts
@@ -33,43 +33,6 @@ export type GeminiBatchOutputLine = {
   error?: { message?: string };
 };
 
-const GEMINI_BATCH_MAX_REQUESTS = 50000;
-const debugEmbeddings = isTruthyEnvValue(process.env.TEXT2LLM_DEBUG_MEMORY_EMBEDDINGS);
-const log import type { GeminiEmbeddingClient } from "./embeddings-gemini.js";
-import { isTruthyEnvValue } from "../infra/env.js";
-import { createSubsystemLogger } from "../logging/subsystem.js";
-import { hashText } from "./internal.js";
-
-export type GeminiBatchRequest = {
-  custom_id: string;
-  content: { parts: Array<{ text: string }> };
-  taskType: "RETRIEVAL_DOCUMENT" | "RETRIEVAL_QUERY";
-};
-
-export type GeminiBatchStatus = {
-  name?: string;
-  state?: string;
-  outputConfig?: { file?: string; fileId?: string };
-  metadata?: {
-    output?: {
-      responsesFile?: string;
-    };
-  };
-  error?: { message?: string };
-};
-
-export type GeminiBatchOutputLine = {
-  key?: string;
-  custom_id?: string;
-  request_id?: string;
-  embedding?: { values?: number[] };
-  response?: {
-    embedding?: { values?: number[] };
-    error?: { message?: string };
-  };
-  error?: { message?: string };
-};
-
 const GEMINI_BATCH_MAX_REQUESTS = 50000;
 const debugEmbeddings = isTruthyEnvValue(process.env.TEXT2LLM_DEBUG_MEMORY_EMBEDDINGS);
 const log = createSubsystemLogger("memory/embeddings");
diff --git a/src/plugins/services.ts b/src/plugins/services.ts
index 426daabac..112c60b82 100644
--- a/src/plugins/services.ts
+++ b/src/plugins/services.ts
@@ -9,40 +9,6 @@ export type PluginServicesHandle = {
   stop: () => Promise<void>;
 };
 
-export async function startPluginServices(params: {
-  registry: PluginRegistry;
-  config: TEXT2LLMConfig;
-  workspaceDir?: string;
-}): Promise<PluginServicesHandle> {
-  const running: Array<{
-    id: string;
-    stop?: () => void | Promise<void>;
-  }> = [];
-
-  for (const entry of params.registry.services) {
-    const service = entry.service;
-    try {
-      await service.start({
-        config: params.config,
-        workspaceDir: params.workspaceDir,
-        stateDir: STATE_DIR,
-        logger: {
-          info: (msg) => log.info(msg),
-          warn: (msg) => log.warn(msg),
-          error: (msg) => log.error(msg),
-          debug: (msg) => log.debug(msg),
-        },
-   import type { TEXT2LLMConfig } from "../config/config.js";
-import type { PluginRegistry } from "./registry.js";
-import { STATE_DIR } from "../config/paths.js";
-import { createSubsystemLogger } from "../logging/subsystem.js";
-
-const log = createSubsystemLogger("plugins");
-
-export type PluginServicesHandle = {
-  stop: () => Promise<void>;
-};
-
 export async function startPluginServices(params: {
   registry: PluginRegistry;
   config: TEXT2LLMConfig;
diff --git a/src/security/audit-extra.async.ts b/src/security/audit-extra.async.ts
index 9a4e637f0..35428c6ca 100644
--- a/src/security/audit-extra.async.ts
+++ b/src/security/audit-extra.async.ts
@@ -22,30 +22,6 @@ import {
   inspectPathPermissions,
   safeStat,
 } from "./audit-fs.js";
-impo/**
- * Asynchronous security audit collector functions.
- *
- * These functions perform I/O (filesystem, config reads) to detect security issues.
- */
-import JSON5 from "json5";
-import fs from "node:fs/promises";
-import path from "node:path";
-import type { TEXT2LLMConfig, ConfigFileSnapshot } from "../config/config.js";
-import type { ExecFn } from "./windows-acl.js";
-import { resolveAgentWorkspaceDir, resolveDefaultAgentId } from "../agents/agent-scope.js";
-import { loadWorkspaceSkillEntries } from "../agents/skills.js";
-import { MANIFEST_KEY } from "../compat/legacy-names.js";
-import { resolveNativeSkillsEnabled } from "../config/commands.js";
-import { createConfigIO } from "../config/config.js";
-import { INCLUDE_KEY, MAX_INCLUDE_DEPTH } from "../config/includes.js";
-import { resolveOAuthDir } from "../config/paths.js";
-import { normalizeAgentId } from "../routing/session-key.js";
-import {
-  formatPermissionDetail,
-  formatPermissionRemediation,
-  inspectPathPermissions,
-  safeStat,
-} from "./audit-fs.js";
 import { scanDirectoryWithSummary, type SkillScanFinding } from "./skill-scanner.js";
 
 export type SecurityAuditFinding = {
diff --git a/src/signal/accounts.ts b/src/signal/accounts.ts
index 228a29590..957020b82 100644
--- a/src/signal/accounts.ts
+++ b/src/signal/accounts.ts
@@ -27,38 +27,6 @@ export function listSignalAccountIds(cfg: TEXT2LLMConfig): string[] {
   return ids.toSorted((a, b) => a.localeCompare(b));
 }
 
-export function resolveDefaultSignalAccountId(cfg: TEXT2LLMConfig): string {
-  const ids = listSignalAccountIds(cfg);
-  if (ids.includes(DEFAULT_ACCOUNT_ID)) {
-    return import type { TEXT2LLMConfig } from "../config/config.js";
-import type { SignalAccountConfig } from "../config/types.js";
-import { DEFAULT_ACCOUNT_ID, normalizeAccountId } from "../routing/session-key.js";
-
-export type ResolvedSignalAccount = {
-  accountId: string;
-  enabled: boolean;
-  name?: string;
-  baseUrl: string;
-  configured: boolean;
-  config: SignalAccountConfig;
-};
-
-function listConfiguredAccountIds(cfg: TEXT2LLMConfig): string[] {
-  const accounts = cfg.channels?.signal?.accounts;
-  if (!accounts || typeof accounts !== "object") {
-    return [];
-  }
-  return Object.keys(accounts).filter(Boolean);
-}
-
-export function listSignalAccountIds(cfg: TEXT2LLMConfig): string[] {
-  const ids = listConfiguredAccountIds(cfg);
-  if (ids.length === 0) {
-    return [DEFAULT_ACCOUNT_ID];
-  }
-  return ids.toSorted((a, b) => a.localeCompare(b));
-}
-
 export function resolveDefaultSignalAccountId(cfg: TEXT2LLMConfig): string {
   const ids = listSignalAccountIds(cfg);
   if (ids.includes(DEFAULT_ACCOUNT_ID)) {
diff --git a/src/signal/monitor.ts b/src/signal/monitor.ts
index 6be1b18e5..f3b9d5ecb 100644
--- a/src/signal/monitor.ts
+++ b/src/signal/monitor.ts
@@ -14,22 +14,6 @@ import { spawnSignalDaemon } from "./daemon.js";
 import { isSignalSenderAllowed, type resolveSignalSender } from "./identity.js";
 import { createSignalEventHandler } from "./monitor/event-handler.js";
 import { sendMessageSignal } from "./send.js";
-impoimport type { ReplyPayload } from "../auto-reply/types.js";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { SignalReactionNotificationMode } from "../config/types.js";
-import type { RuntimeEnv } from "../runtime.js";
-import { chunkTextWithMode, resolveChunkMode, resolveTextChunkLimit } from "../auto-reply/chunk.js";
-import { DEFAULT_GROUP_HISTORY_LIMIT, type HistoryEntry } from "../auto-reply/reply/history.js";
-import { loadConfig } from "../config/config.js";
-import { waitForTransportReady } from "../infra/transport-ready.js";
-import { saveMediaBuffer } from "../media/store.js";
-import { normalizeE164 } from "../utils.js";
-import { resolveSignalAccount } from "./accounts.js";
-import { signalCheck, signalRpcRequest } from "./client.js";
-import { spawnSignalDaemon } from "./daemon.js";
-import { isSignalSenderAllowed, type resolveSignalSender } from "./identity.js";
-import { createSignalEventHandler } from "./monitor/event-handler.js";
-import { sendMessageSignal } from "./send.js";
 import { runSignalSseLoop } from "./sse-reconnect.js";
 
 type SignalReactionMessage = {
diff --git a/src/slack/monitor/context.test.ts b/src/slack/monitor/context.test.ts
index add740376..2b84ab2b0 100644
--- a/src/slack/monitor/context.test.ts
+++ b/src/slack/monitor/context.test.ts
@@ -4,42 +4,6 @@ import type { TEXT2LLMConfig } from "../../config/config.js";
 import type { RuntimeEnv } from "../../runtime.js";
 import { createSlackMonitorContext, normalizeSlackChannelType } from "./context.js";
 
-const baseParams = () => ({
-  cfg: {} as TEXT2LLMConfig,
-  accountId: "default",
-  botToken: "token",
-  app: { client: {} } as App,
-  runtime: {} as RuntimeEnv,
-  botUserId: "B1",
-  teamId: "T1",
-  apiAppId: "A1",
-  historyLimit: 0,
-  sessionScope: "per-sender" as const,
-  mainKey: "main",
-  dmEnabled: true,
-  dmPolicy: "open" as const,
-  allowFrom: [],
-  groupDmEnabled: true,
-  groupDmChannels: [],
-  defaultRequireMention: true,
-  groupPolicy: "open" as const,
-  useAccessGroups: false,
-  reactionMode: "off" as const,
-  reactionAllowlist: [],
-  replyToMode: "off" as const,
-  slashCommand: {
-    enabled: false,
-    name: "text2llm",
-    sessionPrefix: "slack:slash",
-    ephemeral: true,
-  },
-  textLimit: 4000,
-  ackReactionScopeimport type { App } from "@slack/bolt";
-import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import type { RuntimeEnv } from "../../runtime.js";
-import { createSlackMonitorContext, normalizeSlackChannelType } from "./context.js";
-
 const baseParams = () => ({
   cfg: {} as TEXT2LLMConfig,
   accountId: "default",
diff --git a/src/slack/monitor/slash.command-arg-menus.test.ts b/src/slack/monitor/slash.command-arg-menus.test.ts
index ede09a5e0..8dfb131a2 100644
--- a/src/slack/monitor/slash.command-arg-menus.test.ts
+++ b/src/slack/monitor/slash.command-arg-menus.test.ts
@@ -19,31 +19,6 @@ vi.mock("../../routing/resolve-route.js", () => ({
   resolveAgentRoute: (...args: unknown[]) => resolveAgentRouteMock(...args),
 }));
 
-vi.mock("../../agents/identity.js", async (importOriginal) => {
-  const actual = await importOriginal<typeof import("../../agents/identity.js")>();
-  return {
-    ...actual,
-    resolveEffectiveMessagesConfig: () => ({ responseimport { beforeEach, describe, expect, it, vi } from "vitest";
-import { registerSlackMonitorSlashCommands } from "./slash.js";
-
-const dispatchMock = vi.fn();
-const readAllowFromStoreMock = vi.fn();
-const upsertPairingRequestMock = vi.fn();
-const resolveAgentRouteMock = vi.fn();
-
-vi.mock("../../auto-reply/reply/provider-dispatcher.js", () => ({
-  dispatchReplyWithDispatcher: (...args: unknown[]) => dispatchMock(...args),
-}));
-
-vi.mock("../../pairing/pairing-store.js", () => ({
-  readChannelAllowFromStore: (...args: unknown[]) => readAllowFromStoreMock(...args),
-  upsertChannelPairingRequest: (...args: unknown[]) => upsertPairingRequestMock(...args),
-}));
-
-vi.mock("../../routing/resolve-route.js", () => ({
-  resolveAgentRoute: (...args: unknown[]) => resolveAgentRouteMock(...args),
-}));
-
 vi.mock("../../agents/identity.js", async (importOriginal) => {
   const actual = await importOriginal<typeof import("../../agents/identity.js")>();
   return {
diff --git a/src/slack/threading-tool-context.test.ts b/src/slack/threading-tool-context.test.ts
index b51fc2744..0e8532433 100644
--- a/src/slack/threading-tool-context.test.ts
+++ b/src/slack/threading-tool-context.test.ts
@@ -4,40 +4,6 @@ import { buildSlackThreadingToolContext } from "./threading-tool-context.js";
 
 const emptyCfg = {} as TEXT2LLMConfig;
 
-describe("buildSlackThreadingToolContext", () => {
-  it("uses top-level replyToMode by default", () => {
-    const cfg = {
-      channels: {
-        slack: { replyToMode: "first" },
-      },
-    } as TEXT2LLMConfig;
-    const result = buildSlackThreadingToolContext({
-      cfg,
-      accountId: null,
-      context: { ChatType: "channel" },
-    });
-    expect(result.replyToMode).toBe("first");
-  });
-
-  it("uses chat-type replyToMode overrides for direct messages when configured", () => {
-    const cfg = {
-      channels: {
-        slack: {
-          replyToMode: "off",
-          replyToModeByChatType: { direct: "all" },
-        },
-      },
-    } as TEXT2LLMConfig;
-    const result = buildSlackThreadingToolContext({
-      cfg,
-      accountId: null,
-      context: { ChatType: "direct" },
-  import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { buildSlackThreadingToolContext } from "./threading-tool-context.js";
-
-const emptyCfg = {} as TEXT2LLMConfig;
-
 describe("buildSlackThreadingToolContext", () => {
   it("uses top-level replyToMode by default", () => {
     const cfg = {
diff --git a/src/telegram/bot-native-commands.test.ts b/src/telegram/bot-native-commands.test.ts
index be362a1b2..25232cb95 100644
--- a/src/telegram/bot-native-commands.test.ts
+++ b/src/telegram/bot-native-commands.test.ts
@@ -12,36 +12,6 @@ vi.mock("../auto-reply/skill-commands.js", () => ({
   listSkillCommandsForAgents,
 }));
 
-describe("registerTelegramNativeCommands", () => {
-  beforeEach(() => {
-    listSkillCommandsForAgents.mockReset();
-  });
-
-  const buildParams = (cfg: TEXT2LLMConfig, accountId = "default") => ({
-    bot: {
-      api: {
-        setMyCommands: vi.fn().mockResolvedValue(undefined),
-        sendMessage: vi.fn().mockResolvedValue(undefined),
-      },
-      command: vi.fn(),
-    } as unknown as Parameters<typeof registerTelegramNativeCommands>[0]["bot"],
-    cfg,
-    runtime: {} as RuntimeEnv,
-    accountId,
-   import { beforeEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { TelegramAccountConfig } from "../config/types.js";
-import type { RuntimeEnv } from "../runtime.js";
-import { registerTelegramNativeCommands } from "./bot-native-commands.js";
-
-const { listSkillCommandsForAgents } = vi.hoisted(() => ({
-  listSkillCommandsForAgents: vi.fn(() => []),
-}));
-
-vi.mock("../auto-reply/skill-commands.js", () => ({
-  listSkillCommandsForAgents,
-}));
-
 describe("registerTelegramNativeCommands", () => {
   beforeEach(() => {
     listSkillCommandsForAgents.mockReset();
diff --git a/src/telegram/bot.media.downloads-media-file-path-no-file-download.test.ts b/src/telegram/bot.media.downloads-media-file-path-no-file-download.test.ts
index 731678ff6..e9312b398 100644
--- a/src/telegram/bot.media.downloads-media-file-path-no-file-download.test.ts
+++ b/src/telegram/bot.media.downloads-media-file-path-no-file-download.test.ts
@@ -25,34 +25,6 @@ type ApiStub = {
   setMyCommands: (commands: Array<{ command: string; description: string }>) => Promise<void>;
 };
 
-const apiStub: ApiStub = {
-  config: { use: useSpy },import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";
-import { resetInboundDedupe } from "../auto-reply/reply/inbound-dedupe.js";
-import * as ssrf from "../infra/net/ssrf.js";
-import { MEDIA_GROUP_TIMEOUT_MS } from "./bot-updates.js";
-
-const useSpy = vi.fn();
-const middlewareUseSpy = vi.fn();
-const onSpy = vi.fn();
-const stopSpy = vi.fn();
-const sendChatActionSpy = vi.fn();
-const cacheStickerSpy = vi.fn();
-const getCachedStickerSpy = vi.fn();
-const describeStickerImageSpy = vi.fn();
-const resolvePinnedHostname = ssrf.resolvePinnedHostname;
-const lookupMock = vi.fn();
-let resolvePinnedHostnameSpy: ReturnType<typeof vi.spyOn> = null;
-
-const sleep = async (ms: number) => {
-  await new Promise<void>((resolve) => setTimeout(resolve, ms));
-};
-
-type ApiStub = {
-  config: { use: (arg: unknown) => void };
-  sendChatAction: typeof sendChatActionSpy;
-  setMyCommands: (commands: Array<{ command: string; description: string }>) => Promise<void>;
-};
-
 const apiStub: ApiStub = {
   config: { use: useSpy },
   sendChatAction: sendChatActionSpy,
diff --git a/src/telegram/draft-chunking.test.ts b/src/telegram/draft-chunking.test.ts
index 275285f04..975760c43 100644
--- a/src/telegram/draft-chunking.test.ts
+++ b/src/telegram/draft-chunking.test.ts
@@ -2,37 +2,6 @@ import { describe, expect, it } from "vitest";
 import type { TEXT2LLMConfig } from "../../config/config.js";
 import { resolveTelegramDraftStreamingChunking } from "./draft-chunking.js";
 
-describe("resolveTelegramDraftStreamingChunking", () => {
-  it("uses smaller defaults than block streaming", () => {
-    const chunking = resolveTelegramDraftStreamingChunking(undefined, "default");
-    expect(chunking).toEqual({
-      minChars: 200,
-      maxChars: 800,
-      breakPreference: "paragraph",
-    });
-  });
-
-  it("clamps to telegram.textChunkLimit", () => {
-    const cfg: TEXT2LLMConfig = {
-      channels: { telegram: { allowFrom: ["*"], textChunkLimit: 150 } },
-    };
-    const chunking = resolveTelegramDraftStreamingChunking(cfg, "default");
-    expect(chunking).toEqual({
-      minChars: 150,
-      maxChars: 150,
-      breakPreference: "paragraph",
-    });
-  });
-
-  it("supports per-account overrides", () => {
-    const cfg: TEXT2LLMConfig = {
-      channels: {
-        telegram: {
-          allowFrom: ["*"],
-   import { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../../config/config.js";
-import { resolveTelegramDraftStreamingChunking } from "./draft-chunking.js";
-
 describe("resolveTelegramDraftStreamingChunking", () => {
   it("uses smaller defaults than block streaming", () => {
     const chunking = resolveTelegramDraftStreamingChunking(undefined, "default");
diff --git a/src/telegram/network-config.ts b/src/telegram/network-config.ts
index add713b2e..93690e394 100644
--- a/src/telegram/network-config.ts
+++ b/src/telegram/network-config.ts
@@ -11,33 +11,6 @@ export type TelegramAutoSelectFamilyDecision = {
   source?: string;
 };
 
-export function resolveTelegramAutoSelectFamilyDecision(params?: {
-  network?: TelegramNetworkConfig;
-  env?: NodeJS.ProcessEnv;
-  nodeMajor?: number;
-}): TelegramAutoSelectFamilyDecision {
-  const env = params?.env ?? process.env;
-  const nodeMajor =
-    typeof params?.nodeMajor === "number"
-      ? params.nodeMajor
-      : Number(process.versions.node.split(".")[0]);
-
-  if (isTruthyEnvValue(env[TELEGRAM_ENABLE_AUTO_SELECT_FAMILY_ENV])) {
-    return { value: true, source: `env:${TELEGRAM_ENABLE_AUTO_SELECT_FAMILY_ENV}` };
-  }
-  if (isTruthyEnvValue(eimport process from "node:process";
-import type { TelegramNetworkConfig } from "../config/types.telegram.js";
-import { isTruthyEnvValue } from "../infra/env.js";
-
-export const TELEGRAM_DISABLE_AUTO_SELECT_FAMILY_ENV =
-  "TEXT2LLM_TELEGRAM_DISABLE_AUTO_SELECT_FAMILY";
-export const TELEGRAM_ENABLE_AUTO_SELECT_FAMILY_ENV = "TEXT2LLM_TELEGRAM_ENABLE_AUTO_SELECT_FAMILY";
-
-export type TelegramAutoSelectFamilyDecision = {
-  value: boolean | null;
-  source?: string;
-};
-
 export function resolveTelegramAutoSelectFamilyDecision(params?: {
   network?: TelegramNetworkConfig;
   env?: NodeJS.ProcessEnv;
diff --git a/src/telegram/token.test.ts b/src/telegram/token.test.ts
index aef736f6f..1bdad1c65 100644
--- a/src/telegram/token.test.ts
+++ b/src/telegram/token.test.ts
@@ -9,38 +9,6 @@ function withTempDir(): string {
   return fs.mkdtempSync(path.join(os.tmpdir(), "text2llm-telegram-token-"));
 }
 
-describe("resolveTelegramToken", () => {
-  afterEach(() => {
-    vi.unstubAllEnvs();
-  });
-
-  it("prefers config token over env", () => {
-    vi.stubEnv("TELEGRAM_BOT_TOKEN", "env-token");
-    const cfg = {
-      channels: { telegram: { botToken: "cfg-token" } },
-    } as TEXT2LLMConfig;
-    const res = resolveTelegramToken(cfg);
-    expect(res.token).toBe("cfg-token");
-    expect(res.source).toBe("config");
-  });
-
-  it("uses env token when config is missing", () => {
-    vi.stubEnv("TELEGRAM_BOT_TOKEN", "env-token");
-    const cfg = {
-      channels: { telegram: {} },
-    } as TEXT2LLMConfig;
-    const res = resolveTelegramToken(cfg);
-    expect(rimport fs from "node:fs";
-import os from "node:os";
-import path from "node:path";
-import { afterEach, describe, expect, it, vi } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import { resolveTelegramToken } from "./token.js";
-
-function withTempDir(): string {
-  return fs.mkdtempSync(path.join(os.tmpdir(), "text2llm-telegram-token-"));
-}
-
 describe("resolveTelegramToken", () => {
   afterEach(() => {
     vi.unstubAllEnvs();
diff --git a/src/utils.ts b/src/utils.ts
index 44a171768..7aa7e725e 100644
--- a/src/utils.ts
+++ b/src/utils.ts
@@ -37,46 +37,7 @@ export function clampInt(value: number, min: number, max: number): number {
 export const clamp = clampNumber;
 
 /**
- * Escapes specimport fs from "node:fs";
-import os from "node:os";
-import path from "node:path";
-import { resolveOAuthDir } from "./config/paths.js";
-import { logVerbose, shouldLogVerbose } from "./globals.js";
-import {
-  expandHomePrefix,
-  resolveEffectiveHomeDir,
-  resolveRequiredHomeDir,
-} from "./infra/home-dir.js";
-
-export async function ensureDir(dir: string) {
-  await fs.promises.mkdir(dir, { recursive: true });
-}
-
-/**
- * Check if a file or directory exists at the given path.
- */
-export async function pathExists(targetPath: string): Promise<boolean> {
-  try {
-    await fs.promises.access(targetPath);
-    return true;
-  } catch {
-    return false;
-  }
-}
-
-export function clampNumber(value: number, min: number, max: number): number {
-  return Math.max(min, Math.min(max, value));
-}
-
-export function clampInt(value: number, min: number, max: number): number {
-  return clampNumber(Math.floor(value), min, max);
-}
-
-/** Alias for clampNumber (shorter, more common name) */
-export const clamp = clampNumber;
-
-/**
- * Escapes special regex characters in a string so it can be used in a RegExp constructor.
+ * Escapes specal regex characters in a string so it can be used in a RegExp constructor.
  */
 export function escapeRegExp(value: string): string {
   return value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
diff --git a/src/utils/provider-utils.ts b/src/utils/provider-utils.ts
index 046a23c78..8b4d59a76 100644
--- a/src/utils/provider-utils.ts
+++ b/src/utils/provider-utils.ts
@@ -16,18 +16,12 @@ export function isReasoningTagProvider(provider: string | undefined | null): boo
   // Check for exact matches or known prefixes/substrings for reasoning providers
   if (
     normalized === "ollama" ||
-    normalized === "google-gemini-cli" ||
-    normalized === "google-generative-ai"
+    normalized === "minimax"
   ) {
     return true;
   }
 
-  // Handle google-antigravity and its model variations (e.g. google-antigravity/gemini-3)
-  if (normalized.includes("google-antigravity")) {
-    return true;
-  }
-
-  // Handle Minimax (M2.1 is chatty/reasoning-like)
+  // Minimax uses tags because native reasoning streams are not available/reliable on some nodes
   if (normalized.includes("minimax")) {
     return true;
   }
diff --git a/src/web/reconnect.test.ts b/src/web/reconnect.test.ts
index 045db66c2..59a5df580 100644
--- a/src/web/reconnect.test.ts
+++ b/src/web/reconnect.test.ts
@@ -9,38 +9,6 @@ import {
   sleepWithAbort,
 } from "./reconnect.js";
 
-describe("web reconnect helpers", () => {
-  const cfg: TEXT2LLMConfig = {};
-
-  it("resolves sane reconnect defaults with clamps", () => {
-    const policy = resolveReconnectPolicy(cfg, {
-      initialMs: 100,
-      maxMs: 5,
-      factor: 20,
-      jitter: 2,
-      maxAttempts: -1,
-    });
-
-    expect(policy.initialMs).toBe(250); // clamped to minimum
-    expect(policy.maxMs).toBeGreaterThanOrEqual(policy.initialMs);
-    expect(policy.factor).toBeLessThanOrEqual(10);
-    expect(policy.jitter).toBeLessThanOrEqual(1);
-    expect(policy.maxAttempts).toBeGreaterThanOrEqual(0);
-  });
-
-  it("computes increasing backoff with jitter", () => {
-    const policy = { ...DEFAULT_RECONNECT_POLICY, jitter: 0 };
-    const first = computeBackofimport { describe, expect, it } from "vitest";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import {
-  computeBackoff,
-  DEFAULT_HEARTBEAT_SECONDS,
-  DEFAULT_RECONNECT_POLICY,
-  resolveHeartbeatSeconds,
-  resolveReconnectPolicy,
-  sleepWithAbort,
-} from "./reconnect.js";
-
 describe("web reconnect helpers", () => {
   const cfg: TEXT2LLMConfig = {};
 
diff --git a/src/web/reconnect.ts b/src/web/reconnect.ts
index 5eacfa028..6b146970f 100644
--- a/src/web/reconnect.ts
+++ b/src/web/reconnect.ts
@@ -25,38 +25,6 @@ export function resolveHeartbeatSeconds(cfg: TEXT2LLMConfig, overrideSeconds?: n
   return DEFAULT_HEARTBEAT_SECONDS;
 }
 
-export function resolveReconnectPolicy(
-  cfg: TEXT2LLMConfig,
-  overrides?: Partial<ReconnectPolicy>,
-): ReconnectPolicy {
-  const reconnectOverrides = cfg.web?.reconnect ?? {};
-  const overrideConfig =import { randomUUID } from "node:crypto";
-import type { TEXT2LLMConfig } from "../config/config.js";
-import type { BackoffPolicy } from "../infra/backoff.js";
-import { computeBackoff, sleepWithAbort } from "../infra/backoff.js";
-import { clamp } from "../utils.js";
-
-export type ReconnectPolicy = BackoffPolicy & {
-  maxAttempts: number;
-};
-
-export const DEFAULT_HEARTBEAT_SECONDS = 60;
-export const DEFAULT_RECONNECT_POLICY: ReconnectPolicy = {
-  initialMs: 2_000,
-  maxMs: 30_000,
-  factor: 1.8,
-  jitter: 0.25,
-  maxAttempts: 12,
-};
-
-export function resolveHeartbeatSeconds(cfg: TEXT2LLMConfig, overrideSeconds?: number): number {
-  const candidate = overrideSeconds ?? cfg.web?.heartbeatSeconds;
-  if (typeof candidate === "number" && candidate > 0) {
-    return candidate;
-  }
-  return DEFAULT_HEARTBEAT_SECONDS;
-}
-
 export function resolveReconnectPolicy(
   cfg: TEXT2LLMConfig,
   overrides?: Partial<ReconnectPolicy>,
